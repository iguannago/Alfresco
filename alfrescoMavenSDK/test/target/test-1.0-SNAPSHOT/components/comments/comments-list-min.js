(function(){var a=YAHOO.util.Dom,p=YAHOO.util.Selector;var n=Alfresco.util.encodeHTML,d=Alfresco.util.userProfileLink,c=Alfresco.Share.userAvatar;Alfresco.CommentsList=function(u){Alfresco.CommentsList.superclass.constructor.call(this,"Alfresco.CommentsList",u,["datasource","datatable","paginator","history","animation"]);YAHOO.Bubbling.on("editorInitialized",this.onEditorInitialized,this);YAHOO.Bubbling.on("commentNode",this.onCommentNode,this);this.busy=false;return this};YAHOO.extend(Alfresco.CommentsList,Alfresco.component.Base,{options:{nodeRef:null,siteId:null,activity:null,editorConfig:{}},busy:null,onReady:function k(){var u=document.createElement("div");a.addClass(u,"comments-list");a.addClass(u,"hidden");a.get(this.id+"-body").appendChild(u);this.widgets.editFormWrapper=u;YAHOO.util.Event.addListener(window,"resize",function(){if(this.currentEditedRowId){this.synchronizeElements(this.widgets.editFormWrapper,this.currentEditedRowId+"-form-container")}},this,true);this.setupCommentList();this.setupAddCommentForm()},setupCommentList:function t(){var u=Alfresco.constants.URL_SERVICECONTEXT+"components/node/"+this.options.nodeRef.replace(":/","")+"/comments?reverse=true";this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:u,pagingResolver:function(v,w){return"startIndex="+v+"&pageSize="+w},config:{responseSchema:{resultsList:"items",metaFields:{paginationRecordOffset:"startIndex",paginationRowsPerPage:"pageSize",totalRecords:"total"}}},doBeforeParseData:this.bind(this.handlePermissions)},dataTable:{container:this.id+"-comments-list",columnDefinitions:[{key:"comment",sortable:false,formatter:this.bind(this.renderCellComment)}],config:{MSG_EMPTY:this.msg("message.noComments")}},paginator:{history:false,config:{containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.maxItems}}});this.widgets.alfrescoDataTable.getDataTable().subscribe("beforeRenderEvent",function(){a.removeClass(p.query("hr.hidden"),"hidden")},this,this)},handlePermissions:function(w,u){var v=u.nodePermissions||{};if(v.create){a.removeClass(this.id+"-actions","hidden")}return u},setupAddCommentForm:function j(){a.get(this.id+"-add-form-container").innerHTML=this.formMarkup(this.id+"-add",Alfresco.constants.USERNAME,null);this.widgets.addCommentEditor=this.setupCommentForm(this.id+"-add",this.options.nodeRef,false).editor},setupCommentForm:function e(y,C,u){var D=y+"-form",B=a.get(y+"-form-container"),w;if(u){w="api/comment/node/"+C.replace(":/","")}else{w="api/node/"+C.replace(":/","")+"/comments"}a.get(D).setAttribute("action",Alfresco.constants.PROXY_URI+w);var z=new YAHOO.widget.Button(y+"-submit",{type:"submit"});z.set("label",this.msg(u?"button.save":"button.addComment"));var x=new YAHOO.widget.Button(y+"-cancel");x.subscribe("click",function(){this.restoreEditForm()},this,true);x.set("label",this.msg("button.cancel"));var A=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,y+"-content",this.options.editorConfig);A.addPageUnloadBehaviour(this.msg("message.unsavedChanges.comment"));A.render();var F=(Alfresco.constants.HTML_EDITOR==="YAHOO.widget.SimpleEditor")?"editorKeyUp":"onKeyUp";A.subscribe(F,function(G){if(A.getContent().length<20||z.get("disabled")){A.save();v.updateSubmitElements()}},this,true);var v=new Alfresco.forms.Form(D);v.setShowSubmitStateDynamically(true,false);v.addValidation(y+"-content",Alfresco.forms.validation.mandatory,null);v.setSubmitElements(this.widgets.submitButton);v.setAjaxSubmitMethod(u?Alfresco.util.Ajax.PUT:Alfresco.util.Ajax.POST);v.setAJAXSubmit(true,{successCallback:{fn:function E(G,H){this.restoreEditForm();a.addClass(B,"hidden");this._releaseBusy();this.widgets.alfrescoDataTable.reloadDataTable();z.set("disabled",false);x.set("disabled",false)},scope:this},failureMessage:this.msg("message.savecomment.failure"),failureCallback:{fn:function E(G,H){this._releaseBusy();z.set("disabled",false);x.set("disabled",false)},scope:this}});v.setSubmitAsJSON(true);v.doBeforeFormSubmit={fn:function(G){this._setBusy(this.msg("message.wait"));z.set("disabled",true);x.set("disabled",true);A.save();A.getEditor().undoManager.clear();A.getEditor().nodeChanged()},scope:this};v.doBeforeAjaxRequest={fn:function(G,H){if(this.options.activity){G.dataObj.itemTitle=this.options.activity.itemTitle;G.dataObj.page=this.options.activity.page;G.dataObj.pageParams=YAHOO.lang.JSON.stringify(this.options.activity.pageParams)}return true},scope:this};v.init();return{form:v,editor:A}},restoreEditForm:function(){if(this.currentEditedRowId){var v=a.get(this.currentEditedRowId+"-form-container"),u=a.get(this.currentEditedRowId+"-comment-container");if(v&&u){a.removeClass(v.parentNode,"theme-bg-color-4");a.addClass(v,"hidden");a.removeClass(u,"hidden");a.addClass(this.widgets.editFormWrapper,"hidden")}}a.addClass(this.id+"-add-form-container","hidden");a.removeClass(this.widgets.onAddCommentClick.get("element"),"hidden")},renderCellComment:function b(y,w,A,B){var x=w.getData(),u="",z=this.id+"-"+w.getId(),v=x.permissions;u+='<div id="'+z+'-comment-container" class="comment-details">';u+='   <div class="icon">'+c(x.author.username)+"</div>";u+='   <div class="details">';u+='      <span class="info">';u+=d(x.author.username,x.author.firstName+" "+x.author.lastName,'class="theme-color-1"')+" ";u+=Alfresco.util.relativeTime(Alfresco.util.fromISO8601(x.modifiedOnISO))+"<br/>";u+="      </span>";u+='      <span class="comment-actions">';if(v.edit){u+='       <a href="#" name=".onEditCommentClick" rel="'+w.getId()+'" title="'+this.msg("link.editComment")+'" class="'+this.id+' edit-comment">&nbsp;</a>'}if(v["delete"]){u+='       <a href="#" name=".onConfirmDeleteCommentClick" rel="'+w.getId()+'" title="'+this.msg("link.deleteComment")+'" class="'+this.id+' delete-comment">&nbsp;</a>'}u+="      </span>";u+='      <div class="comment-content">'+(x.content||"")+"</div>";u+="   </div>";u+='   <div class="clear"></div>';u+="</div>";u+='<div id="'+z+'-form-container" class="comment-form hidden">';u+="   &nbsp;<!-- EMPTY SPACE FOR FLOATING COMMENT FORM -->";u+="</div>";y.innerHTML=u},formMarkup:function l(w,v,x){var u="";u+='<div id="'+w+'-actual-form-container" class="comment-form">';u+='   <h2 class="thin dark">'+this.msg(x?"header.edit":"header.add")+"</h2>";u+=c(v);u+='   <form id="'+w+'-form" method="POST" action="">';if(this.options.siteId){u+='      <input type="hidden" name="site" value="'+this.options.siteId+'" />'}u+='      <textarea name="content" id="'+w+'-content" style="width: 100%;">'+(x||"")+"</textarea>";u+='      <div class="buttons">';u+='         <input type="submit" id="'+w+'-submit" value=""/>';u+='         <input type="reset"  id="'+w+'-cancel" value="" />';u+="      </div>";u+="   </form>";u+='   <div class="clear"></div>';u+="</div>";return u},onEditorInitialized:function h(){if(window.location.hash=="#comment"){this.onAddCommentClick();a.get(this.id+"-add-comment").scrollIntoView()}},onCommentNode:function r(v,u){if(this.options.nodeRef==u[1]){this.onAddCommentClick();a.get(this.id+"-add-comment").scrollIntoView()}},onAddCommentClick:function m(){this.restoreEditForm();a.addClass(this.widgets.onAddCommentClick.get("element"),"hidden");this.widgets.addCommentEditor.setContent("");a.removeClass(this.id+"-add-form-container","hidden");this.widgets.addCommentEditor.focus()},onEditCommentClick:function o(u){this.restoreEditForm();var y=this.widgets.alfrescoDataTable.getData(u),w=this.id+"-"+u,v=a.get(w+"-form-container"),x=a.get(w+"-comment-container");this.currentEditedRowId=w;a.addClass(v.parentNode,"theme-bg-color-4");a.addClass(x,"hidden");a.removeClass(v,"hidden");this.widgets.editFormWrapper.innerHTML=this.formMarkup(w,y.author.username,y.content);this.setupCommentForm(w,y.nodeRef,true);this.synchronizeElements(this.widgets.editFormWrapper,v);a.removeClass(this.widgets.editFormWrapper,"hidden")},synchronizeElements:function s(x,u){var w=new YAHOO.util.Element(u),v=new YAHOO.util.Element(x);var y=YAHOO.util.Dom.getRegion(w.get("id"));v.setStyle("position","absolute");v.setStyle("left",y.left+"px");v.setStyle("top",y.top+"px");v.setStyle("width",y.width+"px");v.setStyle("height",y.height+"px")},onConfirmDeleteCommentClick:function q(w){var y=this.widgets.alfrescoDataTable.getData(w),x=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete"),buttons:[{text:this.msg("button.delete"),handler:function v(){this.destroy();x.deleteComment.call(x,y)}},{text:this.msg("button.cancel"),handler:function u(){this.destroy()},isDefault:true}]})},deleteComment:function i(A){if(!this._setBusy(this.msg("message.wait"))){return}var z=function x(B,C){this._releaseBusy();this.widgets.alfrescoDataTable.reloadDataTable()};var w=function u(B,C){this._releaseBusy()};var v=Alfresco.constants.PROXY_URI+"api/comment/node/"+A.nodeRef.replace(":/",""),y=false;if(this.options.siteId){v+=y?"&":"?";v+="site="+encodeURIComponent(this.options.siteId);y=true}if(this.options.activity){v+=y?"&":"?";v+="itemTitle="+encodeURIComponent(this.options.activity.itemTitle)+"&";v+="page="+encodeURIComponent(this.options.activity.page)+"&";v+="pageParams="+encodeURIComponent(YAHOO.lang.JSON.stringify(this.options.activity.pageParams));y=true}Alfresco.util.Ajax.jsonDelete({url:v,successMessage:this.msg("message.delete.success"),successCallback:{fn:z,scope:this},failureMessage:this.msg("message.delete.failure"),failureCallback:{fn:w,scope:this}})},_setBusy:function f(u){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:u,spanClass:"wait",displayTime:0});return true},_releaseBusy:function g(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}}})})();