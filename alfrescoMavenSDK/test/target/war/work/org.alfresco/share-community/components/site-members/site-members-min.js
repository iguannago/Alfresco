(function(){var a=YAHOO.util.Dom,r=YAHOO.util.Event,k=YAHOO.util.Element;var l=Alfresco.util.encodeHTML;Alfresco.SiteMembers=function(s){this.name="Alfresco.SiteMembers";this.id=s;this.widgets={};this.listWidgets={};this.buttons=[];this.modules={};this.isCurrentUserSiteAdmin=false;Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container","datasource","datatable","json"],this.onComponentsLoaded,this);YAHOO.Bubbling.on("deactivateAllControls",this.onDeactivateAllControls,this);return this};Alfresco.SiteMembers.prototype={options:{siteId:"",minSearchTermLength:0,maxSearchResults:100,currentUser:"",currentUserRole:"",roles:[],error:null,setFocus:false},widgets:null,listWidgets:null,buttons:null,modules:null,isCurrentUserSiteAdmin:null,isSearching:false,setOptions:function n(s){this.options=YAHOO.lang.merge(this.options,s);return this},setMessages:function p(s){Alfresco.util.addMessages(s,this.name);return this},onComponentsLoaded:function e(){r.onContentReady(this.id,this.onReady,this,true)},onReady:function j(){var w=this;var v=Alfresco.constants.PROXY_URI+"api/sites/"+w.options.siteId+"/memberships?";this.widgets.dataSource=new YAHOO.util.DataSource(v,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items"}});this.widgets.dataSource.doBeforeParseData=function t(C,B){var A=B;if(B){var z=[],E,F;for(var y=0,D=B.length;y<D;y++){E=B[y];F=E.authority;F.role=E.role;z.push(F)}z.sort(function(G,x){var I=G.firstName+G.lastName,H=x.firstName+x.lastName;return(I>H)?1:(I<H)?-1:0});A={items:z}}return A};if(w.options.currentUserRole!==undefined&&w.options.currentUserRole==="SiteManager"){this.isCurrentUserSiteAdmin=true}this._setupDataTable();this.widgets.searchButton=Alfresco.util.createYUIButton(this,"button",this.onSearch);this.widgets.invitePeople=Alfresco.util.createYUIButton(this,"invitePeople",null,{type:"link"});var s=a.get(this.id+"-term"),u=new YAHOO.util.KeyListener(s,{keys:13},{fn:function(){w.onSearch()},scope:this,correctScope:true},"keydown");u.enable();if(this.options.error){u.disable();this.widgets.dataTable.set("MSG_ERROR",this.options.error);this.widgets.dataTable.showTableMessage(this.options.error,YAHOO.widget.DataTable.CLASS_ERROR);YAHOO.Bubbling.fire("deactivateAllControls")}if(this.options.setFocus){s.focus()}if(window.location.hash=="#showall"){this.onSearch()}a.setStyle(this.id+"-body","visibility","visible")},_setupDataTable:function o(){var A=this;var u=function s(H,E,I,J){a.setStyle(H.parentNode,"width",I.width+"px");var G=E.getData("userName"),F=Alfresco.constants.URL_PAGECONTEXT+"user/"+G+"/profile",D=Alfresco.constants.URL_RESCONTEXT+"components/images/no-user-photo-64.png";if(E.getData("avatar")!==undefined){D=Alfresco.constants.PROXY_URI+E.getData("avatar")+"?c=queue&ph=true"}H.innerHTML='<a href="'+F+'"><img src="'+D+'" alt="avatar" /></a>'};var t=function z(N,Q,K,H){var M=Q.getData("userName"),G=M,O=Q.getData("firstName"),P=Q.getData("lastName"),D=Q.getData("userStatus"),I=Q.getData("userStatusTime");if((O!==undefined)||(P!==undefined)){G=O?O+" ":"";G+=P?P:""}var F=Alfresco.constants.URL_PAGECONTEXT+"user/"+M+"/profile",L=Q.getData("jobtitle")?Q.getData("jobtitle"):"",E=Q.getData("organization")?Q.getData("organization"):"",J='<h3><a href="'+F+'">'+l(G)+"</a></h3>";if(L.length>0){J+='<div><span class="attr-name">'+A._msg("label.title")+': </span>&nbsp;<span class="attr-value">'+l(L)+"</span></div>"}if(E.length>0){J+='<div><span class="attr-name">'+A._msg("label.company")+':</span>&nbsp;<span class="attr-value">'+l(E)+"</span></div>"}if(typeof D!="undefined"){J+='<div class="user-status">'+l(D)+" <span>("+Alfresco.util.relativeTime(Alfresco.util.fromISO8601(I.iso8601))+")</span></div>"}N.innerHTML=J};var C=function w(L,N,H,E){a.setStyle(L.parentNode,"width",H.width+"px");a.setStyle(L.parentNode,"text-align","right");a.addClass(L,"overflow");var F=N.getData("role");if(A.isCurrentUserSiteAdmin){var K=N.getData("userName");L.innerHTML='<span id="'+A.id+"-roleSelector-"+K+'"></span>';var I=[],G;for(var J=0,D=A.options.roles.length;J<D;J++){G=A.options.roles[J];I.push({text:A._msg("role."+G),value:G,onclick:{fn:A.onRoleSelect,obj:{user:K,currentRole:F,newRole:G,recordId:N.getId()},scope:A}})}var M=new YAHOO.widget.Button({container:A.id+"-roleSelector-"+K,type:"menu",label:A._msg("role."+F),menu:I});A.listWidgets[K]={roleSelector:M};A.buttons[K+"-roleSelector"]={roleSelector:M}}else{L.innerHTML="<div>"+A._msg("role."+F)+"</div>"}};var y=function v(G,E,H,I){a.setStyle(G.parentNode,"width",H.width+"px");if(A.isCurrentUserSiteAdmin){var F=E.getData("userName");G.innerHTML='<span id="'+A.id+"-button-"+F+'"></span>';var D=new YAHOO.widget.Button({container:A.id+"-button-"+F,label:A._msg("site-members.uninvite"),onclick:{fn:A.doRemove,obj:F,scope:A}});A.buttons[F+"-button"]={button:D}}else{G.innerHTML="<div></div>"}};var x=[{key:"userName",label:"User Name",sortable:false,formatter:u,width:64},{key:"bio",label:"Bio",sortable:false,formatter:t},{key:"role",label:"Select Role",formatter:C,width:140},{key:"uninvite",label:"Uninvite",formatter:y,width:80}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-members",x,this.widgets.dataSource,{renderLoopSize:32,initialLoad:false,MSG_EMPTY:'<span style="white-space: nowrap;">'+this._msg("site-members.enter-search-term")+"</span>"});this.widgets.dataTable.doBeforeLoadData=function B(E,F,H){if(F.error){try{var D=YAHOO.lang.JSON.parse(F.responseText);A.widgets.dataTable.set("MSG_ERROR",D.message)}catch(G){A._setDefaultDataTableErrors(A.widgets.dataTable)}}else{if(F.results){if(F.results.length===0){A.widgets.dataTable.set("MSG_EMPTY",'<span style="white-space: nowrap;">'+A._msg("message.empty")+"</span>")}A.renderLoopSize=Alfresco.util.RENDERLOOPSIZE}}return true}},onSearch:function f(){var s=YAHOO.lang.trim(a.get(this.id+"-term").value);if(s.replace(/\*/g,"").length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this._msg("message.minimum-length",this.options.minSearchTermLength)});return}this._performSearch(s)},doRemove:function g(v,s){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this._msg("message.removing"),spanClass:"wait",displayTime:0});var w=function x(A,z){this.widgets.feedbackMessage.hide();Alfresco.util.PopupManager.displayMessage({text:this._msg("site-members.remove-success",z)});var y=this.widgets.dataTable.getRecordIndex(v.target.id);this.widgets.dataTable.deleteRow(y)};var t=function u(y){this.widgets.feedbackMessage.hide()};Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/sites/"+this.options.siteId+"/memberships/"+encodeURIComponent(s),method:"DELETE",successCallback:{fn:w,obj:s,scope:this},failureMessage:this._msg("site-members.remove-failure",s),failureCallback:{fn:t,scope:this}})},onRoleSelect:function d(C,s,B){var z=this.widgets.dataTable.getRecord(B.recordId);var y=z.getData();var x=this.widgets.dataTable.getRecordIndex(z);var u=y.role;var D=B.newRole;var w=B.user;if(D!==u){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this._msg("message.changingrole"),spanClass:"wait",displayTime:0});var E=function v(F,G){this.widgets.feedbackMessage.hide();Alfresco.util.PopupManager.displayMessage({text:this._msg("site-members.change-role-success",G.user,G.role)});var H=this.widgets.dataTable.getRecord(G.recordIndex).getData();H.role=B.newRole;this.widgets.dataTable.updateRow(G.recordIndex,H)};var t=function A(F){this.widgets.feedbackMessage.hide()};Alfresco.util.Ajax.jsonPut({url:Alfresco.constants.PROXY_URI+"api/sites/"+this.options.siteId+"/memberships",dataObj:{role:D,person:{userName:w}},successCallback:{fn:E,obj:{user:w,role:D,recordIndex:x},scope:this},failureMessage:this._msg("site-members.change-role-failure",w),failureCallback:{fn:t,scope:this}})}},onDeactivateAllControls:function h(u,t){var s,v,w=Alfresco.util.disableYUIButton;for(s in this.widgets){if(this.widgets.hasOwnProperty(s)){w(this.widgets[s])}}},_setDefaultDataTableErrors:function i(s){var t=Alfresco.util.message;s.set("MSG_EMPTY",t("message.empty","Alfresco.SiteMembers"));s.set("MSG_ERROR",t("message.error","Alfresco.SiteMembers"))},_performSearch:function b(s){if(!this.isSearching){this.isSearching=true;this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.set("MSG_EMPTY",this._msg("site-members.searching"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());function t(v,w,x){this._enableSearchUI();this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,v,w,x);this._setDefaultDataTableErrors(this.widgets.dataTable)}function u(w,x){this._enableSearchUI();if(x.status==401){window.location.reload()}else{try{var v=YAHOO.lang.JSON.parse(x.responseText);this.widgets.dataTable.set("MSG_ERROR",v.message);this.widgets.dataTable.showTableMessage(v.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(y){this._setDefaultDataTableErrors(this.widgets.dataTable)}}}this.widgets.dataSource.sendRequest(this._buildSearchParams(s),{success:t,failure:u,scope:this});this.widgets.searchButton.set("disabled",true);YAHOO.lang.later(2000,this,function(){if(this.isSearching){if(!this.widgets.feedbackMessage){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.searching",this.name),spanClass:"wait",displayTime:0})}else{if(!this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.show()}}}},[])}},_enableSearchUI:function q(){if(this.widgets.feedbackMessage&&this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.hide()}this.widgets.searchButton.set("disabled",false);this.isSearching=false},_buildSearchParams:function c(s){var t=YAHOO.lang.substitute("size={maxResults}&nf={term}&authorityType=USER",{maxResults:this.options.maxSearchResults,term:encodeURIComponent(s)});return t},_msg:function m(s){return Alfresco.util.message.call(this,s,"Alfresco.SiteMembers",Array.prototype.slice.call(arguments).slice(1))}}})();