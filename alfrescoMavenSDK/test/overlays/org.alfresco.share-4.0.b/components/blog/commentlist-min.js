(function(){var c=YAHOO.util.Dom;Alfresco.CommentList=function(z){Alfresco.CommentList.superclass.constructor.call(this,"Alfresco.CommentList",z,["editor","paginator"]);this.editData={editDiv:null,viewDiv:null,row:-1,data:null,widgets:{}};this.busy=false;YAHOO.Bubbling.on("setCommentedNode",this.onSetCommentedNode,this);YAHOO.Bubbling.on("refreshComments",this.onRefreshComments,this);return this};YAHOO.extend(Alfresco.CommentList,Alfresco.component.Base,{options:{siteId:"",containerId:"",itemNodeRef:null,activityTitle:null,activityPage:null,activityPageParams:null,width:700,height:180,pageSize:10},editData:null,commentsData:null,busy:null,onReady:function g(){var A=this;var C=new YAHOO.widget.Paginator({containers:[this.id+"-paginator"],rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});C.subscribe("changeRequest",this.onPaginatorChange,this,true);C.set("recordOffset",0);C.set("totalRecords",0);C.render();this.widgets.paginator=C;var B=function z(H,G){var D=YAHOO.Bubbling.getOwnerByTagName(G[1].anchor,"div");if(D!==null){var I=D.className;if(typeof A[I]=="function"){var F=c.getAncestorByClassName(D,"comment"),E=parseInt(F.id.substring((A.id+"-comment-view-").length),10);A[I].call(A,E);G[1].stop=true}}return true};YAHOO.Bubbling.addDefaultAction("blogcomment-action",B);Alfresco.util.rollover.registerHandlerFunctions(this.id,this.onCommentElementMouseEntered,this.onCommentElementMouseExited,this)},onPaginatorChange:function b(z){this._loadCommentsList(z.recordOffset)},onSetCommentedNode:function f(A,z){var B=z[1];if((B!==null)&&(B.nodeRef!==null)&&(B.title!==null)&&(B.page!==null)){this.options.itemNodeRef=B.nodeRef;this.options.activityTitle=B.title;this.options.activityPage=B.page;this.options.activityPageParams=B.pageParams;this._loadCommentsList(0)}},onRefreshComments:function t(E,G){if(this.options.itemNodeRef&&this.options.activityTitle){var A=this.widgets.paginator;var B=G[1];var I=0;var H=A.getTotalRecords();var z=this.options.pageSize;if(B.reason=="deleted"){var F=Math.floor((H-1)/z)+(((H-1)%z)>0?1:0);var D=A.getCurrentPage();if(F<D){D=D>1?D-1:1}var C=A.getPageRecords(D);I=C?C[0]:0}if(B.reason=="created"){I=Math.floor(H/z)*z}this._loadCommentsList(I)}},_loadCommentsList:function d(A){var z=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/node/{nodeRef}/comments",{nodeRef:this.options.itemNodeRef.replace(":/","")});Alfresco.util.Ajax.request({url:z,dataObj:{startIndex:A,pageSize:this.options.pageSize},successCallback:{fn:this.loadCommentsSuccess,scope:this},failureMessage:this.msg("message.loadComments.failure")})},loadCommentsSuccess:function a(z){this._hideEditView();var G=z.json.items;var D=c.get(this.id+"-body"),F=c.get(this.id+"-title"),E=c.get(this.id+"-comments");D.setAttribute("style","display:none");if(G.length>0){F.innerHTML=Alfresco.util.message("label.comments",this.name,{"0":G.length,"1":z.json.total})}else{F.innerHTML=Alfresco.util.message("label.noComments",this.name)}var C="",B,A;for(B=0,A=G.length;B<A;B++){C+=this.renderComment(B,G[B])}E.innerHTML=C;D.removeAttribute("style");Alfresco.util.rollover.registerListenersByClassName(this.id,"comment","div");this.commentsData=G;YAHOO.Bubbling.fire("setCanCreateComment",{canCreateComment:z.json.nodePermissions.create});this._updatePaginator(z.json.startIndex,z.json.total)},_updatePaginator:function w(A,z){if(this.widgets&&this.widgets.paginator){this.widgets.paginator.set("recordOffset",A);this.widgets.paginator.set("totalRecords",z)}else{YAHOO.lang.later(100,this,this._updatePaginator,[A,z])}},onEditComment:function m(z){this._loadForm(z,this.commentsData[z])},onDeleteComment:function n(C){var B=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete"),buttons:[{text:this.msg("button.delete"),handler:function A(){this.destroy();B._onDeleteCommentConfirm.call(B,C)}},{text:this.msg("button.cancel"),handler:function z(){this.destroy()},isDefault:true}]})},_onDeleteCommentConfirm:function y(A){var z=this.commentsData[A];this._deleteComment(A,z)},_deleteComment:function i(F,D){if(!this._setBusy(this.msg("message.wait"))){return}var E=function C(G,H){this._releaseBusy();YAHOO.Bubbling.fire("refreshComments",{reason:"deleted"})};var B=function z(G,H){this._releaseBusy()};var A=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/comment/node/{nodeRef}/?site={site}&itemTitle={itemTitle}&page={page}&pageParams={pageParams}",{site:this.options.siteId,container:this.options.containerId,nodeRef:D.nodeRef.replace(":/",""),itemTitle:encodeURIComponent(this.options.activityTitle),page:encodeURIComponent(this.options.activityPage),pageParams:encodeURIComponent(YAHOO.lang.JSON.stringify(this.options.activityPageParams))});Alfresco.util.Ajax.request({url:A,method:"DELETE",responseContentType:"application/json",successMessage:this.msg("message.delete.success"),successCallback:{fn:E,scope:this},failureMessage:this.msg("message.delete.failure"),failureCallback:{fn:B,scope:this}})},_loadForm:function j(B,z){var A=this.id+"-edit-comment-"+B;Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/blog/comments/edit-comment",dataObj:{htmlid:A},successCallback:{fn:this.onFormLoaded,scope:this,obj:{formId:A,row:B,data:z}},failureMessage:this.msg("message.loadeditform.failure"),execScripts:true})},onFormLoaded:function u(A,E){var G=E.row,D=E.data,F=E.formId;this._hideEditView();var z=c.get(this.id+"-comment-view-"+G),B=c.get(this.id+"-comment-edit-"+G);B.innerHTML=A.serverResponse.responseText;var C=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/comment/node/{nodeRef}",{nodeRef:D.nodeRef.replace(":/","")});c.get(F+"-form").setAttribute("action",C);c.get(F+"-site").setAttribute("value",this.options.siteId);c.get(F+"-container").setAttribute("value",this.options.containerId);c.get(F+"-itemTitle").setAttribute("value",this.options.activityTitle);c.get(F+"-page").setAttribute("value",this.options.activityPage);c.get(F+"-pageParams").setAttribute("value",YAHOO.lang.JSON.stringify(this.options.activityPageParams));c.get(F+"-content").value=D.content;c.addClass(z,"hidden");c.removeClass(B,"hidden");this.editData={viewDiv:z,editDiv:B,row:G,widgets:{},formId:F};this._registerEditCommentForm(G,D,F)},_registerEditCommentForm:function h(D,B,C){this.editData.widgets.okButton=new YAHOO.widget.Button(C+"-submit",{type:"submit"});this.editData.widgets.cancelButton=new YAHOO.widget.Button(C+"-cancel");this.editData.widgets.cancelButton.subscribe("click",this.onEditFormCancelButtonClick,this,true);this.editData.widgets.editor=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,C+"-content",this.options.editorConfig);this.editData.widgets.editor.addPageUnloadBehaviour(this.msg("message.unsavedChanges.comment"));this.editData.widgets.editor.render();var A=(Alfresco.constants.HTML_EDITOR==="YAHOO.widget.SimpleEditor")?"editorKeyUp":"onKeyUp";this.editData.widgets.editor.subscribe(A,function(E){if(this.editData.widgets.editor.getContent().length<20||this.editData.widgets.okButton.get("disabled")){this.editData.widgets.editor.save();this.editData.widgets.commentForm.updateSubmitElements()}},this,true);var z=new Alfresco.forms.Form(C+"-form");this.editData.widgets.commentForm=z;z.setShowSubmitStateDynamically(true,false);z.addValidation(C+"-content",Alfresco.forms.validation.mandatory,null);z.setSubmitElements(this.editData.widgets.okButton);z.setAjaxSubmitMethod(Alfresco.util.Ajax.PUT);z.setAJAXSubmit(true,{successMessage:this.msg("message.savecomment.success"),successCallback:{fn:this.onEditFormSubmitSuccess,scope:this},failureMessage:this.msg("message.savecomment.failure"),failureCallback:{fn:this.onEditFormSubmitFailure,scope:this}});z.setSubmitAsJSON(true);z.doBeforeFormSubmit={fn:function(E,F){this.editData.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.savecomment",this.name),spanClass:"wait",displayTime:0});this.editData.widgets.okButton.set("disabled",true);this.editData.widgets.cancelButton.set("disabled",true);this.editData.widgets.editor.disable();this.editData.widgets.editor.save()},scope:this};z.init()},onEditFormSubmitSuccess:function o(z,A){this.editData.widgets.feedbackMessage.destroy();this.commentsData[this.editData.row]=z.json.item;var B=this.renderCommentView(this.editData.row,z.json.item);this.editData.viewDiv.innerHTML=B;this._hideEditView()},onEditFormSubmitFailure:function l(z,A){this.editData.widgets.feedbackMessage.destroy();this.editData.widgets.okButton.set("disabled",false);this.editData.widgets.cancelButton.set("disabled",false);this.editData.widgets.editor.disable()},onEditFormCancelButtonClick:function e(A,z){this._hideEditView()},renderComment:function q(A,C){var B="";B+='<div id="'+this.id+"-comment-edit-"+A+'" class="hidden"></div>';var z=A%2===0?"even":"odd";B+='<div class="comment '+z+'" id="'+this.id+"-comment-view-"+A+'">';B+=this.renderCommentView(A,C);B+="</div>";return B},renderCommentView:function s(z,B){var A="";A+='<div class="nodeEdit">';if(B.permissions.edit){A+='<div class="onEditComment"><a href="#" class="blogcomment-action">'+this.msg("action.edit")+"</a></div>"}if(B.permissions["delete"]){A+='<div class="onDeleteComment"><a href="#" class="blogcomment-action">'+this.msg("action.delete")+"</a></div>"}A+="</div>";A+='<div class="authorPicture">'+Alfresco.util.people.generateUserAvatarImg(B.author)+"</div>";A+='<div class="nodeContent"><div class="userLink">'+Alfresco.util.people.generateUserLink(B.author);A+=" "+this.msg("comment.said")+":";if(B.isUpdated){A+='<span class="theme-color-2 nodeStatus"> ('+this.msg("comment.updated")+")</span>"}A+="</div>";A+='<div class="content yuieditor">'+B.content+"</div>";A+="</div>";A+='<div class="commentFooter">';A+='<span class="nodeFooterBlock">';A+='<span class="nodeAttrLabel">'+this.msg("comment.postedOn")+": ";A+=Alfresco.util.formatDate(B.createdOn);A+="</span></span></div>";return A},onCommentElementMouseEntered:function x(B,A){var E=A[1].target.id;var z=E.substring((this.id+"-comment-view-").length);var C=this.commentsData[z].permissions;if(!(C.edit||C["delete"])){return}var D=A[1].target;c.addClass(D,"over")},onCommentElementMouseExited:function v(A,z){var B=z[1].target;c.removeClass(B,"over")},_hideEditView:function k(){if(this.editData.editDiv!==null){c.addClass(this.editData.editDiv,"hidden");this.editData.editDiv.innerHTML="";this.editData.editDiv=null}if(this.editData.viewDiv!==null){c.removeClass(this.editData.viewDiv,"hidden");this.editData.viewDiv=null}},_setBusy:function p(z){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:z,spanClass:"wait",displayTime:0});return true},_releaseBusy:function r(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}}})})();