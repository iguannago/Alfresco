(function(){var g=YAHOO.util.Dom,p=YAHOO.util.Event;var f=Alfresco.util.encodeHTML,i=Alfresco.util.userProfileLink;Alfresco.PeopleFinder=function(r){Alfresco.PeopleFinder.superclass.constructor.call(this,"Alfresco.PeopleFinder",r,["button","container","datasource","datatable","json"]);this.userSelectButtons={};this.searchTerm="";this.singleSelectedUser="";this.selectedUsers={};this.notAllowed={};this.following={};YAHOO.Bubbling.on("personSelected",this.onPersonSelected,this);YAHOO.Bubbling.on("personDeselected",this.onPersonDeselected,this);return this};YAHOO.lang.augmentObject(Alfresco.PeopleFinder,{VIEW_MODE_DEFAULT:"",VIEW_MODE_COMPACT:"COMPACT",VIEW_MODE_FULLPAGE:"FULLPAGE"});YAHOO.lang.extend(Alfresco.PeopleFinder,Alfresco.component.Base,{options:{siteId:"",viewMode:Alfresco.PeopleFinder.VIEW_MODE_DEFAULT,singleSelectMode:false,showSelf:true,minSearchTermLength:1,maxSearchResults:100,setFocus:false,addButtonLabel:null,addButtonSuffix:"",dataWebScript:"",userId:""},userSelectButtons:null,searchTerm:null,singleSelectedUser:null,selectedUsers:null,notAllowed:null,isSearching:false,following:null,onReady:function c(){var s=this;if(this.options.viewMode==Alfresco.PeopleFinder.VIEW_MODE_COMPACT){g.addClass(this.id+"-body","compact");g.removeClass(this.id+"-results","hidden")}else{if(this.options.viewMode==Alfresco.PeopleFinder.VIEW_MODE_FULLPAGE){g.setStyle(this.id+"-results","height","auto");g.removeClass(this.id+"-help","hidden");Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"api/subscriptions/"+encodeURIComponent(this.options.userId)+"/following",successCallback:{fn:function(w){if(w.json.people){var z={};var y=w.json.people;for(var x=0;x<y.length;x++){z[y[x].userName]=true}s.following=z}},scope:this}})}else{g.setStyle(this.id+"-results","height","300px");g.removeClass(this.id+"-results","hidden")}}this.widgets.searchButton=Alfresco.util.createYUIButton(this,"search-button",this.onSearchClick);var v=Alfresco.constants.PROXY_URI+YAHOO.lang.substitute(this.options.dataWebScript,this.options);v+=(v.indexOf("?")<0)?"?":"&";this.widgets.dataSource=new YAHOO.util.DataSource(v,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"people"}});this.widgets.dataSource.doBeforeParseData=function u(B,y){var x=y;if(y){var w=y.people,z,A;if(w.length>s.options.maxSearchResults){w=w.slice(0,s.options.maxSearchResults-1)}if(!s.options.showSelf){for(z=0,A=w.length;z<A;z++){if(w[z].userName==Alfresco.constants.USERNAME){w.splice(z,1);break}}}w.sort(function(F,E){var D=F.firstName+F.lastName,C=E.firstName+E.lastName;return(D>C)?1:(D<C)?-1:0});s.notAllowed={};if(y.notAllowed){s.notAllowed=Alfresco.util.arrayToObject(y.notAllowed)}x={people:w}}return x};this._setupDataTable();var t=g.get(this.id+"-search-text");var r=new YAHOO.util.KeyListener(t,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function(w,x,y){s.onSearchClick();p.stopEvent(x[1]);return false},scope:this,correctScope:true},YAHOO.env.ua.ie>0?YAHOO.util.KeyListener.KEYDOWN:"keypress");r.enable();if(this.options.setFocus){t.focus()}},_setupDataTable:function d(){var x=this;var t=function w(C,B,D,E){g.setStyle(C.parentNode,"width",D.width+"px");var A=Alfresco.constants.URL_RESCONTEXT+"components/images/no-user-photo-64.png";if(B.getData("avatar")!==undefined){A=Alfresco.constants.PROXY_URI+B.getData("avatar")+"?c=queue&ph=true"}C.innerHTML='<img class="avatar" src="'+A+'" alt="avatar" />'};var s=function y(J,M,G,D){var I=M.getData("userName"),C=I,K=M.getData("firstName"),L=M.getData("lastName"),A=M.getData("userStatus"),E=M.getData("userStatusTime");if((K!==undefined)||(L!==undefined)){C=K?K+" ":"";C+=L?L:""}var H=M.getData("jobtitle")||"",B=M.getData("organization")||"";var F='<h3 class="itemname">'+i(I,C,'class="theme-color-1" tabindex="0"')+' <span class="lighter">('+f(I)+")</span></h3>";if(H.length!==0){if(x.options.viewMode==Alfresco.PeopleFinder.VIEW_MODE_COMPACT){F+='<div class="detail">'+f(H)+"</div>"}else{F+='<div class="detail"><span>'+x.msg("label.title")+":</span> "+f(H)+"</div>"}}if(B.length!==0){if(x.options.viewMode==Alfresco.PeopleFinder.VIEW_MODE_COMPACT){F+='<div class="detail">&nbsp;('+f(B)+")</div>"}else{F+='<div class="detail"><span>'+x.msg("label.company")+":</span> "+f(B)+"</div>"}}if(A!==null&&x.options.viewMode!==Alfresco.PeopleFinder.VIEW_MODE_COMPACT){F+='<div class="user-status">'+f(A)+" <span>("+Alfresco.util.relativeTime(Alfresco.util.fromISO8601(E.iso8601))+")</span></div>"}J.innerHTML=F};var r=function u(E,C,F,H){g.setStyle(E.parentNode,"width",F.width+"px");g.setStyle(E.parentNode,"text-align","right");var D=C.getData("userName"),G='<span id="'+x.id+"-action-"+D+'"></span>';E.innerHTML=G;if(x.options.viewMode!==Alfresco.PeopleFinder.VIEW_MODE_FULLPAGE){var A=new YAHOO.widget.Button({type:"button",label:(x.options.addButtonLabel?x.options.addButtonLabel:x.msg("button.add"))+" "+x.options.addButtonSuffix,name:x.id+"-selectbutton-"+D,container:x.id+"-action-"+D,tabindex:0,disabled:D in x.notAllowed,onclick:{fn:x.onPersonSelect,obj:C,scope:x}});x.userSelectButtons[D]=A;if((D in x.selectedUsers)||(x.options.singleSelectMode&&x.singleSelectedUser!=="")){x.userSelectButtons[D].set("disabled",true)}}if(x.options.viewMode===Alfresco.PeopleFinder.VIEW_MODE_FULLPAGE&&x.options.userId!==D){var B=x.following[D];var A=new YAHOO.widget.Button({type:"button",label:B?x.msg("button.unfollow"):x.msg("button.follow"),name:x.id+"-followbutton-"+D,container:x.id+"-action-"+D,tabindex:0});A.set("onclick",{fn:B?x.onPersonUnfollow:x.onPersonFollow,obj:{record:C,button:A},scope:x})}};var v=[{key:"avatar",label:"Avatar",sortable:false,formatter:t,width:this.options.viewMode==Alfresco.PeopleFinder.VIEW_MODE_COMPACT?36:70},{key:"person",label:"Description",sortable:false,formatter:s},{key:"actions",label:"Actions",sortable:false,formatter:r,width:80}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",v,this.widgets.dataSource,{renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,MSG_EMPTY:this.msg("message.instructions")});this.widgets.dataTable.doBeforeLoadData=function z(A,B,C){if(B.results){this.renderLoopSize=Alfresco.util.RENDERLOOPSIZE}return true};this.widgets.dataTable.subscribe("rowMouseoverEvent",this.widgets.dataTable.onEventHighlightRow);this.widgets.dataTable.subscribe("rowMouseoutEvent",this.widgets.dataTable.onEventUnhighlightRow)},clearResults:function l(){if(this.widgets.dataTable){var r=this.widgets.dataTable.getRecordSet().getLength();this.widgets.dataTable.deleteRows(0,r)}g.get(this.id+"-search-text").value="";this.singleSelectedUser="";this.selectedUsers={}},onPersonSelect:function h(r,t){var s=t.getData("userName");YAHOO.Bubbling.fire("personSelected",{eventGroup:this,userName:s,firstName:t.getData("firstName"),lastName:t.getData("lastName"),email:t.getData("email")})},onPersonFollow:function o(s,u){var t=u.record.getData("userName");u.button.set("disabled",true);var r=this;Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/subscriptions/"+encodeURIComponent(this.options.userId)+"/follow",method:Alfresco.util.Ajax.POST,dataObj:[t],requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(v){u.button.set("label",r.msg("button.unfollow"));u.button.set("onclick",{fn:r.onPersonUnfollow,obj:{record:u.record,button:u.button},scope:r});r.following[t]=true;u.button.set("disabled",false)},scope:this},failureCallback:{fn:function(w){var v=Alfresco.util.parseJSON(w.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:this._msg("message.failure"),text:v.message});u.button.set("disabled",false)},scope:this}})},onPersonUnfollow:function a(s,u){var t=u.record.getData("userName");u.button.set("disabled",true);var r=this;Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/subscriptions/"+encodeURIComponent(this.options.userId)+"/unfollow",method:Alfresco.util.Ajax.POST,dataObj:[t],requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(v){u.button.set("label",r.msg("button.follow"));u.button.set("onclick",{fn:r.onPersonFollow,obj:{record:u.record,button:u.button},scope:r});r.following[t]=false;u.button.set("disabled",false)},scope:this},failureCallback:{fn:function(w){var v=Alfresco.util.parseJSON(w.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:this._msg("message.failure"),text:v.message});u.button.set("disabled",false)},scope:this}})},onSearchClick:function n(s,t){var r=g.get(this.id+"-search-text").value;if(r.replace(/\*/g,"").length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.minimum-length",this.options.minSearchTermLength)});return}this.userSelectButtons={};this._performSearch(r)},onPersonSelected:function j(t,r){var v=r[1];if(v&&(v.userName!==undefined)){var u=v.userName;this.selectedUsers[u]=true;this.singleSelectedUser=u;if(this.options.singleSelectMode){for(var s in this.userSelectButtons){if(this.userSelectButtons.hasOwnProperty(s)){this.userSelectButtons[s].set("disabled",true)}}}else{if(this.userSelectButtons[u]){this.userSelectButtons[u].set("disabled",true)}}}},onPersonDeselected:function b(t,r){var u=r[1];if(u&&(u.userName!==undefined)){delete this.selectedUsers[u.userName];this.singleSelectedUser="";if(this.options.singleSelectMode){for(var s in this.userSelectButtons){if(this.userSelectButtons.hasOwnProperty(s)){this.userSelectButtons[s].set("disabled",false)}}}else{if(this.userSelectButtons[u.userName]){this.userSelectButtons[u.userName].set("disabled",false)}}}},_setDefaultDataTableErrors:function q(r){var s=Alfresco.util.message;r.set("MSG_EMPTY",s("message.empty","Alfresco.PeopleFinder"));r.set("MSG_ERROR",s("message.error","Alfresco.PeopleFinder"))},_performSearch:function e(r){if(!this.isSearching){this.isSearching=true;this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.set("MSG_EMPTY",this.msg("message.searching"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());var s=function u(w,x,y){if(this.options.viewMode!=Alfresco.PeopleFinder.VIEW_MODE_COMPACT){if(g.hasClass(this.id+"-results","hidden")){g.removeClass(this.id+"-results","hidden");g.addClass(this.id+"-help","hidden")}}this._enableSearchUI();this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,w,x,y)};var t=function v(x,y){this._enableSearchUI();if(y.status==401){window.location.reload()}else{try{var w=YAHOO.lang.JSON.parse(y.responseText);this.widgets.dataTable.set("MSG_ERROR",w.message);this.widgets.dataTable.showTableMessage(w.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(z){this._setDefaultDataTableErrors(this.widgets.dataTable)}}};this.searchTerm=r;this.widgets.dataSource.sendRequest(this._buildSearchParams(r),{success:s,failure:t,scope:this});this.widgets.searchButton.set("disabled",true);YAHOO.lang.later(2000,this,function(){if(this.isSearching){if(!this.widgets.feedbackMessage){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.searching",this.name),spanClass:"wait",displayTime:0})}else{if(!this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.show()}}}},[])}},_enableSearchUI:function m(){if(this.widgets.feedbackMessage&&this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.hide()}this.widgets.searchButton.set("disabled",false);this.isSearching=false},_buildSearchParams:function k(r){return"filter="+encodeURIComponent(r)+"&maxResults="+this.options.maxSearchResults}})})();