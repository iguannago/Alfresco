(function(){var b=YAHOO.util.Dom,t=YAHOO.util.Event,l=YAHOO.util.Element;var k=function(){};Alfresco.WikiToolbar=function(u){this.name="Alfresco.WikiToolbar";this.id=u;Alfresco.util.YUILoaderHelper.require(["button","container","connection"],this.onComponentsLoaded,this);this.widgets={};this.popups={};YAHOO.Bubbling.on("userAccess",this.onUserAccess,this);YAHOO.Bubbling.on("deactivateAllControls",this.onDeactivateAllControls,this);return this};Alfresco.WikiToolbar.prototype={options:{siteId:null,title:null,showBackLink:false},widgets:null,popups:null,setOptions:function q(u){this.options=YAHOO.lang.merge(this.options,u);return this},setMessages:function d(u){Alfresco.util.addMessages(u,this.name);k=this._msg;return this},onComponentsLoaded:function g(){t.onContentReady(this.id,this.onReady,this,true)},onReady:function o(){this.widgets.newPageButton=Alfresco.util.createYUIButton(this,"create-button",this.onNewPageClick,{disabled:true,value:"create"});this.widgets.deletePageButton=Alfresco.util.createYUIButton(this,"delete-button",this.onDeleteClick,{disabled:true,value:"delete"});this.widgets.renamePageButton=Alfresco.util.createYUIButton(this,"rename-button",this.onRenameClick,{disabled:true,value:"edit"});this.widgets.rssFeedButton=Alfresco.util.createYUIButton(this,"rssFeed-button",null,{type:"link"});this.popups.deleteDialog=Alfresco.util.createYUIPanel("deleteDialog",{width:"20em",text:'<div class="yui-u"><br />'+this._msg("panel.confirm.delete-msg")+"<br /><br /></div>",buttons:[{text:this._msg("button.delete"),handler:{fn:this.onConfirm,scope:this}},{text:this._msg("button.cancel"),handler:{fn:this.onCancel,scope:this},isDefault:true}]},{type:YAHOO.widget.SimpleDialog});this.popups.deleteDialog.setHeader(this._msg("panel.confirm.header"));var v=b.get(this.id+"-renamepanel"),y=v.cloneNode(true);v.parentNode.removeChild(v);this.popups.renamePanel=Alfresco.util.createYUIPanel(y,{width:"320px"});var x=Alfresco.util.createYUIButton(this,"rename-save-button",null,{type:"submit"});var u=new Alfresco.forms.Form(this.id+"-renamePageForm");u.addValidation(this.id+"-renameTo",Alfresco.forms.validation.mandatory,null,"blur");u.addValidation(this.id+"-renameTo",Alfresco.forms.validation.nodeName,null,"keyup");u.addValidation(this.id+"-renameTo",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");u.setShowSubmitStateDynamically(true);u.setSubmitElements(x);u.ajaxSubmitMethod=Alfresco.util.Ajax.POST;u.doBeforeAjaxRequest={fn:function w(z,B){var A=z.dataObj.name;z.failureCallback.obj=A;z.dataObj.name=A.replace(/\s+/g,"_");return true},scope:this};u.setAJAXSubmit(true,{successCallback:{fn:this.onPageRenamed,scope:this},failureCallback:{fn:this.onPageRenameFailed,scope:this}});u.setSubmitAsJSON(true);u.applyTabFix();u.init();YAHOO.Bubbling.on("deletePage",this.onDeletePage,this)},onUserAccess:function a(y,w){var B=w[1];if((B!==null)&&(B.userAccess!==null)){var A,u,v;for(v in this.widgets){if(this.widgets.hasOwnProperty(v)){A=this.widgets[v];if(A.get("srcelement").className!="no-access-check"){A.set("disabled",false);if(typeof A.get("value")=="string"){u=A.get("value").split(",");for(var x=0,z=u.length;x<z;x++){if(!B.userAccess[u[x]]){A.set("disabled",true);break}}}}}}}},onDeactivateAllControls:function n(w,v){var u,x,y=Alfresco.util.disableYUIButton;for(u in this.widgets){if(this.widgets.hasOwnProperty(u)){y(this.widgets[u])}}},onNewPageClick:function e(v){var u=Alfresco.constants.URL_PAGECONTEXT+"site/"+this.options.siteId+"/wiki-create";if(!this.options.showBackLink){u+="?listViewLinkBack=true"}window.location.href=u},onDeletePage:function j(v,u){var w=u[1].title;if(w){this.options.title=w;this.popups.deleteDialog.show()}},onConfirm:function f(u){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:Alfresco.constants.PROXY_URI+"slingshot/wiki/page/"+this.options.siteId+"/"+encodeURIComponent(this.options.title)+"?page=wiki",successCallback:{fn:this.onPageDeleted,scope:this},failureMessage:this._msg("load.fail")})},onCancel:function m(u){this.popups.deleteDialog.hide()},onPageDeleted:function s(v){var u=Alfresco.constants.URL_PAGECONTEXT+"site/"+this.options.siteId+"/wiki";if(window.location.pathname==u){window.location.reload(true)}else{window.location=u}},onRenameClick:function i(w){this.popups.renamePanel.show();var v=b.get(this.id+"-renameTo");v.value=this.options.title.replace(/_/g," ");var u=b.get(this.id+"-renamePageForm");Alfresco.util.caretFix(u);if(!this.escapeListener){this.escapeListener=new YAHOO.util.KeyListener(document,{keys:YAHOO.util.KeyListener.KEY.ESCAPE},{fn:function x(z,y){Alfresco.util.undoCaretFix(u);this.popups.renamePanel.hide()},scope:this,correctScope:true})}this.escapeListener.enable();v.focus()},onPageRenamed:function c(w){var u=YAHOO.lang.JSON.parse(w.serverResponse.responseText);if(u){if(!YAHOO.lang.isUndefined(u.name)){window.location=Alfresco.constants.URL_PAGECONTEXT+"site/"+this.options.siteId+"/wiki-page?title="+encodeURIComponent(u.name)}else{var v="Rename failed: ";if(!YAHOO.lang.isUndefined(u.error)){v+=u.error}else{v+="Unknown error occurred."}Alfresco.util.PopupManager.displayPrompt({text:v})}}},onPageRenameFailed:function p(w,v){var u=this;if(w.serverResponse.status===409){Alfresco.util.PopupManager.displayPrompt({title:k("rename.failure.title"),text:k("rename.failure.duplicate",v),buttons:[{text:k("button.ok"),handler:function(){this.destroy();b.get(u.id+"-renameTo").focus()},isDefault:true}]})}},onDeleteClick:function h(u){this.popups.deleteDialog.show()},_msg:function r(u){return Alfresco.util.message.call(this,u,"Alfresco.WikiToolbar",Array.prototype.slice.call(arguments).slice(1))}}})();