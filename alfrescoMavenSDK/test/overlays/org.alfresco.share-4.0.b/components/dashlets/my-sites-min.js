(function(){var c=YAHOO.util.Dom,E=YAHOO.util.Event,x=YAHOO.util.Selector;var s=Alfresco.util.encodeHTML,t=Alfresco.util.activateLinks;var q=Alfresco.util.generateDomId(null,"fav-site"),k=Alfresco.util.generateDomId(null,"imap-site"),n=Alfresco.util.generateDomId(null,"like-site"),f=Alfresco.util.generateDomId(null,"del-site");var z="org.alfresco.share.sites",h=z+".dashlet.filter";Alfresco.dashlet.MySites=function o(F){Alfresco.dashlet.MySites.superclass.constructor.call(this,"Alfresco.dashlet.MySites",F,["datasource","datatable","animation"]);this.sites=[];this.createSite=null;this.services.preferences=new Alfresco.service.Preferences();this.services.likes=new Alfresco.service.Ratings(Alfresco.service.Ratings.LIKES);YAHOO.Bubbling.on("siteDeleted",this.onSiteDeleted,this);return this};YAHOO.extend(Alfresco.dashlet.MySites,Alfresco.component.Base,{sites:null,createSite:null,options:{validFilters:{all:true,favSites:true},imapEnabled:false,listSize:100},onReady:function i(){var H=this;this.widgets.type=Alfresco.util.createYUIButton(this,"type",this.onTypeFilterChanged,{type:"menu",menu:"type-menu",lazyloadmenu:false});E.addListener(this.id+"-createSite-button","click",this.onCreateSite,this,true);this.widgets.dataSource=new YAHOO.util.DataSource(this.sites,{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});var K=[{key:"icon",label:"Icon",sortable:false,formatter:this.bind(this.renderCellIcon),width:52},{key:"detail",label:"Description",sortable:false,formatter:this.bind(this.renderCellDetail)},{key:"actions",label:"Actions",sortable:false,formatter:this.bind(this.renderCellActions),width:24}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-sites",K,this.widgets.dataSource,{MSG_EMPTY:this.msg("message.datatable.loading")});this.widgets.dataTable.doBeforeLoadData=function I(L,M,N){if((M.results.length===0)||(M.results.length===1&&M.results[0].shortName==="swsdp")){M.results.unshift({isInfo:true,title:H.msg("empty.title"),description:H.msg("empty.description")+(M.results.length===1?"<p>"+H.msg("empty.description.sample-site")+"</p>":"")})}return true};this.widgets.dataTable._deleteTrEl=function J(O){var M=this,N=this.getTrEl(O);var L=new YAHOO.util.ColorAnim(N,{opacity:{to:0}},0.25);L.onComplete.subscribe(function(){YAHOO.widget.DataTable.prototype._deleteTrEl.call(M,O)});L.animate()};var G=function F(M,L){var N=function O(R,Q){var P=YAHOO.Bubbling.getOwnerByTagName(Q[1].anchor,"div");if(P!==null){L.call(H,Q[1].target.offsetParent,P)}return true};YAHOO.Bubbling.addDefaultAction(M,N)};G(q,this.onFavouriteSite);G(k,this.onImapFavouriteSite);G(n,this.onLikes);G(f,this.onDeleteSite);this.widgets.dataTable.subscribe("rowMouseoverEvent",this.widgets.dataTable.onEventHighlightRow);this.widgets.dataTable.subscribe("rowMouseoutEvent",this.widgets.dataTable.onEventUnhighlightRow);this.loadSites()},onTypeFilterChanged:function r(G,F){var H=F[1];if(H){this.widgets.type.set("label",H.cfg.getProperty("text"));this.widgets.type.value=H.value;this.services.preferences.set(h,H.value,{successCallback:{fn:this.loadSites,scope:this}})}},loadSites:function j(){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites?roles=user&size="+this.options.listSize,successCallback:{fn:this.onSitesLoaded,scope:this}})},onSitesLoaded:function w(F){this.services.preferences.request(z,{successCallback:{fn:this.onPreferencesLoaded,scope:this,obj:F.json}})},onPreferencesLoaded:function a(M,N){var S={},P={},H,L,K,J,I,R=0;if(M.json.org){S=M.json.org.alfresco.share.sites.favourites;P=M.json.org.alfresco.share.sites.imapFavourites}var G=Alfresco.util.findValueByDotNotation(M.json,h,"all");G=this.options.validFilters.hasOwnProperty(G)?G:"all";this.widgets.type.set("label",this.msg("filter."+G));this.widgets.type.value=G;c.removeClass(x.query(".toolbar div",this.id,true),"hidden");for(L=0,K=N.length;L<K;L++){N[L].isSiteManager=N[L].siteRole==="SiteManager";N[L].isFavourite=typeof(S[N[L].shortName])=="undefined"?false:S[N[L].shortName];if(P){N[L].isIMAPFavourite=typeof(P[N[L].shortName])=="undefined"?false:P[N[L].shortName]}}this.sites=[];for(L=0,K=N.length;L<K;L++){var F=YAHOO.lang.merge({},N[L]);if(this.filterAccept(this.widgets.type.value,F)){this.sites[R]=F;R++}}this.sites.sort(function(U,T){var W=U.title?U.title.toLowerCase():U.shortName.toLowerCase(),V=T.title?T.title.toLowerCase():T.shortName.toLowerCase();return(W>V)?1:(W<V)?-1:0});var O=function Q(T,U,V){U.results=this.sites;this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,T,U,V)};this.widgets.dataSource.sendRequest(this.sites,{success:O,scope:this})},filterAccept:function B(G,F){switch(G){case"all":return true;case"favSites":return(F.isFavourite||(this.options.imapEnabled&&F.isIMAPFavourite))}return false},generateFavourite:function e(F){var G="";if(F.getData("isFavourite")){G='<a class="favourite-action '+q+' enabled" title="'+this.msg("favourite.site.remove.tip")+'" tabindex="0"></a>'}else{G='<a class="favourite-action '+q+'" title="'+this.msg("favourite.site.add.tip")+'" tabindex="0">'+this.msg("favourite.site.add.label")+"</a>"}return G},generateIMAPFavourite:function d(F){var G="";if(F.getData("isIMAPFavourite")){G='<a class="favourite-action favourite-imap '+k+' enabled" title="'+this.msg("favourite.imap-site.remove.tip")+'" tabindex="0"></a>'}else{G='<a class="favourite-imap '+k+'" title="'+this.msg("favourite.imap-site.add.tip")+'" tabindex="0">'+this.msg("favourite.imap-site.add.label")+"</a>"}return G},generateLikes:function A(F){var G=F.getData("likes"),H="";G=YAHOO.lang.merge({isLiked:false,totalLikes:0},G||{});if(G.isLiked){H='<a class="like-action '+n+' enabled" title="'+this.msg("like.site.remove.tip")+'" tabindex="0"></a>'}else{H='<a class="like-action '+n+'" title="'+this.msg("like.site.add.tip")+'" tabindex="0">'+this.msg("like.site.add.label")+"</a>"}H+='<span class="likes-count">'+s(G.totalLikes)+"</span>";return H},renderCellIcon:function D(I,H,J,K){c.setStyle(I,"width",J.width+"px");c.setStyle(I.parentNode,"width",J.width+"px");var G=H.getData(),F=G.isInfo?"help-site-bw-32.png":"filetypes/generic-site-32.png";I.innerHTML='<img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/"+F+'" />'},renderCellDetail:function l(I,H,J,L){var F=H.getData(),G='<span class="faded">'+this.msg("details.description.none")+"</span>",K="";if(F.isInfo){K+='<div class="empty"><h3>'+F.title+"</h3>";K+="<span>"+F.description+"</span></div>"}else{if(F.description&&F.description!==""){G=t(s(F.description))}K+='<h3 class="site-title"><a href="'+Alfresco.constants.URL_PAGECONTEXT+"site/"+F.shortName+'/dashboard" class="theme-color-1">'+s(F.title)+"</a></h3>";K+='<div class="detail"><span>'+G+"</span></div>";K+='<div class="detail detail-social">';K+='<span class="item item-social">'+this.generateFavourite(H)+"</span>";if(this.options.imapEnabled){K+='<span class="item item-social item-separator">'+this.generateIMAPFavourite(H)+"</span>"}K+="</div>"}I.innerHTML=K},renderCellActions:function v(G,F,H,J){c.setStyle(G,"width",H.width+"px");c.setStyle(G.parentNode,"width",H.width+"px");var I="";if(F.getData("isSiteManager")){I+='<a class="delete-site '+f+'" title="'+this.msg("link.deleteSite")+'">&nbsp;</a>'}G.innerHTML=I},onDeleteSite:function y(G){var F=this.widgets.dataTable.getRecord(G);Alfresco.module.getDeleteSiteInstance().show({site:F.getData()})},onSiteDeleted:function b(I,H){var G=H[1].site,J=G.shortName;var F=this._findRecordByParameter(J,"shortName");if(F!==null){this.widgets.dataTable.deleteRow(F)}},onFavouriteSite:function u(L){var F=this.widgets.dataTable.getRecord(L),I=F.getData(),J=I.shortName;I.isFavourite=!I.isFavourite;this.widgets.dataTable.updateRow(F,I);var H={failureCallback:{fn:function G(O,P){var M=P.record,N=M.getData();N.isFavourite=!N.isFavourite;this.widgets.dataTable.updateRow(M,N);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.save.failure")})},scope:this,obj:{record:F}},successCallback:{fn:function K(O,P){var M=P.record,N=M.getData();YAHOO.Bubbling.fire(N.isFavourite?"favouriteSiteAdded":"favouriteSiteRemoved",N)},scope:this,obj:{record:F}}};this.services.preferences.set(Alfresco.service.Preferences.FAVOURITE_SITES+"."+J,I.isFavourite,H)},onImapFavouriteSite:function m(K){var F=this.widgets.dataTable.getRecord(K),I=F.getData(),J=I.shortName;I.isIMAPFavourite=!I.isIMAPFavourite;this.widgets.dataTable.updateRow(F,I);var H={failureCallback:{fn:function G(N,O){var L=O.record,M=L.getData();M.isIMAPFavourite=!M.isIMAPFavourite;this.widgets.dataTable.updateRow(L,M);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.save.failure")})},scope:this,obj:{record:F}}};this.services.preferences.set(Alfresco.service.Preferences.IMAP_FAVOURITE_SITES+"."+J,I.isIMAPFavourite,H)},onLikes:function g(M){var F=this.widgets.dataTable.getRecord(M),I=F.getData(),K=new Alfresco.util.NodeRef(I.nodeRef),G=I.likes;G.isLiked=!G.isLiked;G.totalLikes+=(G.isLiked?1:-1);var H={successCallback:{fn:function L(R,Q){var S=R.json.data;if(S){var N=this._findRecordByParameter(Q,"nodeRef"),P=N.getData(),O=P.likes;O.totalLikes=S.ratingsCount;this.widgets.dataTable.updateRow(N,P)}},scope:this,obj:K.toString()},failureCallback:{fn:function J(R,Q){var N=this._findRecordByParameter(Q,"nodeRef"),P=N.getData(),O=P.likes;O.isLiked=!O.isLiked;O.totalLikes+=(O.isLiked?1:-1);this.widgets.dataTable.updateRow(N,P);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.save.failure",P.title)})},scope:this,obj:K.toString()}};if(G.isLiked){this.services.likes.set(K,1,H)}else{this.services.likes.remove(K,H)}this.widgets.dataTable.updateRow(F,I)},onCreateSite:function C(F){Alfresco.module.getCreateSiteInstance().show();E.preventDefault(F)},_findRecordByParameter:function p(J,I){var H=this.widgets.dataTable.getRecordSet();for(var G=0,F=H.getLength();G<F;G++){if(H.getRecord(G).getData(I)===J){return H.getRecord(G)}}return null}})})();