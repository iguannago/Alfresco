(function(){var c=YAHOO.util.Dom;var y=Alfresco.util.encodeHTML,z=Alfresco.util.activateLinks;Alfresco.Links=function(H){Alfresco.Links.superclass.constructor.call(this,"Alfresco.Links",H,["button","container","datasource","datatable","paginator","json"]);this.currentFilter={};this.tagId={id:0,tags:{}};this.busy=false;this.DELETEDCLASS="delete-link";this.EDITEDCLASS="edit-link";YAHOO.Bubbling.on("changeFilter",this.onChangeFilter,this);YAHOO.Bubbling.on("linksListRefresh",this.onLinksListRefresh,this);YAHOO.Bubbling.on("deactivateAllControls",this.onDeactivateAllControls,this)};YAHOO.extend(Alfresco.Links,Alfresco.component.Base,{tagId:null,busy:null,recordOffset:0,totalRecords:0,options:{siteId:"",initialFilter:{},pageSize:10,simpleView:false,permissionDelete:true,permissionUpdate:true,maxContentLength:512,MIN_FILTER_PANEL_WIDTH:150,MAX_FILTER_PANEL_WIDTH:640-((YAHOO.env.ua.ie>0)&&(YAHOO.env.ua.ie<7)?160:0),usePagination:true,MAX_FILTER_PANEL_HEIGHT:200,containerId:""},onReady:function B(){this.activate()},createDataSource:function a(){var H=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/links/site/{site}/{container}",{site:this.options.siteId,container:this.options.containerId});this.widgets.dataSource=new YAHOO.util.DataSource(H,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items",metaFields:{recordOffset:"startIndex",totalRecords:"total",metadata:"metadata"}}});return this},updateToolbar:function s(H){if(H.create==="false"){this.widgets.newLinkBtn.set("disabled",true)}},createDataTable:function q(){var Y=this;var Q=function M(aa,Z,ab,ac){aa.innerHTML='<input class="checkbox-column" type="checkbox" />';aa.firstChild.onclick=function(){var ad=Y.getSelectedLinks().length;Y.widgets.linksMenu.set("disabled",ad===0)}};var V=function O(ak,ao,aj,ac){var ah=ao.getData();var aa=ah.title,ab=ah.url,al=ah.description,an=ah.createdOn,ae=ah.author,am=ah.tags,ag=ah.internal;var Z=Y.generateLinksViewUrl(Y.options.siteId,Y.options.containerId,ah.name);var ai="";if(am.length>0){for(var af=0;af<am.length;af++){ai+=Y._generateTagLink(am[af]);if(af!=(am.length-1)){ai+=", &nbsp;"}}}else{ai=Y.msg("dialog.tags.none")}var ad='<h3 class="link-title"><a href="'+Z+'" class="theme-color-1">'+y(aa)+"</a></h3>";ad+='<div class="detail"><span class="item"><em style="padding-right: 2px; float: left">'+Y.msg("details.url")+':</em> <a style="float: left;" class="theme-color-1"'+(ag?"":' target="_blank" class="external"')+" href="+(ab.indexOf("://")===-1||ab[0]==="/"?"http://":"")+encodeURI(ab)+">"+y(ab).replace(/'/g,"")+"</a></span></div>";if(!Y.options.simpleView){ad+='<div class="detail"><span class="item"><em>'+Y.msg("details.created.on")+":</em> "+Alfresco.util.formatDate(an)+'</span><span class="item"><em>'+Y.msg("details.created.by")+":</em> "+Alfresco.util.people.generateUserLink(ae)+"</span></div>";ad+='<div class="detail"><span class="item"><em>'+Y.msg("details.description")+":</em> "+z(y(al))+"</span></div>";ad+='<div class="detail"><span class="tag-item"><em>'+Y.msg("details.tags")+": </em>"+ai+"</span></div>"}ak.innerHTML=ad};var I=function S(af,ah,ab,Z){var ae=ah.getData("title"),ad=ah.getData("permissions");af.style.visibility="hidden";af.innerHTML="<div class='"+Y.EDITEDCLASS+"'><a><span class='theme-color-1'>"+Y.msg("links.edit")+"</a></span></div><div class='"+Y.DELETEDCLASS+"'><a><span class='theme-color-1'>"+Y.msg("links.delete")+"</a></span></div>";var ac=af.childNodes[0],ag=af.childNodes[1];if(ad.edit){ac.onclick=function aa(){window.location=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links-linkedit?linkId={linkId}",{site:Y.options.siteId,linkId:ah.getData("name")})};ac.onmouseover=function(){c.addClass(this,Y.EDITEDCLASS+"-over")};ac.onmouseout=function(){c.removeClass(this,Y.EDITEDCLASS+"-over")}}else{c.addClass(ac,"hidden")}if(ad["delete"]){ag.onclick=function(){var ai=Y.msg("dialog.confirm.message.delete",ae);var aj=function(){Y.deleteLinks([ah])};Y.showConfirmDialog(ai,aj)};ag.onmouseover=function(){c.addClass(this,Y.DELETEDCLASS+"-over")};ag.onmouseout=function(){c.removeClass(this,Y.DELETEDCLASS+"-over")}}else{c.addClass(ag,"hidden")}c.setStyle(af.parentNode,"border-left","3px solid #fff");if(Y.options.simpleView){c.addClass(af.parentNode,"simple-view")}else{c.removeClass(af.parentNode,"simple-view")}};var U=[{key:"selected",label:"Selected",sortable:false,formatter:Q},{key:"title",label:"Title",sortable:false,formatter:V},{key:"description",label:"Description",formatter:I}];this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator"],rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});var R=function J(aa,Z){Y.updateLinks({page:aa.page})};this.widgets.paginator.subscribe("changeRequest",R);this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-links",U,this.widgets.dataSource,{renderLoopSize:32,initialLoad:false,MSG_EMPTY:'<span class="datatable-msg-empty">'+this.msg("links.empty")+"</span>"});YAHOO.widget.DataTable.CLASS_SELECTED="links-selected-row";this.widgets.dataTable.doBeforeLoadData=function K(aa,ab,ad){if(ab.error){try{var Z=YAHOO.lang.JSON.parse(ab.responseText);Y.widgets.dataTable.set("MSG_ERROR",Z.message)}catch(ac){}}else{if(ab.results&&!Y.options.usePagination){this.renderLoopSize=Alfresco.util.RENDERLOOPSIZE}}return true};this.widgets.dataTable.handleDataReturnPayload=function X(aa,Z,ab){Y.recordOffset=Z.meta.recordOffset;Y.totalRecords=Z.meta.totalRecords;ab=ab||{};ab.recordOffset=Z.meta.recordOffset;ab.totalRecords=Z.meta.totalRecords;return ab};this.widgets.dataTable.doBeforePaginatorChange=function N(Z){return false};this.widgets.dataTable.subscribe("renderEvent",function(){this.widgets.paginator.setState({recordOffset:this.recordOffset,totalRecords:this.totalRecords});this.widgets.paginator.render()},this,true);this.widgets.dataTable.subscribe("tableMsgShowEvent",function(Z){this._elMsgTbody.parentNode.style.width=""});this.widgets.dataTable.set("selectionMode","single");var P=function H(Z){Y.widgets.dataTable.selectRow(Z.target);Z.target.cells[2].childNodes[0].style.visibility="visible";Z.target.cells[2].childNodes[0].style.width="100px";Z.target.cells[2].style.borderLeft="1px solid #999"};var T=function W(Z){Y.widgets.dataTable.unselectRow(Z.target);Z.target.cells[2].childNodes[0].style.visibility="hidden";Z.target.cells[2].style.borderLeft="1px solid #FFF"};this.widgets.dataTable.subscribe("rowMouseoverEvent",P);this.widgets.dataTable.subscribe("rowMouseoutEvent",T);var L=YAHOO.lang.merge({filterId:"all",filterOwner:"Alfresco.LinkFilter",filterData:null},this.options.initialFilter);YAHOO.Bubbling.fire("changeFilter",L)},generateLinksViewUrl:function x(J,H,K){var I=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links-view?linkId={linkId}&listViewLinkBack=true",{site:J,container:H,linkId:K});return I},onChangeFilter:function F(I,H){var J=H[1];if((J!==null)&&(J.filterId!==null)){this.currentFilter={filterId:J.filterId,filterOwner:J.filterOwner,filterData:J.filterData};this.updateLinks({page:1});YAHOO.Bubbling.fire("filterChanged",this.currentFilter)}},onLinksListRefresh:function p(I,H){this.updateLinks()},updateLinks:function b(J){function H(K,M,N){this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,K,M,N);this.updateListTitle();this.widgets.linksMenu.set("disabled",this.getSelectedLinks().length===0);var L=M.meta.metadata.linkPermissions;this.options.permissionDelete=L["delete"];this.options.permissionUpdate=L.edit;this.updateToolbar(L)}function I(L,M){if(M.status==401){window.location.reload(true)}else{try{var K=YAHOO.lang.JSON.parse(M.responseText);this.widgets.dataTable.set("MSG_ERROR",K.message);this.widgets.dataTable.showTableMessage(K.message,YAHOO.widget.DataTable.CLASS_ERROR);if(M.status==404){YAHOO.Bubbling.fire("deactivateAllControls")}}catch(N){}}}this.widgets.dataSource.sendRequest(this._buildLinksParams(J||{}),{success:H,failure:I,scope:this})},updateListTitle:function m(){var J=c.get(this.id+"-listTitle");var L=this.msg("title.generic");var I=this.currentFilter.filterOwner;var H=this.currentFilter.filterId;var K=this.currentFilter.filterData;if(I=="Alfresco.LinkFilter"){switch(H){case"all":L=this.msg("title.all");break;case"user":L=this.msg("title.user");break;case"recent":L=this.msg("title.recent");break}}else{if(I=="Alfresco.TagFilter"){L=this.msg("title.bytag",y(K))}}J.innerHTML=L},onDeactivateAllControls:function o(J,I){var H,K=Alfresco.util.disableYUIButton;for(H in this.widgets){if(this.widgets.hasOwnProperty(H)){K(this.widgets[H])}}},activate:function v(){this.attachButtons();c.setStyle(this.id+"-links-header","visibility","visible");c.setStyle(this.id+"-body","visibility","visible");this.createDataSource();this.createDataTable()},onMenuItemClick:function j(L,K,J){var H=this;switch(K[1]._oAnchor.className.split(" ")[0]){case"delete-item":var I=function(){var M=H.getSelectedLinks();H.deleteLinks(M)};this.showConfirmDialog(this.msg("dialog.confirm.message.delete.selected"),I);break;case"deselect-item":this.deselectAll();this.widgets.linksMenu.set("disabled",true);break}},deselectAll:function d(){var I=this.widgets.dataTable.getTbodyEl().rows;for(var H=0;H<I.length;H++){I[H].cells[0].getElementsByTagName("input")[0].checked=false}},attachButtons:function h(){this.widgets.newLinkBtn=Alfresco.util.createYUIButton(this,"create-link-button",this.showCreateLinkDlg,{disabled:false,value:"create"});this.widgets.linksMenu=Alfresco.util.createYUIButton(this,"selected-i-dd",this.onMenuItemClick,{disabled:true,type:"menu",menu:"selectedItems-menu"});this.widgets.changeListViewBtn=Alfresco.util.createYUIButton(this,"viewMode-button",this.changeListView,{});this.linksSelectMenu=Alfresco.util.createYUIButton(this,"select-button",this.onSelectItemClick,{type:"menu",menu:"selecItems-menu"});this.widgets.rssFeed=Alfresco.util.createYUIButton(this,"rss-feed",null,{type:"link"});this.widgets.rssFeed.set("href",this._generateRSSFeedUrl())},onSelectItemClick:function G(K,J,I){var H=YAHOO.env.ua.ie?J[0].srcElement:J[0].target;if(H.tagName.toLocaleLowerCase()!="span"){H=H.getElementsByTagName("span")[0]}switch(H.className.split(" ")[0]){case"links-action-deselect-all":this.deselectAll();this.widgets.linksMenu.set("disabled",true);break;case"links-action-select-all":this.selectAll();this.widgets.linksMenu.set("disabled",!this.getSelectedLinks().length);break;case"links-action-invert-selection":this.invertAll();break}},invertAll:function f(){var K=false;var J=this.widgets.dataTable.getTbodyEl().rows;for(var H=0;H<J.length;H++){var I=J[H].cells[0].getElementsByTagName("input")[0];I.checked=!I.checked;K=I.checked?true:K}this.widgets.linksMenu.set("disabled",!K)},selectAll:function l(){var I=this.widgets.dataTable.getTbodyEl().rows;for(var H=0;H<I.length;H++){I[H].cells[0].getElementsByTagName("input")[0].checked=true}},showCreateLinkDlg:function u(){var H=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links-linkedit",{site:this.options.siteId});window.location=H},changeListView:function n(){var H=this.widgets.dataTable.getRecordSet().getRecords();var K=this.widgets.dataTable.getTbodyEl().rows;var L=this.widgets.dataTable.getColumnSet().getDefinitions();this.options.simpleView=!this.options.simpleView;var I=0;for(var J in H){if(J){L[1].formatter.call(this,K[I].cells[1].firstChild,H[J]);L[2].formatter.call(this,K[I].cells[2].firstChild,H[J]);I++}}this.widgets.changeListViewBtn.set("label",this.msg(this.options.simpleView?"header.detailedList":"header.simpleList"))},deleteLinks:function C(H){if(!this._setBusy(this.msg("message.wait"))){return}var L=[];for(var J in H){if(J){L.push(H[J].getData().name)}}var I=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/links/delete/site/{site}/{container}",{site:this.options.siteId,container:this.options.containerId});var K=function M(N){this._releaseBusy();this.updateLinks();YAHOO.Bubbling.fire("tagRefresh")};Alfresco.util.Ajax.request({url:I,method:"POST",requestContentType:"application/json",successMessage:this.msg("message.delete.success"),successCallback:{fn:K,scope:this},failureMessage:this.msg("message.delete.failure"),failureCallback:{fn:function(N){N.config.failureMessage=YAHOO.lang.JSON.parse(N.serverResponse.responseText).message;this._releaseBusy()},scope:this},dataObj:{items:L}})},createLink:function w(H){this.updateLinks({page:1})},onUpdateLink:function k(H,I){this.updateLinks()},showConfirmDialog:function A(H,I){Alfresco.util.PopupManager.displayPrompt({text:H,title:this.msg("actions.link.delete"),buttons:[{text:this.msg("button.delete"),handler:function(){I();this.destroy()}},{text:this.msg("button.cancel"),handler:function(){this.destroy()},isDefault:true}]})},getSelectedLinks:function t(){var H=[];var K=this.widgets.dataTable.getTbodyEl().rows;for(var I=0;I<K.length;I++){if(K[I].cells[0].getElementsByTagName("input")[0].checked){var J=this.widgets.dataTable.getRecord(I);if(J){H.push(J)}}}return H},_generateTagId:function E(H){var J=0;var I=this.tagId;if(H in I.tags){J=I.tags[H]}else{I.id++;J=I.tags[H]=I.id}return this.id+"-tagId-"+J},_buildLinksParams:function g(N){var I={contentLength:this.options.maxContentLength,fromDate:null,toDate:null,tag:null,page:this.widgets.paginator.getCurrentPage()||"1",pageSize:this.widgets.paginator.getRowsPerPage()};if(typeof N=="object"){I=YAHOO.lang.merge(I,N)}I.startIndex=(I.page-1)*I.pageSize;var P=this.currentFilter.filterOwner;var J=this.currentFilter.filterId;var M=this.currentFilter.filterData;var H="";var L=true;if(P=="Alfresco.LinkFilter"){H="?filter="+J;L=false}else{if(P=="Alfresco.TagFilter"){H="?filter=tag";I.tag=M;L=false}}var O="";for(var K in I){if(I[K]!==null){O+="&"+K+"="+encodeURIComponent(I[K])}}if(O.length>0){O=O.substring(1)}return H+(L?"?":"&")+O},_releaseBusy:function D(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}},_setBusy:function r(H){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:H,spanClass:"wait",displayTime:0});return true},_generateTagLink:function e(H){var I=y(H);return'<span class="tag"><a href="#" class="tag-link" rel="'+I+'" title="'+I+'">'+I+"</a></span>"},_generateRSSFeedUrl:function i(){var H=YAHOO.lang.substitute(Alfresco.constants.URL_CONTEXT+"service/components/links/rss?site={site}",{site:this.options.siteId});return H}})})();