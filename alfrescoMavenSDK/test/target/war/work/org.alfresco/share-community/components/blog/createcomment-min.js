(function(){var e=YAHOO.util.Dom;Alfresco.CreateComment=function(i){Alfresco.CreateComment.superclass.constructor.call(this,"Alfresco.CreateComment",i,["event","json","editor"]);YAHOO.Bubbling.on("setCommentedNode",this.onSetCommentedNode,this);YAHOO.Bubbling.on("setCanCreateComment",this.onSetCanCreateComment,this);return this};YAHOO.extend(Alfresco.CreateComment,Alfresco.component.Base,{options:{siteId:"",containerId:"blog",itemNodeRef:null,activityTitle:null,activityPage:null,activityPageParams:null,width:538,height:250,canCreateComment:false},initialized:false,onSetCommentedNode:function h(j,i){var k=i[1];if((k!==null)&&(k.nodeRef!==null)&&(k.title!==null)&&(k.page!==null)){this.options.itemNodeRef=k.nodeRef;this.options.activityTitle=k.title;this.options.activityPage=k.page;this.options.activityPageParams=k.pageParams;this.initializeCreateCommentForm()}},onSetCanCreateComment:function a(j,i){var k=i[1];if((k!==null)&&(k.canCreateComment!==null)){this.options.canCreateComment=k.canCreateComment;this.initializeCreateCommentForm()}},initializeCreateCommentForm:function b(){if(!this.options.canCreateComment){return}if(this.initialized){return}this.initialized=true;var j=e.get(this.id+"-form");var i=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/node/{nodeRef}/comments",{nodeRef:this.options.itemNodeRef.replace(":/","")});j.setAttribute("action",i);e.get(this.id+"-nodeRef").setAttribute("value",this.options.itemNodeRef);if(this.options.siteId.length>0){e.get(this.id+"-site").setAttribute("value",this.options.siteId);e.get(this.id+"-container").setAttribute("value",this.options.containerId)}e.get(this.id+"-itemTitle").setAttribute("value",this.options.activityTitle);e.get(this.id+"-page").setAttribute("value",this.options.activityPage);e.get(this.id+"-pageParams").setAttribute("value",YAHOO.lang.JSON.stringify(this.options.activityPageParams));this.registerCreateCommentForm()},registerCreateCommentForm:function f(){this.widgets.okButton=Alfresco.util.createYUIButton(this,"submit",null,{type:"submit",disabled:true});this.widgets.editor=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,this.id+"-content",this.options.editorConfig);this.widgets.editor.addPageUnloadBehaviour(this.msg("message.unsavedChanges.comment"));this.widgets.editor.render();this.widgets.editor.save();var i=(Alfresco.constants.HTML_EDITOR==="YAHOO.widget.SimpleEditor")?"editorKeyUp":"onKeyUp";this.widgets.editor.subscribe(i,function(j){if(this.widgets.editor.getContent().length<20||this.widgets.okButton.get("disabled")){this.widgets.editor.save();this.widgets.commentForm.updateSubmitElements()}},this,true);this.widgets.commentForm=new Alfresco.forms.Form(this.id+"-form");this.widgets.commentForm.setShowSubmitStateDynamically(true,false);this.widgets.commentForm.addValidation(this.id+"-content",this._validateTextContent,null);this.widgets.commentForm.setSubmitElements(this.widgets.okButton);this.widgets.commentForm.setAJAXSubmit(true,{successMessage:this.msg("message.createcomment.success"),successCallback:{fn:this.onCreateFormSubmitSuccess,scope:this},failureMessage:this.msg("message.createcomment.failure"),failureCallback:{fn:function(){this.enableInputs()},scope:this}});this.widgets.commentForm.setSubmitAsJSON(true);this.widgets.commentForm.doBeforeFormSubmit={fn:function(j,k){this.widgets.editor.save();this.widgets.editor.disable();this.widgets.okButton.set("disabled",true);this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.creating",this.name),spanClass:"wait",displayTime:0})},scope:this};this.widgets.commentForm.init();e.removeClass(this.id+"-form-container","hidden")},_validateTextContent:function d(o,j,m,l,i,k){var n=/<\S[^><]*>/g;return YAHOO.lang.trim(o.value.replace(n,"")).length>0},onCreateFormSubmitSuccess:function c(i,j){this.widgets.editor.clear();YAHOO.Bubbling.fire("refreshComments",{reason:"created"});this.enableInputs()},enableInputs:function g(){this.widgets.feedbackMessage.destroy();this.widgets.editor.enable()}})})();