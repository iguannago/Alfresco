(function(){var i=YAHOO.util.Dom,a=YAHOO.util.Selector,m=YAHOO.util.Event;var g=Alfresco.util.encodeHTML,h=Alfresco.util.siteURL;Alfresco.RulesHeader=function f(o){Alfresco.RulesHeader.superclass.constructor.call(this,"Alfresco.RulesHeader",o,["button"]);YAHOO.Bubbling.on("folderDetailsAvailable",this.onFolderDetailsAvailable,this);YAHOO.Bubbling.on("folderRulesetDetailsAvailable",this.onFolderRulesetDetailsAvailable,this);return this};YAHOO.extend(Alfresco.RulesHeader,Alfresco.component.Base,{options:{nodeRef:null,siteId:""},isReady:false,folderDetails:null,ruleset:null,isRunning:false,onReady:function j(){this.widgets.actionsEl=i.get(this.id+"-actions");this.widgets.titleEl=i.get(this.id+"-title");this.widgets.newRuleButton=Alfresco.util.createYUIButton(this,"newRule-button",this.onNewRuleButtonClick);this.widgets.copyRuleFromButton=Alfresco.util.createYUIButton(this,"copyRuleFrom-button",this.onCopyRuleFromButtonClick);this.widgets.runRulesMenu=Alfresco.util.createYUIButton(this,"runRules-menu",this.onRunRulesMenuSelect,{type:"menu",menu:"runRules-options"});this.isReady=true;this._displayDetails()},onFolderDetailsAvailable:function e(p,o){this.folderDetails=o[1].folderDetails;this._displayDetails()},onFolderRulesetDetailsAvailable:function l(p,o){this.ruleset=o[1].folderRulesetDetails;this._displayDetails()},onNewRuleButtonClick:function k(p,o){window.location.href=h("rule-edit?nodeRef={nodeRef}",{nodeRef:this.options.nodeRef.toString()})},onCopyRuleFromButtonClick:function d(p,o){if(!this.modules.rulesPicker){this.modules.rulesPicker=new Alfresco.module.RulesPicker(this.id+"-rulesPicker")}this.modules.rulesPicker.setOptions({mode:Alfresco.module.RulesPicker.MODE_COPY_FROM,siteId:this.options.siteId,files:{displayName:this.folderDetails,nodeRef:this.options.nodeRef.toString()}}).showDialog()},onRunRulesMenuSelect:function b(r,q,p){this.widgets.runRulesMenu.set("disabled",true);YAHOO.lang.later(2000,this,function(){if(this.isRunning){if(!this.widgets.feedbackMessage){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this.msg("message.runningRules"),spanClass:"wait",displayTime:0})}else{if(!this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.show()}}}},[]);var o=q[1].value;if(!this.isRunning){this.isRunning=true;Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI_RELATIVE+"api/actionQueue",dataObj:{actionedUponNode:this.options.nodeRef.toString(),actionDefinitionName:"execute-all-rules",parameterValues:{"execute-inherited-rules":true,"run-all-rules-on-children":(o=="run-recursive")}},successCallback:{fn:function(s){this._enableRunRulesButton();var t=s.json;if(t){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.runRules-success")})}},scope:this},failureCallback:{fn:function(s){this._enableRunRulesButton();Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.failure"),text:this.msg("message.runRules-failure")})},scope:this}})}m.preventDefault(q[0])},_displayDetails:function c(){if(this.isReady&&this.ruleset&&this.folderDetails){if(!this.ruleset.rules||this.ruleset.linkedToRuleSet){i.addClass(this.widgets.actionsEl,"hidden")}else{i.removeClass(this.widgets.actionsEl,"hidden")}this.widgets.titleEl.innerHTML=g(this.folderDetails.fileName)}},_enableRunRulesButton:function n(){if(this.widgets.feedbackMessage&&this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.hide()}this.widgets.runRulesMenu.set("disabled",false);this.isRunning=false}})})();