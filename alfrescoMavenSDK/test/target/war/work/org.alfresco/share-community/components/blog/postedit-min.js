(function(){var g=YAHOO.util.Dom;Alfresco.BlogPostEdit=function(o){Alfresco.BlogPostEdit.superclass.constructor.call(this,"Alfresco.BlogPostEdit",o,["button","menu","json"]);this.blogPostData=null;this.performExternalPublish=false;return this};YAHOO.extend(Alfresco.BlogPostEdit,Alfresco.component.Base,{options:{siteId:"",containerId:"blog",editMode:false,postId:""},blogPostData:null,performExternalPublish:null,onReady:function d(){if(this.options.editMode){this._loadBlogPostData()}else{this._initializeBlogPostForm()}},_loadBlogPostData:function a(){var q=this;var o=function r(s){var t=s.json.item;q.blogPostData=t;q._initializeBlogPostForm()};var p=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/blog/post/site/{site}/{container}/{postId}",{site:this.options.siteId,container:this.options.containerId,postId:this.options.postId});Alfresco.util.Ajax.request({url:p,method:"GET",responseContentType:"application/json",successCallback:{fn:o,scope:this},failureMessage:this.msg("message.loadpostdata.failure")})},_initializeBlogPostForm:function c(){var q,o=true,r="",p="";if(this.options.editMode){q=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/blog/post/node/{nodeRef}",{nodeRef:this.blogPostData.nodeRef.replace(":/","")})}else{q=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/blog/site/{site}/{container}/posts",{site:this.options.siteId,container:this.options.containerId})}g.get(this.id+"-form").setAttribute("action",q);g.get(this.id+"-site").setAttribute("value",this.options.siteId);g.get(this.id+"-container").setAttribute("value",this.options.containerId);if(this.options.editMode){o=this.blogPostData.isDraft}g.get(this.id+"-draft").setAttribute("value",o);if(this.options.editMode){r=this.blogPostData.title}g.get(this.id+"-title").setAttribute("value",r);if(this.options.editMode){p=this.blogPostData.content}g.get(this.id+"-content").value=p;this._registerBlogPostForm()},_registerBlogPostForm:function l(){this.modules.tagLibrary=new Alfresco.module.TagLibrary(this.id);this.modules.tagLibrary.setOptions({siteId:this.options.siteId});if(this.options.editMode&&this.blogPostData.tags.length>0){this.modules.tagLibrary.setTags(this.blogPostData.tags)}this.widgets.saveButton=new YAHOO.widget.Button(this.id+"-save-button",{type:"submit",label:this.msg(this.options.editMode?"action.update":"action.saveAsDraft")});if(!this.options.editMode||this.blogPostData.isDraft){this.widgets.publishButton=Alfresco.util.createYUIButton(this,"publish-button",this.onFormPublishButtonClick);g.removeClass(this.id+"-publish-button","hidden")}var p="";if(!this.options.editMode){p=this.msg("action.publishIntAndExt")}else{if(this.blogPostData.isPublished){p=this.msg("action.updateIntAndExt")}else{p=this.msg("action.updateIntAndPublishExt")}}this.widgets.publishExternalButton=Alfresco.util.createYUIButton(this,"publishexternal-button",this.onFormPublishExternalButtonClick,{label:p});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onFormCancelButtonClick);this.widgets.editor=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,this.id+"-content",this.options.editorConfig);this.widgets.editor.addPageUnloadBehaviour(this.msg("message.unsavedChanges.blog"));this.widgets.editor.render();this.widgets.validateOnZero=0;var o=(Alfresco.constants.HTML_EDITOR==="YAHOO.widget.SimpleEditor")?"editorKeyUp":"onKeyUp";this.widgets.editor.subscribe(o,function(q){this.widgets.validateOnZero++;YAHOO.lang.later(1000,this,this.validateAfterEditorChange)},this,true);this.widgets.postForm=new Alfresco.forms.Form(this.id+"-form");this.widgets.postForm.addValidation(this.id+"-title",Alfresco.forms.validation.mandatory,null,"blur");this.widgets.postForm.addValidation(this.id+"-title",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");this.widgets.postForm.addValidation(this.id+"-content",Alfresco.forms.validation.mandatory,null);this.widgets.postForm.setShowSubmitStateDynamically(true,false);if(this.widgets.publishButton){this.widgets.postForm.setSubmitElements([this.widgets.saveButton,this.widgets.publishExternalButton,this.widgets.publishButton])}else{this.widgets.postForm.setSubmitElements([this.widgets.saveButton,this.widgets.publishExternalButton])}this.widgets.postForm.setAJAXSubmit(true,{successCallback:{fn:this.onFormSubmitSuccess,scope:this},failureMessage:this.msg("message.savepost.failure"),failureCallback:{fn:this.onFormSubmitFailure,scope:this}});if(this.options.editMode){this.widgets.postForm.setAjaxSubmitMethod(Alfresco.util.Ajax.PUT)}this.widgets.postForm.setSubmitAsJSON(true);this.widgets.postForm.doBeforeFormSubmit={fn:function(q,r){this.widgets.editor.save();if(g.get(this.id+"-content").value.length===0){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.noText",this.name)});return}this.widgets.saveButton.set("disabled",true);if(this.widgets.publishButton){this.widgets.publishButton.set("disabled",true)}this.widgets.publishExternalButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true);this.modules.tagLibrary.updateForm(this.id+"-form","tags");this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(this.msg("message.submitting")),spanClass:"wait",displayTime:0})},scope:this};this.modules.tagLibrary.initialize(this.widgets.postForm);this.widgets.postForm.init();g.removeClass(this.id+"-div","hidden");g.get(this.id+"-title").focus()},validateAfterEditorChange:function h(){this.widgets.validateOnZero--;if(this.widgets.validateOnZero===0){var o=g.get(this.id+"-content").value.length;this.widgets.editor.save();var p=g.get(this.id+"-content").value.length;if((o===0&&p!==0)||(o>0&&p===0)){this.widgets.postForm.updateSubmitElements()}}},onFormPublishButtonClick:function e(p,o){g.get(this.id+"-draft").setAttribute("value",false);this.widgets.saveButton.fireEvent("click",{type:"click"})},onFormPublishExternalButtonClick:function n(p,o){g.get(this.id+"-draft").setAttribute("value",false);this.performExternalPublish=true;this.widgets.saveButton.fireEvent("click",{type:"click"})},onFormCancelButtonClick:function b(p,o){history.go(-1)},onFormSubmitSuccess:function k(p){this.widgets.feedbackMessage.destroy();if(this.performExternalPublish){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(this.msg("message.postSavedNowPublish")),spanClass:"wait",displayTime:0});var o=p.json.item.name;if(p.json.item.isPublished){this.onUpdateExternal(o)}else{this.onPublishExternal(o)}}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.savepost.success")});this._loadPostViewPage(p.json.item.name)}},onFormSubmitFailure:function m(){this.widgets.saveButton.set("disabled",false);if(this.widgets.publishButton){this.widgets.publishButton.set("disabled",false)}this.widgets.publishExternalButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);this.widgets.feedbackMessage.destroy()},onPublishExternal:function f(o){var r=function p(u){this._loadPostViewPage(o)};var s=function t(u){this.widgets.feedbackMessage.destroy();var v=this;Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.publishExternal.failure"),buttons:[{text:this.msg("button.ok"),handler:function(){v._loadPostViewPage(o)},isDefault:true}]})};var q=Alfresco.util.blog.generatePublishingRestURL(this.options.siteId,this.options.containerId,o);Alfresco.util.Ajax.request({url:q,method:"POST",requestContentType:"application/json",responseContentType:"application/json",dataObj:{action:"publish"},successMessage:this.msg("message.publishExternal.success"),successCallback:{fn:r,scope:this},failureCallback:{fn:s,scope:this}})},onUpdateExternal:function j(o){var q=function t(u){this._loadPostViewPage(o)};var s=function r(u){this.widgets.feedbackMessage.destroy();var v=this;Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.updateExternal.failure"),buttons:[{text:this.msg("button.ok"),handler:function(){v._loadPostViewPage(o)},isDefault:true}]})};var p=Alfresco.util.blog.generatePublishingRestURL(this.options.siteId,this.options.containerId,o);Alfresco.util.Ajax.request({url:p,method:"POST",requestContentType:"application/json",responseContentType:"application/json",dataObj:{action:"update"},successMessage:this.msg("message.updateExternal.success"),successCallback:{fn:q,scope:this},failureCallback:{fn:s,scope:this}})},_loadPostViewPage:function i(o){window.location=Alfresco.util.blog.generateBlogPostViewUrl(this.options.siteId,this.options.containerId,o)}})})();