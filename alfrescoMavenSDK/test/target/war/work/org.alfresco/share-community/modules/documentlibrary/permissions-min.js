(function(){var h=YAHOO.util.Dom;var e=Alfresco.util.encodeHTML;Alfresco.module.DoclibPermissions=function(n){Alfresco.module.DoclibPermissions.superclass.constructor.call(this,"Alfresco.module.DoclibPermissions",n,["button","container","connection","json"]);this.rolePickers={};this.hiddenRoles=[];return this};YAHOO.extend(Alfresco.module.DoclibPermissions,Alfresco.component.Base,{options:{siteId:"",roles:null,files:null,width:"44em"},rolePickers:null,hiddenRoles:null,containerDiv:null,showDialog:function f(){if(!this.modules.actions){this.modules.actions=new Alfresco.module.DoclibActions()}if(!this.containerDiv){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/permissions",dataObj:{htmlid:this.id,site:this.options.siteId},successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load Document Library Permissions template",execScripts:true})}else{this._showDialog()}},onTemplateLoaded:function c(o){this.containerDiv=document.createElement("div");this.containerDiv.setAttribute("style","display:none");this.containerDiv.innerHTML=o.serverResponse.responseText;var s=h.getFirstChild(this.containerDiv);while(s&&s.tagName.toLowerCase()!="div"){s=h.getNextSibling(s)}this.widgets.dialog=Alfresco.util.createYUIPanel(s,{width:this.options.width});this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok",this.onOK);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);var r=YAHOO.util.Selector.query("button.site-group",this.widgets.dialog.element),t,n;for(var q=0,p=r.length;q<p;q++){t=r[q].id;n=r[q].value;this.rolePickers[n]=new YAHOO.widget.Button(t,{type:"menu",menu:t+"-select"});this.rolePickers[n].getMenu().subscribe("click",this.onRoleSelected,this.rolePickers[n])}this.widgets.resetAll=Alfresco.util.createYUIButton(this,"reset-all",this.onResetAll);this._showDialog()},onRoleSelected:function m(o,n,p){var q=n[1];p.set("label",q.cfg.getProperty("text"));p.set("name",q.value)},onResetAll:function b(n,o){this._applyPermissions("reset-all")},onOK:function i(o,p){var n=this._parseUI();this._applyPermissions("set",n)},_applyPermissions:function d(q,t){var o,w=[];o=this.options.files;for(var s=0,r=o.length;s<r;s++){w.push(o[s].node.nodeRef)}var v=function u(A){var x;var B=A.json.successCount;var C=A.json.failureCount;this._hideDialog();if(!A.json.overallSuccess){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.permissions.failure")});return}YAHOO.Bubbling.fire("filesPermissionsUpdated",{successCount:B,failureCount:C});for(var z=0,y=A.json.totalResults;z<y;z++){x=A.json.results[z];if(x.success){YAHOO.Bubbling.fire(x.type=="folder"?"folderPermissionsUpdated":"filePermissionsUpdated",{multiple:true,nodeRef:x.nodeRef})}}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.permissions.success",B)})};var p=function n(x){this._hideDialog();Alfresco.util.PopupManager.displayMessage({text:this.msg("message.permissions.failure")})};this.modules.actions.genericAction({success:{callback:{fn:v,scope:this}},failure:{callback:{fn:p,scope:this}},webscript:{method:Alfresco.util.Ajax.POST,name:"permissions/{operation}/site/{site}",params:{site:this.options.siteId,operation:q}},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{nodeRefs:w,permissions:t}}});this.widgets.okButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true)},onCancel:function a(n,o){this._hideDialog()},_showDialog:function g(){var q,p;this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);var s=h.get(this.id+"-title");if(YAHOO.lang.isArray(this.options.files)){s.innerHTML=this.msg("title.multi",this.options.files.length)}else{var n='<span class="light">'+e(this.options.files.displayName)+"</span>";s.innerHTML=this.msg("title.single",n);this.options.files=[this.options.files]}for(var u in this.rolePickers){if(this.rolePickers.hasOwnProperty(u)){this.rolePickers[u].set("name","");this.rolePickers[u].set("label",this.msg("role.None"))}}var t=this.options.files[0].node.permissions.roles,r;for(q=0,p=t.length;q<p;q++){r=t[q].split(";");if(r[1] in this.rolePickers&&r[2] in this.options.roles){this.rolePickers[r[1]].set("name",r[2]);this.rolePickers[r[1]].set("label",this.msg("role."+r[2]))}else{this.hiddenRoles.push({user:r[1],role:r[2]})}}var o=new YAHOO.util.KeyListener(document,{keys:YAHOO.util.KeyListener.KEY.ESCAPE},{fn:function(w,v){this.onCancel()},scope:this,correctScope:true});o.enable();this.widgets.dialog.show()},_hideDialog:function j(){var n=h.get(this.id+"-form");Alfresco.util.undoCaretFix(n);this.widgets.dialog.hide()},_parseUI:function k(){var q=[],r;for(var o in this.rolePickers){if(this.rolePickers.hasOwnProperty(o)){r=this.rolePickers[o].get("name");if((r!="")&&(r!="None")){q.push({group:this.rolePickers[o].get("value"),role:r})}}}for(var p=0,n=this.hiddenRoles.length;p<n;p++){q.push({group:this.hiddenRoles[p].user,role:this.hiddenRoles[p].role})}return q}});var l=new Alfresco.module.DoclibPermissions("null")})();