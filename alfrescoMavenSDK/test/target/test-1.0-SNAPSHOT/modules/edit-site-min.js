(function(){var h=YAHOO.util.Dom,c=YAHOO.util.Element;Alfresco.module.EditSite=function(n){this.name="Alfresco.module.EditSite";this.id=n;var m=Alfresco.util.ComponentManager.get(this.id);if(m!==null){throw new Error("An instance of Alfresco.module.EditSite already exists.")}this.editPanelActive=false;Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container","connection","selector","json","event"],this.onComponentsLoaded,this);return this};Alfresco.module.EditSite.prototype={editPanelActive:false,widgets:{},setMessages:function l(m){Alfresco.util.addMessages(m,this.name);return this},onComponentsLoaded:function i(){if(this.id===null){return}},defaultShowConfig:{},showConfig:{},show:function f(m){if(!this.editPanelActive){this.editPanelActive=true;this.showConfig=YAHOO.lang.merge(this.defaultShowConfig,m);if(this.showConfig.shortName===undefined){this.editPanelActive=false;throw new Error("A shortName must be provided")}if(this.widgets.panel){this.widgets.panel.destroy();this.widgets={}}Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/edit-site",dataObj:{htmlid:this.id,shortName:this.showConfig.shortName},successCallback:{fn:this.onTemplateLoaded,scope:this},execScripts:true,failureMessage:"Could not load edit site template"})}},onTemplateLoaded:function g(m){var p=document.createElement("div");p.innerHTML=m.serverResponse.responseText;var n=YAHOO.util.Dom.getFirstChild(p);this.widgets.panel=Alfresco.util.createYUIPanel(n,{close:false});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok-button",null,{type:"submit"});var o=new Alfresco.forms.Form(this.id+"-form");o.addValidation(this.id+"-title",Alfresco.forms.validation.mandatory,null,"keyup");o.addValidation(this.id+"-title",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");o.addValidation(this.id+"-description",Alfresco.forms.validation.length,{max:512,crop:true},"keyup");o.setShowSubmitStateDynamically(true,false);o.setSubmitElements(this.widgets.okButton);o.doBeforeFormSubmit={fn:function(){var r=YAHOO.util.Dom.get(this.id+"-form");r.attributes.action.nodeValue=Alfresco.constants.PROXY_URI+"api/sites/"+this.showConfig.shortName;var q="PUBLIC";if(this.widgets.isPublic.checked){if(this.widgets.isModerated.checked){q="MODERATED"}}else{q="PRIVATE"}this.widgets.siteVisibility.value=q;this.widgets.okButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true);this.widgets.panel.hide();this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.saving",this.name),spanClass:"wait",displayTime:0})},obj:null,scope:this};o.setAJAXSubmit(true,{successCallback:{fn:this.onEditSiteSuccess,scope:this},failureCallback:{fn:this.onEditSiteFailure,scope:this}});o.setSubmitAsJSON(true);o.setAjaxSubmitMethod("PUT");o.applyTabFix();o.init();this.widgets.siteVisibility=h.get(this.id+"-visibility");this.widgets.isPublic=h.get(this.id+"-isPublic");this.widgets.isModerated=h.get(this.id+"-isModerated");this.widgets.isPrivate=h.get(this.id+"-isPrivate");YAHOO.util.Event.addListener(this.widgets.isPublic,"change",this.onVisibilityChange,this,true);YAHOO.util.Event.addListener(this.widgets.isPrivate,"change",this.onVisibilityChange,this,true);this._showPanel()},onVisibilityChange:function b(n,m){new c(this.widgets.isModerated).set("disabled",!new c(this.widgets.isPublic).get("checked"))},onCancelButtonClick:function e(n,m){this.widgets.panel.hide();this.editPanelActive=false},onEditSiteSuccess:function j(m){if(m.json!==undefined&&m.json.shortName){document.location.href=Alfresco.constants.URL_PAGECONTEXT+"site/"+m.json.shortName+"/dashboard"}else{this._adjustGUIAfterFailure(m)}},onEditSiteFailure:function a(m){this._adjustGUIAfterFailure(m)},_adjustGUIAfterFailure:function d(m){this.widgets.feedbackMessage.destroy();this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);this.widgets.panel.show();var o=Alfresco.util.message("message.failure",this.name);if(m.json.message){var n=Alfresco.util.message(m.json.message,this.name);o=n?n:o}Alfresco.util.PopupManager.displayPrompt({text:o})},_showPanel:function k(){this.widgets.panel.show();Alfresco.util.caretFix(this.id+"-form");var m=new YAHOO.util.KeyListener(document,{keys:YAHOO.util.KeyListener.KEY.ESCAPE},{fn:function(o,n){this.onCancelButtonClick()},scope:this,correctScope:true});m.enable();YAHOO.util.Dom.get(this.id+"-title").focus()}}})();Alfresco.module.getEditSiteInstance=function(){var a="alfresco-editSite-instance";return Alfresco.util.ComponentManager.get(a)||new Alfresco.module.EditSite(a)};