(function(){var b=YAHOO.util.Dom,t=YAHOO.util.Event,o=YAHOO.util.Selector;var n=Alfresco.util.encodeHTML,q=Alfresco.util.siteURL,c=Alfresco.util.userProfileLink;Alfresco.component.WorkflowForm=function s(u){Alfresco.component.WorkflowForm.superclass.constructor.call(this,"Alfresco.component.WorkflowForm",u,["button","container","datasource","datatable"]);this.isReady=false;this.workflow=null;this.currentTasks=[];this.historyTasks=[];YAHOO.Bubbling.on("workflowDetailedData",this.onWorkflowDetailedData,this);return this};YAHOO.extend(Alfresco.component.WorkflowForm,Alfresco.component.Base,{options:{referrer:null,nodeRef:null},isReady:false,workflow:null,currentTasks:null,historyTasks:null,onReady:function m(){this.isReady=true;this._loadWorkflowForm()},onWorkflowDetailedData:function h(v,u){this.workflow=u[1];this._loadWorkflowForm()},_getTaskUrl:function d(w,v){var u=w+"?taskId="+encodeURIComponent(v);if(this.options.referrer){u+="&referrer="+encodeURIComponent(this.options.referrer)}else{if(this.options.nodeRef){u+="&nodeRef="+encodeURIComponent(this.options.nodeRef)}}return q(u)},_loadWorkflowForm:function a(){if(this.isReady&&this.workflow){if(this.workflow.diagramUrl){b.removeClass(this.id+"-viewWorkflowDiagram");Alfresco.util.createYUIButton(this,"viewWorkflowDiagram",this.viewWorkflowDiagram)}var D=this.workflow.tasks,G;for(var H=0,A=D.length;H<A;H++){if(D[H].state=="COMPLETED"){this.historyTasks.push(D[H])}else{this.currentTasks.push(D[H])}}var u=function(P,O){var R=Alfresco.util.fromISO8601(P),Q=Alfresco.util.fromISO8601(O);if(R&&Q){return R<Q?1:-1}else{return !R?1:-1}};this.currentTasks.sort(function(P,O){return u(P.properties.bpm_dueDate,O.properties.bpm_dueDate)});this.historyTasks.sort(function(P,O){return u(P.properties.bpm_completionDate,O.properties.bpm_completionDate)});G=this.historyTasks.length>0?this.historyTasks[0]:{properties:{}};b.get(this.id+"-recentTaskTitle").innerHTML=n(G.title||"");b.get(this.id+"-recentTaskTitle").setAttribute("href",this._getTaskUrl("task-details",G.id));b.get(this.id+"-title").innerHTML=n(this.workflow.title);b.get(this.id+"-description").innerHTML=n(this.workflow.description);var B=this.workflow.message;if(B===null){B=this.msg("workflow.no_message")}b.get(this.id+"-message").innerHTML=n(B);b.get(this.id+"-recentTaskOwnersComment").innerHTML=n(G.properties.bpm_comment||this.msg("label.noComment"));var w=G.owner||{},E=w.avatar,x=Alfresco.util.userProfileLink(w.userName,w.firstName+" "+w.lastName,null,!w.firstName);b.get(this.id+"-recentTaskOwnersAvatar").setAttribute("src",E?Alfresco.constants.PROXY_URI+E+"?c=force":Alfresco.constants.URL_RESCONTEXT+"components/images/no-user-photo-64.png");b.get(this.id+"-recentTaskOwnersCommentLink").innerHTML=this.msg("label.recentTaskOwnersCommentLink",x);var y=this.workflow.initiator||{};b.get(this.id+"-startedBy").innerHTML=Alfresco.util.userProfileLink(y.userName||this.msg("label.usernameDeleted"),y.firstName+" "+y.lastName,null,!y.firstName);var K=Alfresco.util.fromISO8601(this.workflow.dueDate);if(K){b.get(this.id+"-dueSummary").innerHTML=this.msg("label.dueOn",Alfresco.util.formatDate(K,"defaultDateOnly"));b.get(this.id+"-due").innerHTML=Alfresco.util.formatDate(K,"defaultDateOnly")}else{b.get(this.id+"-dueSummary").innerHTML=this.msg("label.noDueDate");b.get(this.id+"-due").innerHTML=this.msg("label.none")}var C=Alfresco.util.fromISO8601(G.properties.bpm_completionDate);b.get(this.id+"-recentTaskCompletedOn").innerHTML=n(C?Alfresco.util.formatDate(C,"mediumDate"):this.msg("label.notCompleted"));b.get(this.id+"-recentTaskCompletedBy").innerHTML=w.userName?x:this.msg("label.notCompleted");b.get(this.id+"-recentTaskOutcome").innerHTML=n(G.outcome||"");var I=Alfresco.util.fromISO8601(this.workflow.endDate);b.get(this.id+"-completed").innerHTML=n(I?Alfresco.util.formatDate(I):this.msg("label.notCompleted"));var v=Alfresco.util.fromISO8601(this.workflow.startDate);if(v){b.get(this.id+"-started").innerHTML=Alfresco.util.formatDate(v)}var J={"1":"high","2":"medium","3":"low"},M=J[this.workflow.priority+""],L=this.msg("priority."+M),z=this.msg("label.priorityLevel",L);var N=b.get(this.id+"-prioritySummary");b.addClass(N,M);N.innerHTML=z;b.get(this.id+"-priority").innerHTML=L;var F=this.workflow.isActive?this.msg("label.workflowIsInProgress"):this.msg("label.workflowIsComplete");b.get(this.id+"-statusSummary").innerHTML=n(F);b.get(this.id+"-status").innerHTML=n(F);Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/form",dataObj:{htmlid:this.id+"-WorkflowForm-"+Alfresco.util.generateDomId(),itemKind:"task",itemId:this.workflow.startTaskInstanceId,mode:"view",formId:"workflow-details",formUI:false},successCallback:{fn:this.onWorkflowFormLoaded,scope:this},failureMessage:this.msg("message.failure"),scope:this,execScripts:true})}},onWorkflowFormLoaded:function f(y){var F=b.get(this.id+"-body");F.innerHTML=y.serverResponse.responseText;var z=o.query(".form-fields",this.id,true),w=b.get(this.id+"-summary-form-section"),u=b.get(this.id+"-general-form-section");z.insertBefore(u,b.getFirstChild(z));z.insertBefore(w,u);var A=b.get(this.id+"-currentTasks-form-section"),B=o.query("div",A,true);var D=[{key:"name",label:this.msg("column.type"),formatter:this.bind(this.renderCellType)},{key:"owner",label:this.msg("column.assignedTo"),formatter:this.bind(this.renderCellOwner)},{key:"id",label:this.msg("column.dueDate"),formatter:this.bind(this.renderCellDueDate)},{key:"state",label:this.msg("column.status"),formatter:this.bind(this.renderCellStatus)},{key:"properties",label:this.msg("column.actions"),formatter:this.bind(this.renderCellCurrentTasksActions)}];var C=new YAHOO.util.DataSource(this.currentTasks,{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});this.widgets.currentTasksDataTable=new YAHOO.widget.DataTable(B,D,C,{MSG_EMPTY:this.msg("label.noTasks")});var G=[{key:"name",label:this.msg("column.type"),formatter:this.bind(this.renderCellType)},{key:"owner",label:this.msg("column.completedBy"),formatter:this.bind(this.renderCellOwner)},{key:"id",label:this.msg("column.dateCompleted"),formatter:this.bind(this.renderCellDateCompleted)},{key:"state",label:this.msg("column.outcome"),formatter:this.bind(this.renderCellOutcome)},{key:"properties",label:this.msg("column.comment"),formatter:this.bind(this.renderCellComment)}];var x=b.get(this.id+"-workflowHistory-form-section"),E=o.query("div",x,true);var v=new YAHOO.util.DataSource(this.historyTasks,{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});this.widgets.historyTasksDataTable=new YAHOO.widget.DataTable(E,G,v,{MSG_EMPTY:this.msg("label.noTasks")});o.query(".form-fields",this.id,true).appendChild(A);o.query(".form-fields",this.id,true).appendChild(x);YAHOO.Bubbling.fire("workflowFormReady",this)},viewWorkflowDiagram:function(){if(this.workflow.diagramUrl){showLightbox({src:Alfresco.constants.PROXY_URI+this.workflow.diagramUrl})}},renderCellType:function l(w,v,x,y){var u=v.getData();if(u.isEditable){w.innerHTML='<a href="'+this._getTaskUrl("task-edit",v.getData("id"))+'" title="'+this.msg("link.title.task-edit")+'">'+n(v.getData("title"))+"</a>"}else{w.innerHTML='<a href="'+this._getTaskUrl("task-details",v.getData("id"))+'" title="'+this.msg("link.title.task-details")+'">'+n(v.getData("title"))+"</a>"}},renderCellOwner:function r(x,w,y,z){var u=w.getData("owner");if(u!=null&&u.userName){var v=n(this.msg("field.owner",u.firstName,u.lastName));x.innerHTML=c(u.userName,u.firstName&&u.lastName?v:null,null,!u.firstName)}else{x.innerHTML=this.msg("label.none")}},renderCellDateCompleted:function g(w,v,x,y){var u=Alfresco.util.fromISO8601(v.getData("properties").bpm_completionDate);w.innerHTML=Alfresco.util.formatDate(u)},renderCellDueDate:function k(x,w,y,z){var u=w.getData("properties").bpm_dueDate;if(u!==null){var v=Alfresco.util.fromISO8601(u);x.innerHTML=Alfresco.util.formatDate(v,"defaultDateOnly")}else{x.innerHTML=this.msg("label.none")}},renderCellStatus:function e(v,u,w,x){v.innerHTML=n(u.getData("properties").bpm_status)},renderCellOutcome:function j(v,u,w,x){v.innerHTML=n(u.getData("outcome"))},renderCellComment:function p(v,u,w,x){v.innerHTML=n(u.getData("properties").bpm_comment)},renderCellCurrentTasksActions:function i(w,v,x,y){var u=v.getData();w.innerHTML+='<a href="'+this._getTaskUrl("task-details",u.id)+'" class="task-details" title="'+this.msg("link.title.task-details")+'">&nbsp;</a>';if(u.isEditable){w.innerHTML+='<a href="'+this._getTaskUrl("task-edit",u.id)+'" class="task-edit" title="'+this.msg("link.title.task-edit")+'">&nbsp;</a>'}}})})();