(function(){var f=YAHOO.util.Dom,l=YAHOO.util.Event,b=YAHOO.util.Selector;var e=Alfresco.util.encodeHTML,g=Alfresco.util.hasEventInterest;Alfresco.component.TaskEditHeader=function k(o){Alfresco.component.TaskEditHeader.superclass.constructor.call(this,o,["button"]);this.name="Alfresco.component.TaskEditHeader";this.options=YAHOO.lang.merge(this.options,Alfresco.component.TaskEditHeader.superclass.options);Alfresco.util.ComponentManager.reregister(this);this.isRunning=false;this.taskId=null;YAHOO.Bubbling.on("taskDetailedData",this.onTaskDetailedData,this);return this};YAHOO.extend(Alfresco.component.TaskEditHeader,Alfresco.component.ShareFormManager,{isRunning:false,taskId:null,onReady:function a(){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/people-finder/people-finder",dataObj:{htmlid:this.id+"-peopleFinder"},successCallback:{fn:this.onPeopleFinderLoaded,scope:this},failureMessage:"Could not load People Finder component",execScripts:true})},onPeopleFinderLoaded:function c(p){var o=f.get(this.id+"-peopleFinder");o.innerHTML=p.serverResponse.responseText;this.widgets.reassignPanel=Alfresco.util.createYUIPanel(this.id+"-reassignPanel");this.widgets.peopleFinder=Alfresco.util.ComponentManager.get(this.id+"-peopleFinder");this.widgets.peopleFinder.setOptions({singleSelectMode:true,addButtonLabel:this.msg("button.select")});YAHOO.Bubbling.on("personSelected",this.onPersonSelected,this)},onPersonSelected:function n(p,o){if(g(this.widgets.peopleFinder,o)){this.widgets.reassignPanel.hide();this._updateTaskProperties({cm_owner:o[1].userName},"reassign")}},onTaskDetailedData:function j(q,p){var o=p[1];this.taskId=o.id;b.query("h1 span",this.id,true).innerHTML=e(o.title);if(o.isReassignable){this.widgets.reassignButton=Alfresco.util.createYUIButton(this,"reassign",this.onReassignButtonClick);f.removeClass(b.query(".actions .reassign",this.id),"hidden")}if(o.isClaimable){this.widgets.claimButton=Alfresco.util.createYUIButton(this,"claim",this.onClaimButtonClick);f.removeClass(b.query(".actions .claim",this.id),"hidden");f.removeClass(b.query(".unassigned-message",this.id),"hidden")}if(o.isReleasable){this.widgets.releaseButton=Alfresco.util.createYUIButton(this,"release",this.onReleaseButtonClick);f.removeClass(b.query(".actions .release",this.id),"hidden")}},onReleaseButtonClick:function m(p,o){this._updateTaskProperties({cm_owner:null},"release")},onClaimButtonClick:function i(p,o){this._updateTaskProperties({cm_owner:Alfresco.constants.USERNAME},"claim")},onReassignButtonClick:function d(p,o){this.widgets.peopleFinder.clearResults();this.widgets.reassignPanel.show()},_updateTaskProperties:function h(o,p){this._disableActionButtons(true);YAHOO.lang.later(2000,this,function(){if(this.isRunning){if(!this.widgets.feedbackMessage){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this.msg("message."+p),spanClass:"wait",displayTime:0})}else{if(!this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.show()}}}},[]);if(!this.isRunning){this.isRunning=true;Alfresco.util.Ajax.jsonPut({url:Alfresco.constants.PROXY_URI_RELATIVE+"api/task-instances/"+this.taskId,dataObj:o,successCallback:{fn:function(q,s){this.isRunning=false;var r=q.json.data;if(r){Alfresco.util.PopupManager.displayMessage({text:this.msg("message."+s+".success")});YAHOO.lang.later(3000,this,function(t){if(t.owner&&t.owner.userName==Alfresco.constants.USERNAME){document.location.reload()}else{this.navigateForward(true)}},r)}},obj:p,scope:this},failureCallback:{fn:function(q){this.isRunning=false;this._disableActionButtons(false);Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.failure"),text:this.msg("message."+p+".failure")})},scope:this}})}},_disableActionButtons:function(o){if(this.widgets.reassignButton){this.widgets.reassignButton.set("disabled",o)}if(this.widgets.releaseButton){this.widgets.releaseButton.set("disabled",o)}if(this.widgets.claimButton){this.widgets.claimButton.set("disabled",o)}}})})();