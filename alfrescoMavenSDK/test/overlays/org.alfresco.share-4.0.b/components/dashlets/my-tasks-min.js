(function(){var g=YAHOO.util.Dom,l=YAHOO.util.Event,a=YAHOO.util.Selector;var d=Alfresco.util.encodeHTML,f=Alfresco.util.siteURL;var i="org.alfresco.share.tasks.dashlet.filter";Alfresco.dashlet.MyTasks=function e(n){Alfresco.dashlet.MyTasks.superclass.constructor.call(this,"Alfresco.dashlet.MyTasks",n,["button","container","datasource","datatable","paginator","history","animation"]);this.services.preferences=new Alfresco.service.Preferences();return this};YAHOO.extend(Alfresco.dashlet.MyTasks,Alfresco.component.Base);YAHOO.lang.augmentProto(Alfresco.dashlet.MyTasks,Alfresco.action.WorkflowActions);YAHOO.lang.augmentObject(Alfresco.dashlet.MyTasks.prototype,{options:{hiddenTaskTypes:[],maxItems:50,filters:{}},onReady:function k(){this.widgets.filterMenuButton=Alfresco.util.createYUIButton(this,"filters",this.onFilterSelected,{type:"menu",menu:"filters-menu",lazyloadmenu:false});this.services.preferences.request(i,{successCallback:{fn:this.onPreferencesLoaded,scope:this}})},onPreferencesLoaded:function m(t){var q=Alfresco.util.findValueByDotNotation(t.json,i,"allTasks");q=this.options.filters.hasOwnProperty(q)?q:"allTasks";this.widgets.filterMenuButton.set("label",this.msg("filter."+q));this.widgets.filterMenuButton.value=q;g.removeClass(a.query(".toolbar div",this.id,true),"hidden");var p=YAHOO.lang.substitute("api/task-instances?authority={authority}&properties={properties}&exclude={exclude}",{authority:encodeURIComponent(Alfresco.constants.USERNAME),properties:["bpm_priority","bpm_status","bpm_dueDate","bpm_description"].join(","),exclude:this.options.hiddenTaskTypes.join(",")});this.widgets.alfrescoDataTable=new Alfresco.util.DataTable({dataSource:{url:Alfresco.constants.PROXY_URI+p,initialParameters:this.substituteParameters(this.options.filters[q])||""},dataTable:{container:this.id+"-tasks",columnDefinitions:[{key:"isPooled",sortable:false,formatter:this.bind(this.renderCellIcons),width:24},{key:"title",sortable:false,formatter:this.bind(this.renderCellTaskInfo)},{key:"name",sortable:false,formatter:this.bind(this.renderCellActions),width:45}],config:{MSG_EMPTY:this.msg("message.noTasks")}},paginator:{history:false,hide:false,config:{containers:[this.id+"-paginator"],template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),rowsPerPage:this.options.maxItems}}});var r=this,s=this.widgets.alfrescoDataTable.getDataTable(),o=s.doBeforeLoadData;s.doBeforeLoadData=function n(u,v,w){g.setStyle(this.configs.paginator.getContainerNodes(),"visibility",(v.results.length==0)?"hidden":"visible");if(v.results.length===0){v.results.unshift({isInfo:true,title:r.msg("empty.title"),description:r.msg("empty.description")})}return o.apply(this,arguments)}},onFilterSelected:function h(o,n){var p=n[1];if(p){this.widgets.filterMenuButton.set("label",p.cfg.getProperty("text"));this.widgets.filterMenuButton.value=p.value;var q=this.substituteParameters(this.options.filters[p.value],{});this.widgets.alfrescoDataTable.loadDataTable(q);this.services.preferences.set(i,p.value)}},renderCellIcons:function c(v,w,s,n){var p=w.getData(),r="";if(p.isInfo){s.width=52;g.setStyle(v,"width",s.width+"px");g.setStyle(v.parentNode,"width",s.width+"px");r='<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/help-task-bw-32.png" />'}else{var u=p.properties.bpm_priority,t={"1":"high","2":"medium","3":"low"},o=t[u+""],q=p.isPooled;r='<img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/priority-"+o+'-16.png" title="'+this.msg("label.priority",this.msg("priority."+o))+'"/>';if(q){r+='<br/><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/pooled-task-16.png" title="'+this.msg("label.pooledTask")+'"/>'}}v.innerHTML=r},renderCellTaskInfo:function j(r,C,t,x){var E=C.getData(),y="";if(E.isInfo){y+='<div class="empty"><h3>'+E.title+"</h3>";y+="<span>"+E.description+"</span></div>"}else{var o=E.id,u=E.properties.bpm_description,v=E.properties.bpm_dueDate,D=v?Alfresco.util.fromISO8601(v):null,A=new Date(),p=E.title,w=E.properties.bpm_status,B=E.owner;if(u==p){u=this.msg("workflow.no_message")}var q='<h3><a href="'+f("task-edit?taskId="+o+"&referrer=tasks")+'" class="theme-color-1" title="'+this.msg("title.editTask")+'">'+d(u)+"</a></h3>",z=D?'<h4><span class="'+(A>D?"task-delayed":"")+'" title="'+this.msg("title.dueOn",Alfresco.util.formatDate(D,"longDate"))+'">'+Alfresco.util.formatDate(D,"longDate")+"</span></h4>":"",n='<div title="'+this.msg("title.taskSummary",p,w)+'">'+this.msg("label.taskSummary",p,w)+"</div>",s="";if(!B||!B.userName){s='<span class="theme-bg-color-5 theme-color-5 unassigned-task">'+this.msg("label.unassignedTask")+"</span>"}y=q+z+n+s}r.innerHTML=y},renderCellActions:function b(p,n,q,s){var o=n.getData(),r="";if(o.isInfo){q.width=0;g.setStyle(p,"width",q.width+"px");g.setStyle(p.parentNode,"width",q.width+"px")}else{if(o.isEditable){r+='<a href="'+f("task-edit?taskId="+o.id+"&referrer=tasks")+'" class="edit-task" title="'+this.msg("title.editTask")+'">&nbsp;</a>'}r+='<a href="'+f("task-details?taskId="+o.id+"&referrer=tasks")+'" class="view-task" title="'+this.msg("title.viewTask")+'">&nbsp;</a>'}p.innerHTML=r}})})();