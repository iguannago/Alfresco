(function(){var e=YAHOO.util.Dom,b=YAHOO.util.KeyListener;Alfresco.HtmlUpload=function(k){Alfresco.HtmlUpload.superclass.constructor.call(this,"Alfresco.HtmlUpload",k,["button","container"]);this.defaultShowConfig={siteId:null,containerId:null,destination:null,uploadDirectory:null,updateNodeRef:null,updateFilename:null,updateVersion:"1.0",mode:this.MODE_SINGLE_UPLOAD,onFileUploadComplete:null,overwrite:false,thumbnails:null,uploadURL:null,username:null,suppressRefreshEvent:false,adobeFlashEnabled:true};this.showConfig={};return this};YAHOO.extend(Alfresco.HtmlUpload,Alfresco.component.Base,{MODE_SINGLE_UPLOAD:1,MODE_SINGLE_UPDATE:2,defaultShowConfig:null,showConfig:null,versionSection:null,_fileName:null,onReady:function j(){var m=this;e.removeClass(this.id+"-dialog","hidden");this.widgets.panel=Alfresco.util.createYUIPanel(this.id+"-dialog");this.widgets.titleText=e.get(this.id+"-title-span");this.widgets.singleUploadTip=e.get(this.id+"-singleUploadTip-span");this.widgets.singleUpdateTip=e.get(this.id+"-singleUpdateTip-span");this.widgets.filedata=e.get(this.id+"-filedata-file");if(YAHOO.env.ua.ie>0){}else{YAHOO.util.Event.addListener(this.id+"-filedata-file","change",function(){if(this.files.length>0){m._fileName=this.files[0].name}})}this.widgets.filedata.contentEditable=false;this.widgets.siteId=e.get(this.id+"-siteId-hidden");this.widgets.containerId=e.get(this.id+"-containerId-hidden");this.widgets.destination=e.get(this.id+"-destination-hidden");this.widgets.username=e.get(this.id+"-username-hidden");this.widgets.updateNodeRef=e.get(this.id+"-updateNodeRef-hidden");this.widgets.uploadDirectory=e.get(this.id+"-uploadDirectory-hidden");this.widgets.overwrite=e.get(this.id+"-overwrite-hidden");this.widgets.thumbnails=e.get(this.id+"-thumbnails-hidden");this.widgets.successCallback=e.get(this.id+"-successCallback-hidden");this.widgets.successScope=e.get(this.id+"-successScope-hidden");this.widgets.failureCallback=e.get(this.id+"-failureCallback-hidden");this.widgets.failureScope=e.get(this.id+"-failureScope-hidden");this.widgets.description=e.get(this.id+"-description-textarea");this.widgets.minorVersion=e.get(this.id+"-minorVersion-radioButton");this.widgets.versionSection=e.get(this.id+"-versionSection-div");this.widgets.uploadButton=Alfresco.util.createYUIButton(this,"upload-button",null,{type:"submit"});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);var l=new Alfresco.forms.Form(this.id+"-htmlupload-form");this.widgets.form=l;l.addValidation(this.id+"-filedata-file",Alfresco.forms.validation.mandatory,null,"change");l.addValidation(this.id+"-filedata-file",function k(t,o,s,r,n,q){if(YAHOO.env.ua.ie>0){return true}else{var p={id:t.id,value:o.uploader._fileName};if(!Alfresco.forms.validation.nodeName(p,o,s,r,n,q)){Alfresco.util.PopupManager.displayMessage({text:o.uploader.msg("message.illegalCharacters")});return false}else{return true}}},{uploader:this},"change");l.setShowSubmitStateDynamically(true,false);l.setSubmitElements(this.widgets.uploadButton);l.doBeforeFormSubmit={fn:function(){this.widgets.uploadButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true);this.widgets.panel.hide();this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.uploading",this.name),spanClass:"wait",displayTime:0})},obj:null,scope:this};l.setAJAXSubmit(true,{});l.applyTabFix();l.init();this.widgets.escapeListener=new b(document,{keys:b.KEY.ESCAPE},{fn:this.onCancelButtonClick,scope:this,correctScope:true})},show:function i(k){this.showConfig=YAHOO.lang.merge(this.defaultShowConfig,k);if(this.showConfig.uploadDirectory===undefined&&this.showConfig.updateNodeRef===undefined){throw new Error("An updateNodeRef OR uploadDirectory must be provided")}if(this.showConfig.uploadDirectory!==null&&this.showConfig.uploadDirectory.length===0){this.showConfig.uploadDirectory="/"}this.widgets.escapeListener.enable();this._showPanel()},hide:function f(){this.onCancelButtonClick()},onUploadSuccess:function d(k){this.widgets.feedbackMessage.destroy();var n=k.fileName?k.fileName:this.widgets.filedata.value;if(!this.showConfig.suppressRefreshEvent){YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path,highlightFile:n})}var l={successful:[{nodeRef:k.nodeRef,fileName:n,response:k}]};var m=this.showConfig.onFileUploadComplete;if(m&&typeof m.fn=="function"){m.fn.call((typeof m.scope=="object"?m.scope:this),l,m.obj)}},onUploadFailure:function h(l){this.widgets.feedbackMessage.destroy();var k="message.failure."+l.status.code,m=Alfresco.util.message(k,this.name);if(m==k){m=l.status.code?l.status.code:Alfresco.util.message("message.failure",this.name)}Alfresco.util.PopupManager.displayPrompt({title:Alfresco.util.message("message.failure",this.name),text:m})},onCancelButtonClick:function c(){this.widgets.escapeListener.disable();this.widgets.panel.hide()},_applyConfig:function a(){var r;if(this.showConfig.mode===this.MODE_SINGLE_UPLOAD){r=Alfresco.util.message("header.singleUpload",this.name)}else{if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){r=Alfresco.util.message("header.singleUpdate",this.name)}}this.widgets.titleText.innerHTML=r;if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){var o=Alfresco.util.message("label.singleUpdateTip",this.name,{"0":this.showConfig.updateFilename});this.widgets.singleUpdateTip.innerHTML=o;e.removeClass(this.widgets.versionSection,"hidden");var l=(this.showConfig.updateVersion||"1.0").split("."),k=parseInt(l[0],10),p=parseInt(l[1],10);e.get(this.id+"-minorVersion").innerHTML=this.msg("label.minorVersion.more",k+"."+(1+p));e.get(this.id+"-majorVersion").innerHTML=this.msg("label.majorVersion.more",(1+k)+".0")}else{e.addClass(this.widgets.versionSection,"hidden")}if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){e.removeClass(this.widgets.singleUpdateTip,"hidden");e.addClass(this.widgets.singleUploadTip,"hidden")}else{e.addClass(this.widgets.singleUploadTip,"hidden");if(this.showConfig.adobeFlashEnabled){e.removeClass(this.widgets.singleUploadTip,"hidden")}e.addClass(this.widgets.singleUpdateTip,"hidden")}this.widgets.cancelButton.set("disabled",false);this.widgets.filedata.value=null;this.widgets.uploadButton.set("disabled",true);var n=e.get(this.id+"-htmlupload-form");if(this.showConfig.uploadURL===null){n.action=Alfresco.constants.PROXY_URI+"api/upload.html"}else{n.action=Alfresco.constants.PROXY_URI+this.showConfig.uploadURL}this.widgets.siteId.value=this.showConfig.siteId;this.widgets.containerId.value=this.showConfig.containerId;this.widgets.destination.value=this.showConfig.destination;this.widgets.username.value=this.showConfig.username;if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){this.widgets.updateNodeRef.value=this.showConfig.updateNodeRef;this.widgets.uploadDirectory.value="";this.widgets.overwrite.value="";this.widgets.thumbnails.value=""}else{this.widgets.updateNodeRef.value="";this.widgets.uploadDirectory.value=this.showConfig.uploadDirectory;this.widgets.overwrite.value=this.showConfig.overwrite;this.widgets.thumbnails.value=this.showConfig.thumbnails}var q="window.parent.Alfresco.util.ComponentManager.get('"+this.id+"')";this.widgets.successCallback.value=q+".onUploadSuccess";this.widgets.successScope.value=q;var m="window.parent.Alfresco.util.ComponentManager.get('"+this.id+"')";this.widgets.failureCallback.value=m+".onUploadFailure";this.widgets.failureScope.value=m},_showPanel:function g(){this.widgets.description.value="";this.widgets.minorVersion.checked=true;this._applyConfig();this.widgets.panel.show()}})})();