(function(){var c=YAHOO.util.Dom,s=YAHOO.util.Event;var m=Alfresco.util.encodeHTML;Alfresco.module.TagLibrary=function(t){Alfresco.module.TagLibrary.superclass.constructor.call(this,"Alfresco.module.TagLibrary",t+"-tagLibrary",["button"]);this.id=t;this.tagId={id:0,tags:{}};this.currentTags=[];this.setTags([]);return this};YAHOO.extend(Alfresco.module.TagLibrary,Alfresco.component.Base,{options:{siteId:"",topN:10},balloon:null,tagId:null,currentTags:null,setCurrentTags:function f(t){this.currentTags=t;return this},formsRuntime:null,initialize:function o(y){var D=this;var E=function z(K,I){var H=YAHOO.Bubbling.getOwnerByTagName(I[1].anchor,"li");if(H!==null){var L="";L=H.getAttribute("class");if(typeof D[L]=="function"){var J=D.findTagName(D,H.id);D[L].call(D,J);I[1].stop=true}}return true};YAHOO.Bubbling.addDefaultAction("taglibrary-action",E);s.addListener(this.id+"-load-popular-tags-link","click",this.onPopularTagsLinkClicked,this,true);var t=new YAHOO.util.KeyListener(this.id+"-load-popular-tags-link",{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function C(H,I,J){D.onPopularTagsLinkClicked(I[1],this);return true},scope:this,correctScope:true},"keypress");t.enable();var A=new YAHOO.util.KeyListener(this.id+"-tag-input-field",{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function C(H,J,K){var I=this.formsRuntime._runValidations(true);if(I){D.onAddTagButtonClick();this.balloon.hide()}s.stopEvent(J[1]);return false},scope:this,correctScope:true},"keypress");A.enable();var u=Alfresco.util.createYUIButton(this,"add-tag-button",this.onAddTagButtonClick,{type:"button",disabled:(typeof y!="undefined"),htmlName:"-"});if(y){var F=c.get(this.id+"-tag-input-field");this.balloon=Alfresco.util.createBalloon(F);this.balloon.onClose.subscribe(function(H){try{F.focus()}catch(H){}},this,true);var w=new Alfresco.forms.Form(y.formId);w.setShowSubmitStateDynamically(true,true);w.setSubmitElements(u);w.setAJAXSubmit(true);w.doBeforeAjaxRequest={fn:function x(H,I){return false},obj:null,scope:this};var v=Alfresco.util.message("validation-hint.nodeName");w.addValidation(this.id+"-tag-input-field",Alfresco.forms.validation.nodeName,null,"keyup",v);w.addValidation(this.id+"-tag-input-field",Alfresco.forms.validation.mandatory);w.addValidation(this.id+"-tag-input-field",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");var G=this;w.addError=function B(I,H){G.balloon.html(I);G.balloon.show()};this.formsRuntime=w}},generateTagId:function p(v,t,w){var x=0,u=v.tagId;if(t in u.tags){x=u.tags[t]}else{u.id++;x=u.tags[t]=u.id}return v.id+"-"+w+"-"+x},findTagName:function d(w,v){var x=v.substring(w.id.length+1),u=x.substring(x.indexOf("-")+1);for(var t in w.tagId.tags){if(w.tagId.tags[t]==u){return t}}return null},setTags:function q(t){var w=c.get(this.id+"-current-tags");if(w!==null){w.innerHTML="";this.currentTags=[];for(var u=0,v=t.length;u<v;u++){this._addTagImpl(t[u])}c.setStyle(this.id+"-load-popular-tags-link","display","inline");c.get(this.id+"-popular-tags").innerHTML="<li></li>"}},getTags:function b(){return this.currentTags},updateForm:function i(B,y){var C=y+"[]";var u=c.get(B);var z=u.getElementsByTagName("input"),A,t;for(A=0;A<z.length;A++){if(z[A].name==C){z[A].parentNode.removeChild(z[A]);A--}}var v,w;if(this.currentTags.length>0){for(A=0,t=this.currentTags.length;A<t;A++){v=this.currentTags[A];w=document.createElement("input");w.setAttribute("name",C);w.setAttribute("value",v);w.setAttribute("type","hidden");u.appendChild(w)}}else{w=document.createElement("input");w.setAttribute("name",y);w.setAttribute("value","");w.setAttribute("type","hidden");u.appendChild(w)}},onRemoveTag:function r(t){this._removeTagImpl(t)},onAddTag:function l(t){this._addTagImpl(t)},onPopularTagsLinkClicked:function a(v,u){var t=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/tagscopes/site/{site}/tags?d={d}&topN={tn}",{site:this.options.siteId,d:new Date().getTime(),tn:this.options.topN});Alfresco.util.Ajax.request({url:t,method:"GET",responseContentType:"application/json",successCallback:{fn:this._onPopularTagsLoaded,scope:this},failureMessage:this.msg("taglibrary.msg.failedLoadTags")});s.stopEvent(v)},_onPopularTagsLoaded:function e(t){this._displayPopularTags(t.json.tags)},_displayPopularTags:function k(t){c.setStyle(this.id+"-load-popular-tags-link","display","none");var y=c.get(this.id+"-popular-tags"),z=Alfresco.util.arrayToObject(this.currentTags),v,x,A;y.innerHTML="";for(var u=0,w=t.length;u<w;u++){v=t[u].name;if(!(v in z)){x=document.createElement("li");A=this.generateTagId(this,v,"onAddTag");x.setAttribute("id",A);x.setAttribute("class","onAddTag");x.innerHTML='<a href="#" class="taglibrary-action"><span>'+m(v)+'</span><span class="add">&nbsp;</span></a>';y.appendChild(x)}}},onAddTagButtonClick:function g(y,w){var u=c.get(this.id+"-tag-input-field"),A=u.value,v=Alfresco.util.getTags(A);for(var t=0,z=v.length;t<z;t++){this._addTagImpl(v[t])}u.value=""},_fireTagsChangedEvent:function h(){YAHOO.Bubbling.fire("onTagLibraryTagsChanged",{tags:this.currentTags})},_addTagImpl:function j(v){if(v===null||v.length<1){return}for(var t=0,z=this.currentTags.length;t<z;t++){if(v==this.currentTags[t]){return}}this.currentTags.push(v);var u=c.get(this.id+"-current-tags"),w=document.createElement("li"),y=this.generateTagId(this,v,"onRemoveTag");w.setAttribute("id",y);w.setAttribute("class","onRemoveTag");w.innerHTML='<a href="#" class="taglibrary-action"><span>'+m(v)+'</span><span class="remove">&nbsp;</span></a>';u.appendChild(w);this._fireTagsChangedEvent()},_removeTagImpl:function n(u){if(u===null||u.length<1){return}for(var t=0;t<this.currentTags.length;t++){if(u==this.currentTags[t]){this.currentTags.splice(t,1);t--}}var w=this.generateTagId(this,u,"onRemoveTag"),v=c.get(w);v.parentNode.removeChild(v);this._fireTagsChangedEvent()}})})();