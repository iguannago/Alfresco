(function(){var e=YAHOO.util.Dom,H=YAHOO.util.Event,y=YAHOO.util.Element;var z=Alfresco.util.encodeHTML,q=Alfresco.util.combinePaths,C=Alfresco.util.siteURL;var x="org.alfresco.share.documentList",D=x+".hideNavBar";Alfresco.DocListToolbar=function(I){Alfresco.DocListToolbar.superclass.constructor.call(this,"Alfresco.DocListToolbar",I,["button","menu","container"]);this.selectedFiles=[];this.currentFilter={};this.dynamicControls=[];this.doclistMetadata={};this.actionsView="browse";YAHOO.Bubbling.on("filterChanged",this.onFilterChanged,this);YAHOO.Bubbling.on("deactivateAllControls",this.onDeactivateAllControls,this);YAHOO.Bubbling.on("deactivateDynamicControls",this.onDeactivateDynamicControls,this);YAHOO.Bubbling.on("selectedFilesChanged",this.onSelectedFilesChanged,this);YAHOO.Bubbling.on("userAccess",this.onUserAccess,this);YAHOO.Bubbling.on("doclistMetadata",this.onDoclistMetadata,this);YAHOO.Bubbling.on("showFileUploadDialog",this.onFileUpload,this);YAHOO.Bubbling.on("dropTargetOwnerRequest",this.onDropTargetOwnerRequest,this);YAHOO.Bubbling.on("documentDragOver",this.onDocumentDragOver,this);YAHOO.Bubbling.on("documentDragOut",this.onDocumentDragOut,this);YAHOO.Bubbling.on("registerAction",this.onRegisterAction,this);return this};YAHOO.extend(Alfresco.DocListToolbar,Alfresco.component.Base);YAHOO.lang.augmentProto(Alfresco.DocListToolbar,Alfresco.doclib.Actions);YAHOO.lang.augmentObject(Alfresco.DocListToolbar.prototype,{options:{siteId:null,containerId:"documentLibrary",groupActivitiesAt:5,hideNavBar:false,googleDocsEnabled:false,repositoryBrowsing:true,useTitle:true},currentPath:"",currentFilter:null,fileUpload:null,selectedFiles:null,folderDetailsUrl:null,dynamicControls:null,doclistMetadata:null,onReady:function p(){this.widgets.createContent=Alfresco.util.createYUIButton(this,"createContent-button",this.onCreateContent,{type:"menu",menu:"createContent-menu",lazyloadmenu:false,disabled:true,value:"CreateChildren"});var J=this.widgets.createContent.getMenu().getSubmenus(),I=J.length>0?J[0]:null;if(I){I.subscribe("beforeShow",this.onCreateByTemplateNodeBeforeShow,this,true);I.subscribe("click",this.onCreateByTemplateNodeClick,this,true)}this.dynamicControls.push(this.widgets.createContent);this.widgets.newFolder=Alfresco.util.createYUIButton(this,"newFolder-button",this.onNewFolder,{disabled:true,value:"CreateChildren"});this.dynamicControls.push(this.widgets.newFolder);this.widgets.fileUpload=Alfresco.util.createYUIButton(this,"fileUpload-button",this.onFileUpload,{disabled:true,value:"CreateChildren"});this.dynamicControls.push(this.widgets.fileUpload);this.widgets.selectedItems=Alfresco.util.createYUIButton(this,"selectedItems-button",this.onSelectedItems,{type:"menu",menu:"selectedItems-menu",lazyloadmenu:false,disabled:true});this.dynamicControls.push(this.widgets.selectedItems);this.widgets.hideNavBar=Alfresco.util.createYUIButton(this,"hideNavBar-button",this.onHideNavBar,{type:"checkbox",checked:this.options.hideNavBar});if(this.widgets.hideNavBar!==null){this.widgets.hideNavBar.set("title",this.msg(this.options.hideNavBar?"button.navbar.show":"button.navbar.hide"));e.setStyle(this.id+"-navBar","display",this.options.hideNavBar?"none":"block");this.dynamicControls.push(this.widgets.hideNavBar)}this.widgets.rssFeed=Alfresco.util.createYUIButton(this,"rssFeed-button",null,{type:"link"});this.dynamicControls.push(this.widgets.rssFeed);this.widgets.folderUp=Alfresco.util.createYUIButton(this,"folderUp-button",this.onFolderUp,{disabled:true,title:this.msg("button.up")});this.dynamicControls.push(this.widgets.folderUp);this.modules.actions=new Alfresco.module.DoclibActions();this.modules.docList=Alfresco.util.ComponentManager.findFirst("Alfresco.DocumentList");this.services.preferences=new Alfresco.service.Preferences();e.setStyle(this.id+"-body","visibility","visible")},onCreateContent:function f(M,L,K){var J=L[1],I=J.element.getElementsByTagName("a")[0];if(J.parent===this.widgets.createContent.getMenu()&&I&&I.nodeName=="A"){I.href=YAHOO.lang.substitute(I.href,{nodeRef:this.doclistMetadata.parent.nodeRef});if(I.href.indexOf("%7BnodeRef%7D")!==-1){I.href=I.href.replace("%7BnodeRef%7D",encodeURIComponent(this.doclistMetadata.parent.nodeRef))}}},onCreateByTemplateNodeBeforeShow:function B(){var I=this.widgets.createContent.getMenu().getSubmenus()[0];if(I.getItems().length==0){I.clearContent();I.addItem(this.msg("label.loading"));I.render();Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"slingshot/doclib/node-templates",successCallback:{fn:function(L,P){var K=L.json.data,O=[],M;for(var N=0,J=K.length;N<J;N++){node=K[N];M=z(node.name);if(node.title&&node.title!==node.name&&this.options.useTitle){M+='<span class="title">('+z(node.title)+")</span>"}O.push({text:'<span title="'+z(node.description)+'">'+M+"</span>",value:node})}if(O.length==0){O.push(this.msg("label.empty"))}I.clearContent();I.addItems(O);I.render()},scope:this}})}},onCreateByTemplateNodeClick:function m(M,L,K){var J=L[1].value,I=this.doclistMetadata.parent.nodeRef;if(J){Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+"slingshot/doclib/node-templates",dataObj:{sourceNodeRef:J.nodeRef,parentNodeRef:I},successCallback:{fn:function(N){YAHOO.Bubbling.fire("nodeCreated",{name:J.name,parentNodeRef:I,highlightFile:N.json.name})}},successMessage:this.msg("message.create-content-by-template-node.success",J.name),failureMessage:this.msg("message.create-content-by-template-node.failure",J.name)})}},onNewFolder:function i(M,P){var O=this.doclistMetadata.parent.nodeRef;var Q=function K(R,S){e.get(S.id+"-dialogTitle").innerHTML=this.msg("label.new-folder.title");e.get(S.id+"-dialogHeader").innerHTML=this.msg("label.new-folder.header")};var I=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&destination={destination}&mode={mode}&submitType={submitType}&formId={formId}&showCancelButton=true",{itemKind:"type",itemId:"cm:folder",destination:O,mode:"create",submitType:"json",formId:"doclib-common"});var L=new Alfresco.module.SimpleDialog(this.id+"-createFolder");L.setOptions({width:"33em",templateUrl:I,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:Q,scope:this},onSuccess:{fn:function N(R){var S=R.config.dataObj.prop_cm_name;YAHOO.Bubbling.fire("folderCreated",{name:S,parentNodeRef:O});Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-folder.success",S)})},scope:this},onFailure:{fn:function J(R){if(R){var S=R.config.dataObj.prop_cm_name;Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-folder.failure",S)})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.failure")})}},scope:this}}).show()},onFileUpload:function u(K,L){if(this.fileUpload===null){this.fileUpload=Alfresco.getFileUploadInstance()}var I={siteId:this.options.siteId,containerId:this.options.containerId,uploadDirectory:this.currentPath,filter:[],mode:this.fileUpload.MODE_MULTI_UPLOAD,thumbnails:"doclib",onFileUploadComplete:{fn:this.onFileUploadComplete,scope:this}};this.fileUpload.show(I);if(YAHOO.lang.isArray(L)&&L[1].tooltip){var J=Alfresco.util.createBalloon(this.fileUpload.uploader.id+"-dialog",{html:L[1].tooltip,width:"30em"});J.show();this.fileUpload.uploader.widgets.panel.hideEvent.subscribe(function(){J.hide()})}},onFileUploadWithTooltip:function v(I,J){this.onFileUpload(I,J)},onFileUploadComplete:function E(I){var M=I.successful.length,J,L;if(M>0){if(M<(this.options.groupActivitiesAt||5)){for(var K=0;K<M;K++){L=I.successful[K];J={fileName:L.fileName,nodeRef:L.nodeRef};this.modules.actions.postActivity(this.options.siteId,"file-added","document-details",J)}}else{J={fileCount:M,path:this.currentPath,parentNodeRef:this.doclistMetadata.parent.nodeRef};this.modules.actions.postActivity(this.options.siteId,"files-added","documentlibrary",J)}}},onSelectedItems:function l(N,M,L){var J=M[0],K=M[1];if(this.modules.docList){var I=Alfresco.util.findEventClass(K);if(I&&(typeof this[I]=="function")){this[I].call(this,this.modules.docList.getSelectedFiles())}}H.preventDefault(J)},onActionDelete:function k(I){var N=this,J=[];for(var M=0,K=I.length;M<K;M++){J.push('<span class="'+(I[M].jsNode.isContainer?"folder":"document")+'">'+z(I[M].displayName)+"</span>")}var Q=this.msg("title.multiple-delete.confirm"),L=this.msg("message.multiple-delete.confirm",I.length);L+='<div class="toolbar-file-list">'+J.join("")+"</div>";Alfresco.util.PopupManager.displayPrompt({title:Q,text:L,noEscape:true,modal:true,buttons:[{text:this.msg("button.delete"),handler:function P(){this.destroy();N._onActionDeleteConfirm.call(N,I)}},{text:this.msg("button.cancel"),handler:function O(){this.destroy()},isDefault:true}]})},_onActionDeleteConfirm:function G(I){var N=[],J,M;for(J=0,M=I.length;J<M;J++){N.push(I[J].jsNode.nodeRef.nodeRef)}var L=function K(S,P){var O;var R=0;if(!S.json.overallSuccess){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.multiple-delete.failure")});return}YAHOO.Bubbling.fire("filesDeleted");for(J=0,M=S.json.totalResults;J<M;J++){O=S.json.results[J];if(O.success){R++;YAHOO.Bubbling.fire(O.type=="folder"?"folderDeleted":"fileDeleted",{multiple:true,nodeRef:O.nodeRef})}}if(Alfresco.util.isValueSet(this.options.siteId)){var Q;if(R>0){if(R<this.options.groupActivitiesAt){for(J=0;J<R;J++){Q={fileName:S.json.results[J].id,nodeRef:S.json.results[J].nodeRef,path:this.currentPath};this.modules.actions.postActivity(this.options.siteId,"file-deleted","documentlibrary",Q)}}else{Q={fileCount:R,path:this.currentPath,parentNodeRef:this.doclistMetadata.parent.nodeRef};this.modules.actions.postActivity(this.options.siteId,"files-deleted","documentlibrary",Q)}}}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.multiple-delete.success",R)})};this.modules.actions.genericAction({success:{callback:{fn:L,scope:this,obj:I}},failure:{message:this.msg("message.multiple-delete.failure")},webscript:{method:Alfresco.util.Ajax.DELETE,name:"files"},wait:{message:this.msg("message.multiple-delete.please-wait")},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{nodeRefs:N}}})},onActionDeselectAll:function h(){if(this.modules.docList){this.modules.docList.selectFiles("selectNone")}},onHideNavBar:function d(I,J){this.options.hideNavBar=this.widgets.hideNavBar.get("checked");this.widgets.hideNavBar.set("title",this.msg(this.options.hideNavBar?"button.navbar.show":"button.navbar.hide"));e.setStyle(this.id+"-navBar","display",this.options.hideNavBar?"none":"block");this.services.preferences.set(D,this.options.hideNavBar);if(I){H.preventDefault(I)}},onFolderUp:function g(K,L){var J=this.currentPath.substring(0,this.currentPath.lastIndexOf("/")),I=this.currentFilter;I.filterData=J;YAHOO.Bubbling.fire("changeFilter",I);H.preventDefault(K)},onFilterChanged:function t(M,N){var K=N[1];if(K&&(typeof K.filterId!=="undefined")){K.filterOwner=K.filterOwner||Alfresco.util.FilterManager.getOwner(K.filterId);if(K.filterOwner){if(this.currentFilter.filterOwner!=K.filterOwner||this.currentFilter.filterId!=K.filterId){var R=K.filterOwner.split(".")[1],Q=R+"_"+K.filterId;var O=YAHOO.util.Selector.query("div.hideable",e.get(this.id)),I;for(var L=0,J=O.length;L<J;L++){I=O[L];if(e.hasClass(I,R)||e.hasClass(I,Q)){e.removeClass(I,"toolbar-hidden")}else{e.addClass(I,"toolbar-hidden")}}}}Alfresco.logger.debug("DLTB_onFilterChanged","Old Filter",this.currentFilter);this.currentFilter=Alfresco.util.cleanBubblingObject(K);Alfresco.logger.debug("DLTB_onFilterChanged","New Filter",this.currentFilter);if(this.currentFilter.filterId=="path"||this.currentFilter.filterId=="category"){this.currentPath=q("/",this.currentFilter.filterData);this._generateBreadcrumb();var P=this.currentPath.split("/");if(this.currentPath==="/"){P=["/"]}this.widgets.folderUp.set("disabled",P.length<2)}else{this._generateDescription()}this._generateRSSFeedUrl()}},onDeactivateAllControls:function c(K,J){var I,L=Alfresco.util.disableYUIButton;for(I in this.widgets){if(this.widgets.hasOwnProperty(I)){L(this.widgets[I])}}},onDeactivateDynamicControls:function w(K,J){var I,L=Alfresco.util.disableYUIButton;for(I in this.dynamicControls){if(this.dynamicControls.hasOwnProperty(I)){L(this.dynamicControls[I])}}},onUserAccess:function b(O,Q){var J=function R(ab,T){var Z,ae,ad,X,aa=false,S,V;if(ab instanceof YAHOO.widget.MenuItem&&ab.element.firstChild){aa=true;Z=ab.element.firstChild.rel;S=Alfresco.util.bind(ab.cfg.setProperty,ab.cfg,"className","");V=Alfresco.util.bind(ab.cfg.setProperty,ab.cfg,"className","hidden")}else{Z=ab.get("value");S=Alfresco.util.bind(ab.set,ab,"disabled",false);V=Alfresco.util.bind(ab.set,ab,"disabled",true)}S();if(typeof Z=="string"&&Z!==""){ae=Z.split(",");for(var W=0,ac=ae.length;W<ac;W++){if(ae[W].indexOf("|")!==-1){X=false;ad=ae[W].split("|");for(var U=0,Y=ad.length;U<Y;U++){if(T[ad[U]]){X=true;if(!aa){ab.set("activePermission",ad[U],true)}break}}if(!X){V();break}}else{if(!T[ae[W]]){V();break}}}}};var L=Q[1];if(L&&L.userAccess){if(this.options.googleDocsEnabled){L.userAccess["create-google-doc"]=true}var M,P,I;for(P in this.widgets){if(this.widgets.hasOwnProperty(P)){M=this.widgets[P];if(M.get("srcelement").className!="no-access-check"){J(M,L.userAccess);if(M.getMenu()!==null){I=M.getMenu().getItems();for(var K=0,N=I.length;K<N;K++){J(I[K],L.userAccess)}}}}}}},onSelectedFilesChanged:function A(aa,K){if(this.modules.docList){var O=this.modules.docList.getSelectedFiles(),J=[],Y,L,Z={},X,P,ab=this.widgets.selectedItems.getMenu().getItems(),N,I,Q,S,M,U,R,T,W;var V=function V(ac){return(ac.isContainer?"folder":"document")};for(U=0,R=O.length;U<R;U++){Y=O[U];X=Y.node.permissions.user;for(P in X){if(X.hasOwnProperty(P)){Z[P]=(Z[P]===undefined?X[P]:Z[P]&&X[P])}}L=V(Y);if(!(L in J)){J[L]=true;J.push(L)}}for(P in ab){if(ab.hasOwnProperty(P)){N=ab[P];M=false;if(N.element.firstChild){if(N.element.firstChild.rel&&N.element.firstChild.rel!==""){I=N.element.firstChild.rel.split(",");for(U=0,R=I.length;U<R;U++){if(!Z[I[U]]){M=true;break}}}if(!M){if(N.element.firstChild.type&&N.element.firstChild.type!==""){Q=N.element.firstChild.type.split("|");for(U=0;U<Q.length;U++){S=Alfresco.util.arrayToObject(Q[U].split(","));for(T=0,W=J.length;T<W;T++){if(!(J[T] in S)){Q.splice(U,1);--U;break}}}M=(Q.length===0)}}N.cfg.setProperty("disabled",M)}}}this.widgets.selectedItems.set("disabled",(O.length===0))}},onDoclistMetadata:function F(J,I){var K=I[1];this.folderDetailsUrl=null;if(K&&K.metadata){this.doclistMetadata=Alfresco.util.deepCopy(K.metadata);if(K.metadata.parent&&K.metadata.parent.nodeRef){this.folderDetailsUrl=C("folder-details?nodeRef="+K.metadata.parent.nodeRef)}}},onDropTargetOwnerRequest:function o(M,N){if(N&&N[1]&&N[1].elementId){var P=e.get(N[1].elementId);var I=e.get(this.id+"-breadcrumb");if(e.isAncestor(I,P)){var J="";var Q=this.currentPath.split("/");for(var L=0,K=I.children.length;L<K;L++){if(L%2==0){J=J+"/"+Q[L/2]}if(P==I.children[L]){break}}var O=this.doclistMetadata.container+J;N[1].callback.call(N[1].scope,O,J)}}},onDocumentDragOver:function s(L,K){if(K&&K[1]&&K[1].elementId){var J=e.get(K[1].elementId);var I=e.get(this.id+"-breadcrumb");if(e.isAncestor(I,J)){e.addClass(J,"documentDragOverHighlight");var N=e.getFirstChild(J);if(N!=null&&N.tagName!="SPAN"){var M=document.createElement("span");e.addClass(M,"documentDragOverArrow");e.insertBefore(M,N)}}}},onDocumentDragOut:function n(L,K){if(K&&K[1]&&K[1].elementId){var J=e.get(K[1].elementId);var I=e.get(this.id+"-breadcrumb");if(e.isAncestor(I,J)){e.removeClass(J,"documentDragOverHighlight");var M=e.getFirstChild(J);if(M!=null&&M.tagName=="SPAN"){J.removeChild(M)}}}},_generateBreadcrumb:function a(){var P=e.get(this.id+"-breadcrumb");if(P===null){return}P.innerHTML="";var X=this.currentPath.split("/");if(this.currentPath==="/"){X=["/"]}var Q=this,S=X.concat();S[0]=Alfresco.util.message("node.root",this.currentFilter.filterOwner);var R=function J(aa,Z){e.addClass(aa.target.parentNode,"highlighted");H.stopEvent(aa)};var Y=function M(ab,aa){var Z=Q.currentFilter;Z.filterData=aa;YAHOO.Bubbling.fire("changeFilter",Z);H.stopEvent(ab)};var V=new y(P),N,O,I,W;for(var L=0,K=X.length;L<K;++L){N=X.slice(0,L+1).join("/");O=new y(document.createElement("div"));O.addClass("crumb");O.addClass("documentDroppable");O.addClass("documentDroppableHighlights");if(L>0){I=new y(document.createElement("a"),{href:"#",innerHTML:"&nbsp;"});I.on("click",Y,N);I.addClass("icon");I.addClass("filter-"+z(this.currentFilter.filterId));O.appendChild(I)}if(K-L<2){W=new y(document.createElement("span"),{innerHTML:(this.folderDetailsUrl)?'<a href="'+this.folderDetailsUrl+'">'+z(S[L])+"</a>":z(S[L])});W.addClass("label");O.appendChild(W);V.appendChild(O)}else{W=new y(document.createElement("a"),{href:"",innerHTML:z(S[L])});W.addClass("folder");W.on("click",Y,N);O.appendChild(W);V.appendChild(O);V.appendChild(new y(document.createElement("div"),{innerHTML:"&gt;",className:"separator"}))}}var U=e.get(this.id+"-breadcrumb");var T=e.getElementsByClassName("crumb","div",U);for(var L=0,K=T.length;L<K;L++){new YAHOO.util.DDTarget(T[L])}},_generateDescription:function j(){var K,N,J,I,L;K=e.get(this.id+"-description");if(K===null){return}while(K.hasChildNodes()){K.removeChild(K.lastChild)}L=typeof this.currentFilter.filterDisplay!=="undefined"?this.currentFilter.filterDisplay:(this.currentFilter.filterData||"");J=new y(document.createElement("div"),{innerHTML:this.msg("description."+this.currentFilter.filterId,L)});J.addClass("message");var O="description."+this.currentFilter.filterId+".more",M=O+".filterDisplay";if(L!==""&&this.msg(M)!==M){O=M}I=new y(document.createElement("span"),{innerHTML:this.msg(O,z(L))});I.addClass("more");J.appendChild(I);N=new y(K);N.appendChild(J)},_generateRSSFeedUrl:function r(){if(this.widgets.rssFeed&&this.modules.docList){var I=YAHOO.lang.substitute("{type}/site/{site}/{container}{path}",{type:this.modules.docList.options.showFolders?"all":"documents",site:encodeURIComponent(this.options.siteId),container:encodeURIComponent(this.options.containerId),path:Alfresco.util.encodeURIPath(this.currentPath)});I+="?filter="+encodeURIComponent(this.currentFilter.filterId);if(this.currentFilter.filterData){I+="&filterData="+encodeURIComponent(this.currentFilter.filterData)}I+="&format=rss";this.widgets.rssFeed.set("href",Alfresco.constants.URL_FEEDSERVICECONTEXT+"components/documentlibrary/feed/"+I);Alfresco.util.enableYUIButton(this.widgets.rssFeed)}}},true)})();