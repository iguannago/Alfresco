(function(){var b=YAHOO.util.Dom,n=YAHOO.util.Element,i=YAHOO.util.KeyListener;var o=Alfresco.util.encodeHTML;Alfresco.DNDUpload=function(y){Alfresco.DNDUpload.superclass.constructor.call(this,"Alfresco.DNDUpload",y,["button","container","datatable","datasource"]);this.fileStore={};this.addedFiles={};this.defaultShowConfig={files:[],siteId:null,containerId:null,destination:null,uploadDirectory:null,updateNodeRef:null,updateFilename:null,updateVersion:"1.0",mode:this.MODE_SINGLE_UPLOAD,filter:[],onFileUploadComplete:null,overwrite:false,thumbnails:null,uploadURL:null,username:null,suppressRefreshEvent:false};this.suppliedConfig={};this.showConfig={};this.fileItemTemplates={};if(typeof FormData!=="undefined"){this.uploadMethod=this.FORMDATA_UPLOAD}else{this.uploadMethod=this.INMEMORY_UPLOAD}return this};YAHOO.extend(Alfresco.DNDUpload,Alfresco.component.Base,{contentReady:false,FORMDATA_UPLOAD:1,INMEMORY_UPLOAD:2,uploadMethod:2,STATE_BROWSING:1,STATE_UPLOADING:2,STATE_FINISHED:3,STATE_FAILURE:4,STATE_SUCCESS:5,state:1,fileStore:null,noOfSuccessfulUploads:0,noOfFailedUploads:0,aggregateUploadTargetSize:0,aggregateUploadCurrentSize:0,addedFiles:null,MODE_SINGLE_UPLOAD:1,MODE_SINGLE_UPDATE:2,MODE_MULTI_UPLOAD:3,defaultShowConfig:null,suppliedConfig:null,showConfig:null,panel:null,dataTable:null,titleText:null,statusText:null,aggregateProgressText:null,aggregateDataWrapper:null,minorVersion:null,description:null,versionSection:null,fileItemTemplates:null,_inMemoryLimit:250000000,setInMemoryLimit:function p(y){if(isNaN(y)){Alfresco.logger.warn('Non-numerical value set for "in-memory-limit" in share-documentlibrary.xml: ',y);this._inMemoryLimit=25000000}else{this._inMemoryLimit=y}},getInMemoryLimit:function j(){return this._inMemoryLimit},onReady:function w(){b.removeClass(this.id+"-dialog","hidden");this.panel=Alfresco.util.createYUIPanel(this.id+"-dialog");this.panel.hideEvent.subscribe(this.onCancelOkButtonClick,null,this);this.fileItemTemplates.left=b.get(this.id+"-left-div");this.fileItemTemplates.center=b.get(this.id+"-center-div");this.fileItemTemplates.right=b.get(this.id+"-right-div");this._createEmptyDataTable();this.titleText=b.get(this.id+"-title-span");this.statusText=b.get(this.id+"-status-span");this.aggregateProgressText=b.get(this.id+"-aggregate-status-span");this.aggregateDataWrapper=b.get(this.id+"-aggregate-data-wrapper");this.description=b.get(this.id+"-description-textarea");this.minorVersion=b.get(this.id+"-minorVersion-radioButton");this.versionSection=b.get(this.id+"-versionSection-div");this.widgets.cancelOkButton=Alfresco.util.createYUIButton(this,"cancelOk-button",this.onCancelOkButtonClick);this.widgets.escapeListener=new i(document,{keys:i.KEY.ESCAPE},{fn:this.onCancelOkButtonClick,scope:this,correctScope:true})},show:function a(A){var F=this;this.suppliedConfig=A;this.showConfig=YAHOO.lang.merge(this.defaultShowConfig,A);if(!this.showConfig.uploadDirectory&&!this.showConfig.updateNodeRef&&!this.showConfig.destination){throw new Error("An updateNodeRef, uploadDirectory or destination must be provided")}if(this.showConfig.files==undefined){throw new Error("An array of files to upload must be provided")}if(this.showConfig.uploadDirectory!==null&&this.showConfig.uploadDirectory.length===0){this.showConfig.uploadDirectory="/"}this._resetGUI();this._applyConfig();var E=false,D,z;var y=this.showConfig.files,C=0;for(var B=0;B<y.length;B++){C+=y[B].size}this.aggregateUploadTargetSize=C;this.recursiveUpload(0,this.showConfig.files.length,this)},recursiveUpload:function e(G,J,M){var I;if(G<J){var A="file"+G;try{var E=function K(R){Alfresco.logger.debug("File upload progress update received",R);if(R.lengthComputable){try{var N=Math.round((R.loaded*100)/R.total),P=M.fileStore[A];P.progressPercentage.innerHTML=N+"%";var Q=(-400+((N/100)*400));b.setStyle(P.progress,"left",Q+"px");M._updateAggregateProgress(P,R.loaded);P.lastProgress=R.loaded}catch(O){Alfresco.logger.error("The following error occurred processing an upload progress event: ",O)}}else{Alfresco.logger.debug("File upload progress not computable",R)}};var H=function B(Q){try{Alfresco.logger.debug("File upload completion notification received",Q);var O=M.fileStore[A];if(O.request.readyState!=4){O.request.onreadystatechange=function P(){if(O.request.readyState==4){M._processUploadCompletion(O)}}}else{M._processUploadCompletion(O)}}catch(N){Alfresco.logger.error("The following error occurred processing an upload completion event: ",N)}};var F=function L(P){try{var O=M.fileStore[A];if(O.state!==M.STATE_FAILURE){M._processUploadFailure(O,event.status)}}catch(N){Alfresco.logger.error("The following error occurred processing an upload failure event: ",N)}};var D=M.showConfig.files[G].name;if(this.showConfig.files[G].size===0){Alfresco.util.PopupManager.displayMessage({text:M.msg("message.zeroByteFileSelected",D)})}else{if(!Alfresco.forms.validation.nodeName({id:"file",value:D},null,null,null,true)){Alfresco.util.PopupManager.displayMessage({text:M.msg("message.illegalCharacters")})}else{var C=new XMLHttpRequest();C.upload._fileData=A;C.upload.addEventListener("progress",E,false);C.upload.addEventListener("load",H,false);C.upload.addEventListener("error",F,false);data={id:A,name:D,size:M.showConfig.files[G].size};var y={filedata:M.showConfig.files[G],filename:D,destination:M.showConfig.destination,siteId:M.showConfig.siteId,containerId:M.showConfig.containerId,uploaddirectory:M.showConfig.uploadDirectory};M.fileStore[A]={state:M.STATE_UPLOADING,fileName:D,nodeRef:null,uploadData:y,request:C};M.dataTable.addRow(data);M.addedFiles[I]=M._getUniqueFileToken(data);displayDialog=true}}if(displayDialog){M.widgets.escapeListener.enable();M.panel.setFirstLastFocusable();M.panel.show()}}catch(z){Alfresco.logger.error("DNDUpload_show: The following exception occurred processing a file to upload: ",z)}M.recursiveUpload(G+1,J,M)}},_processUploadCompletion:function h(z){if(z.request.status=="200"){var y=Alfresco.util.parseJSON(z.request.responseText);z.nodeRef=y.nodeRef;z.fileName=y.fileName;z.state=this.STATE_SUCCESS;b.addClass(z.progressStatusIncomplete,"hidden");b.removeClass(z.progressStatusComplete,"hidden");b.removeClass(z.progress,"fileupload-progressSuccess-span");b.addClass(z.progress,"fileupload-progressFinished-span");b.setStyle(z.progress,"left",0+"px");z.progressPercentage.innerHTML="100%";this.noOfSuccessfulUploads++;this._updateAggregateProgress(z,z.uploadData.filedata.size);this._updateStatus();this._adjustGuiIfFinished()}else{this._processUploadFailure(z,z.request.status)}},_processUploadFailure:function r(A,y){A.state=this.STATE_FAILURE;var z="label.failure."+y,B=Alfresco.util.message(z,this.name);if(B==z){B=Alfresco.util.message("label.failure",this.name)}A.fileSizeInfo.innerHTML=A.fileSizeInfo.innerHTML+" ("+B+")";A.progressInfoCell.setAttribute("title",B);b.removeClass(A.progress,"fileupload-progressSuccess-span");b.addClass(A.progress,"fileupload-progressFailure-span");b.setStyle(A.progress,"left",0+"px");this._updateAggregateProgress(A,A.uploadData.filedata.size);this.noOfFailedUploads++;this._updateStatus();this._adjustGuiIfFinished()},_updateAggregateProgress:function s(A,z){this.aggregateUploadCurrentSize-=A.lastProgress;this.aggregateUploadCurrentSize+=z;var y=(this.aggregateUploadCurrentSize/this.aggregateUploadTargetSize);var B=(-620+(y*620));b.setStyle(this.id+"-aggregate-progress-span","left",B+"px")},_resetGUI:function t(){this.state=this.STATE_UPLOADING;this.noOfFailedUploads=0;this.noOfSuccessfulUploads=0;this.statusText.innerHTML="&nbsp;";this.description.value="";this.minorVersion.checked=true;this.widgets.cancelOkButton.set("label",this.msg("button.cancel"));this.widgets.cancelOkButton.set("disabled",false);this.aggregateUploadTargetSize=0;this.aggregateUploadCurrentSize=0;b.setStyle(this.id+"-aggregate-progress-span","left","-620px");b.removeClass(this.aggregateDataWrapper,"hidden")},onPostRenderEvent:function l(y){if(this.dataTable.getRecordSet().getLength()>0){this.panel.setFirstLastFocusable();this.panel.focusFirst()}},onRowAddEvent:function v(y){try{var z=Alfresco.constants.PROXY_URI+"api/upload";var D=y.record.getData();var F=this.fileStore[D.id];F.lastProgress=0;if(this.uploadMethod===this.FORMDATA_UPLOAD){Alfresco.logger.debug("Using FormData for file upload");var C=new FormData;C.append("filedata",F.uploadData.filedata);C.append("filename",F.uploadData.filename);C.append("destination",F.uploadData.destination);C.append("siteId",F.uploadData.siteId);C.append("containerId",F.uploadData.containerId);C.append("uploaddirectory",F.uploadData.uploaddirectory);F.request.open("POST",z,true);F.request.send(C)}else{if(this.uploadMethod===this.INMEMORY_UPLOAD){Alfresco.logger.debug("Using custom multipart upload");var E="----AlfrescoCustomMultipartBoundary"+(new Date).getTime();var G="\r\n";var B="--"+E;B+=G+'Content-Disposition: form-data; name="filedata"; filename="'+unescape(encodeURIComponent(F.uploadData.filename))+'"';B+=G+"Content-Type: image/png";B+=G+G+F.uploadData.filedata.getAsBinary()+G+"--"+E;B+=G+'Content-Disposition: form-data; name="filename"';B+=G+G+unescape(encodeURIComponent(F.uploadData.filename))+G+"--"+E;B+=G+'Content-Disposition: form-data; name="destination"';if(F.uploadData.destination!==null){B+=G+G+unescape(encodeURIComponent(F.uploadData.destination))+G+"--"+E}else{B+=G+G+G+"--"+E}B+=G+'Content-Disposition: form-data; name="siteId"';B+=G+G+unescape(encodeURIComponent(F.uploadData.siteId))+G+"--"+E;B+=G+'Content-Disposition: form-data; name="containerId"';B+=G+G+unescape(encodeURIComponent(F.uploadData.containerId))+G+"--"+E;B+=G+'Content-Disposition: form-data; name="uploaddirectory"';B+=G+G+unescape(encodeURIComponent(F.uploadData.uploaddirectory))+G+"--"+E+"--";F.request.open("POST",z,true);F.request.setRequestHeader("Content-Type","multipart/form-data; boundary="+E);F.request.sendAsBinary(B)}}this._updateAggregateStatus()}catch(A){Alfresco.logger.error("The following error occurred initiating upload: "+A)}},onCancelOkButtonClick:function x(){var A,z;if(this.state===this.STATE_UPLOADING){this._cancelAllUploads();var y=0;for(z in this.fileStore){if(this.fileStore[z]&&this.fileStore[z].state===this.STATE_SUCCESS){y++}}if(y>0){A=YAHOO.lang.substitute(this.msg("message.cancelStatus"),{"0":y})}if(!this.showConfig.suppressRefreshEvent){YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path})}}else{if(this.state===this.STATE_FINISHED){var C=null,B;for(z in this.fileStore){B=this.fileStore[z];if(B&&B.state===this.STATE_SUCCESS){C=B.fileName;break}}if(!this.showConfig.suppressRefreshEvent){if(C){YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path,highlightFile:C})}else{YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path})}}}}this._clear();this.panel.hide();this.widgets.escapeListener.disable();if(A){Alfresco.util.PopupManager.displayPrompt({text:A})}},_applyConfig:function g(){var D="",B=this.showConfig.files.length==1?"header.singleUpload":"header.multiUpload",A=this.showConfig.uploadDirectoryName==""?this.msg("label.documents"):this.showConfig.uploadDirectoryName;this.titleText.innerHTML=this.msg(B,'<img src="'+Alfresco.constants.URL_RESCONTEXT+'components/documentlibrary/images/folder-open-16.png" class="title-folder" />'+o(A));if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){b.removeClass(this.versionSection,"hidden");var z=(this.showConfig.updateVersion||"1.0").split("."),y=parseInt(z[0],10),C=parseInt(z[1],10);b.get(this.id+"-minorVersion").innerHTML=this.msg("label.minorVersion.more",y+"."+(1+C));b.get(this.id+"-majorVersion").innerHTML=this.msg("label.majorVersion.more",(1+y)+".0")}else{b.addClass(this.versionSection,"hidden")}if(this.showConfig.mode===this.MODE_MULTI_UPLOAD){b.removeClass(this.statusText,"hidden");this.dataTable.set("height","204px",true)}else{b.addClass(this.statusText,"hidden");this.dataTable.set("height","40px")}},_createEmptyDataTable:function q(){var y=this;var z=function(G,H,I,J){try{y._formatCellElements(G,H,y.fileItemTemplates.left)}catch(F){Alfresco.logger.error("DNDUpload__createEmptyDataTable (formatLeftCell): The following error occurred: ",F)}};var E=function(G,H,I,J){try{y._formatCellElements(G,H,y.fileItemTemplates.center)}catch(F){Alfresco.logger.error("DNDUpload__createEmptyDataTable (formatCenterCell): The following error occurred: ",F)}};var C=function(G,H,I,J){try{y._formatCellElements(G,H,y.fileItemTemplates.right)}catch(F){Alfresco.logger.error("DNDUpload__createEmptyDataTable (formatRightCell): The following error occurred: ",F)}};this._formatCellElements=function(G,S,Q){var N=S.getData(),I=N.id;var R=new n(G);var K=Q.cloneNode(true);K.setAttribute("id",K.getAttribute("id")+I);var F=b.getElementsByClassName("fileupload-progressSuccess-span","span",K);if(F.length==1){this.fileStore[I].progress=F[0]}var O=b.getElementsByClassName("fileupload-progressInfo-span","span",K);if(O.length==1){var H=N.name;K.setAttribute("title",H);O=O[0];this.fileStore[I].progressInfo=O;this.fileStore[I].progressInfo.innerHTML=H;this.fileStore[I].progressInfoCell=G}var J=b.getElementsByClassName("fileupload-filesize-span","span",K);if(J.length==1){var H=Alfresco.util.formatFileSize(N.size);J=J[0];this.fileStore[I].fileSizeInfo=J;J.innerHTML=H}var P=b.getElementsByClassName("fileupload-contentType-select","select",K);if(P.length==1){this.fileStore[I].contentType=P[0]}else{P=b.getElementsByClassName("fileupload-contentType-input","input",K);if(P.length==1){this.fileStore[I].contentType=P[0]}}var M=b.getElementsByClassName("fileupload-percentage-span","span",K);if(M.length==1){this.fileStore[I].progressPercentage=M[0]}var L=b.getElementsByClassName("fileupload-status-img","img",K);if(L.length==2){this.fileStore[I].progressStatusIncomplete=L[0];this.fileStore[I].progressStatusComplete=L[1]}R.appendChild(K)};var D=[{key:"id",className:"col-left",resizable:false,formatter:z},{key:"name",className:"col-center",resizable:false,formatter:E},{key:"created",className:"col-right",resizable:false,formatter:C}];var B=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});YAHOO.widget.DataTable._bStylesheetFallback=!!YAHOO.env.ua.ie;var A=b.get(this.id+"-filelist-table");this.dataTable=new YAHOO.widget.DataTable(A,D,B,{scrollable:true,height:"100px",width:"620px",renderLoopSize:1,MSG_EMPTY:this.msg("label.noFiles")});this.dataTable.subscribe("postRenderEvent",this.onPostRenderEvent,this,true);this.dataTable.subscribe("rowAddEvent",this.onRowAddEvent,this,true)},_getUniqueFileToken:function f(y){return y.name+":"+y.size},_updateStatus:function c(){if(this.noOfFailedUploads>0){this.statusText.innerHTML=YAHOO.lang.substitute(this.msg("label.uploadStatus.withFailures"),{"0":this.noOfSuccessfulUploads,"1":this.dataTable.getRecordSet().getLength(),"2":this.noOfFailedUploads})}else{this.statusText.innerHTML=YAHOO.lang.substitute(this.msg("label.uploadStatus"),{"0":this.noOfSuccessfulUploads,"1":this.dataTable.getRecordSet().getLength()})}},_updateAggregateStatus:function m(){this.aggregateProgressText.innerHTML=YAHOO.lang.substitute(this.msg("label.aggregateUploadStatus"),{"0":this.dataTable.getRecordSet().getLength(),"1":Alfresco.util.formatFileSize(this.aggregateUploadTargetSize)})},_adjustGuiIfFinished:function d(){try{var B={successful:[],failed:[]};var A=null;for(var z in this.fileStore){A=this.fileStore[z];if(A){if(A.state==this.STATE_SUCCESS){B.successful.push({fileName:A.fileName,nodeRef:A.nodeRef})}else{if(A.state==this.STATE_FAILURE){B.failed.push({fileName:A.fileName})}else{return}}}}this.state=this.STATE_FINISHED;b.addClass(this.aggregateDataWrapper,"hidden");this.widgets.cancelOkButton.set("label",this.msg("button.ok"));this.widgets.cancelOkButton.focus();var C=this.showConfig.onFileUploadComplete;if(C&&typeof C.fn=="function"){C.fn.call((typeof C.scope=="object"?C.scope:this),B,C.obj)}}catch(y){Alfresco.logger.error("_adjustGuiIfFinished",y)}},_cancelAllUploads:function k(){var C=this.dataTable.getRecordSet().getLength();for(var B=0;B<C;B++){var z=this.dataTable.getRecordSet().getRecord(B);var y=z.getData("id");var A=this.fileStore[y];if(A.state===this.STATE_UPLOADING){Alfresco.logger.debug("Aborting upload of file: "+A.fileName);A.request.abort()}}},_clear:function u(){var y=this.dataTable.getRecordSet().getLength();this.addedFiles={};this.fileStore={};this.dataTable.deleteRows(0,y)}})})();