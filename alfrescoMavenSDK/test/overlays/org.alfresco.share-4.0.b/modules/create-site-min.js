(function(){var g=YAHOO.util.Dom,l=YAHOO.util.Event,c=YAHOO.util.Element,b=YAHOO.util.KeyListener;Alfresco.module.CreateSite=function(o){var n=Alfresco.util.ComponentManager.get(this.id);if(n!==null){throw new Error("An instance of Alfresco.module.CreateSite already exists.")}Alfresco.module.CreateSite.superclass.constructor.call(this,"Alfresco.module.CreateSite",o,["button","container","connection","selector","json"]);return this};YAHOO.extend(Alfresco.module.CreateSite,Alfresco.component.Base,{show:function f(){if(this.widgets.panel){this._showPanel()}else{Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/create-site",dataObj:{htmlid:this.id},successCallback:{fn:this.onTemplateLoaded,scope:this},execScripts:true,failureMessage:"Could not load create site template"})}},onTemplateLoaded:function i(o){var v=document.createElement("div");v.innerHTML=o.serverResponse.responseText;var p=g.getFirstChild(v);this.widgets.panel=Alfresco.util.createYUIPanel(p);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok-button",null,{type:"submit"});this.widgets.siteVisibility=g.get(this.id+"-visibility");this.widgets.isPublic=g.get(this.id+"-isPublic");this.widgets.isModerated=g.get(this.id+"-isModerated");this.widgets.isPrivate=g.get(this.id+"-isPrivate");l.addListener(this.widgets.isPublic,"focus",this.onVisibilityChange,this.widgets.isPublic,this);l.addListener(this.widgets.isPrivate,"focus",this.onVisibilityChange,this.widgets.isPrivate,this);var q=new Alfresco.forms.Form(this.id+"-form");this.widgets.balloons={};var r=g.get(this.id+"-title"),s=g.get(this.id+"-shortName");q.addValidation(r,Alfresco.forms.validation.mandatory,null,"keyup",this.msg("validation-hint.mandatory"));q.addValidation(r,Alfresco.forms.validation.length,{max:256,crop:true},"keyup");l.addListener(r,"keyup",function n(){if(!this.shortNameEdited){s.value=this.safeURL(r.value).substring(0,72)}},this,true);this.widgets.balloons[this.id+"-title"]=Alfresco.util.createBalloon(r);l.addListener(r,"blur",function y(){if(this.widgets.balloons[this.id+"-title"]){this.widgets.balloons[this.id+"-title"].hide()}},this,true);this.shortNameEdited=false;q.addValidation(s,Alfresco.forms.validation.mandatory,null,"keyup",this.msg("validation-hint.mandatory"));q.addValidation(s,Alfresco.forms.validation.regexMatch,{pattern:/^[ ]*[0-9a-zA-Z\-]+[ ]*$/},"keyup",this.msg("validation-hint.siteName"));q.addValidation(s,Alfresco.forms.validation.length,{max:72,crop:true},"keyup");l.addListener(s,"keyup",function u(){this.shortNameEdited=s.value.length>0},this,true);this.widgets.balloons[this.id+"-shortName"]=Alfresco.util.createBalloon(s);l.addListener(s,"blur",function t(){if(this.widgets.balloons[this.id+"-shortName"]){this.widgets.balloons[this.id+"-shortName"].hide()}},this,true);q.addValidation(this.id+"-description",Alfresco.forms.validation.length,{max:512,crop:true},"keyup");var x=this;q.addError=function w(B,A){if(x.widgets.panel.cfg.getProperty("visible")){var z=x.widgets.balloons[A.id];if(z){z.html(B);z.show()}}};q.setShowSubmitStateDynamically(true,true);q.setSubmitElements(this.widgets.okButton);q.doBeforeFormSubmit={fn:function(){var A=g.get(this.id+"-form");A.attributes.action.nodeValue=Alfresco.constants.URL_SERVICECONTEXT+"modules/create-site";this.widgets.okButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true);var z="PUBLIC";if(this.widgets.isPublic.checked){if(this.widgets.isModerated.checked){z="MODERATED"}}else{z="PRIVATE"}this.widgets.siteVisibility.value=z;this.widgets.panel.hide();this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.creating",this.name),spanClass:"wait",displayTime:0})},obj:null,scope:this};q.setAJAXSubmit(true,{successCallback:{fn:this.onCreateSiteSuccess,scope:this},failureCallback:{fn:this.onCreateSiteFailure,scope:this}});q.setSubmitAsJSON(true);q.applyTabFix();q.init();this._showPanel()},safeURL:function k(n){n=YAHOO.lang.trim(n.replace(/[^0-9a-zA-Z\-\s]/g,""));n=n.replace(/\s+/g,"-").toLowerCase();return n},onVisibilityChange:function a(o,n){new c(this.widgets.isModerated).set("disabled",n==this.widgets.isPrivate)},onCancelButtonClick:function d(p,o){for(var n in this.widgets.balloons){if(this.widgets.balloons.hasOwnProperty(n)){this.widgets.balloons[n].hide()}}try{g.get(this.id+"-title").value="";g.get(this.id+"-shortName").value="";g.get(this.id+"-description").value="";g.get(this.id+"-sitePreset").setSelectedIndex=0;g.get(this.id+"-isPublic").checked="checked";g.get(this.id+"-isModerated").checked=""}catch(q){}this.widgets.panel.hide()},onCreateSiteSuccess:function e(o){if(o.json!==undefined&&o.json.success){var p=new Alfresco.service.Preferences(),n=o.config.dataObj.shortName;p.set(Alfresco.service.Preferences.FAVOURITE_SITES+"."+n,true,{successCallback:{fn:function q(){document.location.href=Alfresco.constants.URL_PAGECONTEXT+"site/"+n+"/dashboard"}}})}else{this._adjustGUIAfterFailure(o)}},onCreateSiteFailure:function h(n){this._adjustGUIAfterFailure(n)},_adjustGUIAfterFailure:function m(n){this.widgets.feedbackMessage.destroy();this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);this.widgets.panel.show();var p=Alfresco.util.message("message.failure",this.name);if(n.serverResponse.status===500){p=Alfresco.util.message("error.duplicateShortName",this.name)}else{if(n.json.message){var o=Alfresco.util.message(n.json.message,this.name);p=o?o:p}}Alfresco.util.PopupManager.displayPrompt({title:Alfresco.util.message("message.failure",this.name),text:p})},_showPanel:function j(){this.widgets.panel.show();Alfresco.util.caretFix(this.id+"-form");var n=new b(document,{keys:b.KEY.ESCAPE},{fn:function(p,o){this.onCancelButtonClick()},scope:this,correctScope:true});n.enable();g.get(this.id+"-title").focus()}})})();Alfresco.module.getCreateSiteInstance=function(){var a="alfresco-createSite-instance";return Alfresco.util.ComponentManager.get(a)||new Alfresco.module.CreateSite(a)};