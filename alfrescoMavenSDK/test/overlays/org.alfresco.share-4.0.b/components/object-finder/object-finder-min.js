(function(){var K=YAHOO.util.Dom,H=YAHOO.util.Event,A=YAHOO.util.KeyListener;var D=Alfresco.util.encodeHTML,o=Alfresco.util.hasEventInterest,z=Alfresco.util.combinePaths;Alfresco.ObjectFinder=function(V,W){Alfresco.ObjectFinder.superclass.constructor.call(this,"Alfresco.ObjectFinder",V,["button","menu","container","resize","datasource","datatable"]);this.currentValueHtmlId=W;this.eventGroup=V;YAHOO.Bubbling.on("renderCurrentValue",this.onRenderCurrentValue,this);YAHOO.Bubbling.on("selectedItemAdded",this.onSelectedItemAdded,this);YAHOO.Bubbling.on("selectedItemRemoved",this.onSelectedItemRemoved,this);YAHOO.Bubbling.on("parentChanged",this.onParentChanged,this);YAHOO.Bubbling.on("parentDetails",this.onParentDetails,this);YAHOO.Bubbling.on("formContainerDestroyed",this.onFormContainerDestroyed,this);YAHOO.Bubbling.on("removeListItem",this.onRemoveListItem,this);this.pickerId=V+"-picker";this.columns=[];this.selectedItems={};this.isReady=false;this.options.objectRenderer=new Alfresco.ObjectRenderer(this);return this};YAHOO.extend(Alfresco.ObjectFinder,Alfresco.component.Base,{options:{objectRenderer:null,selectedValue:null,currentValue:"",currentItem:null,valueType:"nodeRef",field:null,itemType:"cm:content",itemFamily:"node",compactMode:false,multipleSelectMode:true,showLinkToTarget:false,targetLinkTemplate:null,minSearchTermLength:1,maxSearchResults:100,maintainAddedRemovedItems:true,disabled:false,mandatory:false,createNewItemUri:"",createNewItemIcon:"",displayMode:"items",listItemActions:[],allowRemoveAction:true,allowRemoveAllAction:true,allowSelectAction:true,allowNavigationToContentChildren:false,selectActionLabel:null,selectActionLabelId:null,startLocation:null,startLocationParams:null,rootNode:null},columns:null,singleSelectedItem:null,selectedItems:null,isReady:false,setOptions:function q(V){Alfresco.ObjectFinder.superclass.setOptions.call(this,V);this.options.objectRenderer.setOptions(V);return this},setMessages:function L(V){Alfresco.ObjectFinder.superclass.setMessages.call(this,V);this.options.objectRenderer.setMessages(V);return this},selectItems:function B(V){this.options.selectedValue=V;this._loadSelectedItems()},onReady:function p(){this._createSelectedItemsControls();if(!this.options.disabled){if(this.options.compactMode){K.addClass(this.pickerId,"compact")}this._createNavigationControls();var X=K.get(this.id+"-itemGroupActions");if(X){if(this.options.allowSelectAction){var Y=document.createElement("button");X.appendChild(Y);var W=this.options.selectActionLabel;if(this.options.selectActionLabelId&&this.options.selectActionLabelId.length!==""){W=this.msg(this.options.selectActionLabelId)}this.widgets.addButton=Alfresco.util.createYUIButton(this,null,this.onAddButtonClick,{label:W,disabled:true},Y)}if(this.options.allowRemoveAllAction&&this.options.displayMode=="list"){var V=document.createElement("button");X.appendChild(V);this.widgets.removeAllButton=Alfresco.util.createYUIButton(this,null,this.onRemoveAllButtonClick,{label:this.msg("button.removeAll"),disabled:true},V)}}if(this.options.allowRemoveAction&&this.options.displayMode=="list"){this.options.listItemActions.push({name:"remove-list-item",event:"removeListItem",label:"form.control.object-picker.remove-item"})}this.widgets.ok=Alfresco.util.createYUIButton(this,"ok",this.onOK);this.widgets.cancel=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);K.get(this.id+"-ok-button").name="-";K.get(this.id+"-cancel-button").name="-";this.widgets.dialog=Alfresco.util.createYUIPanel(this.pickerId,{width:"60em"});this.widgets.dialog.hideEvent.subscribe(this.onCancel,null,this);K.addClass(this.pickerId,"object-finder")}this._loadSelectedItems()},destroy:function j(){try{YAHOO.Bubbling.unsubscribe("renderCurrentValue",this.onRenderCurrentValue);YAHOO.Bubbling.unsubscribe("selectedItemAdded",this.onSelectedItemAdded);YAHOO.Bubbling.unsubscribe("selectedItemRemoved",this.onSelectedItemRemoved);YAHOO.Bubbling.unsubscribe("parentChanged",this.onParentChanged);YAHOO.Bubbling.unsubscribe("parentDetails",this.onParentDetails);YAHOO.Bubbling.unsubscribe("formContainerDestroyed",this.onFormContainerDestroyed);YAHOO.Bubbling.unsubscribe("removeListItem",this.onRemoveListItem)}catch(V){}if(this.options.objectRenderer){this.options.objectRenderer.destroy()}Alfresco.ObjectFinder.superclass.destroy.call(this)},onAddButtonClick:function S(V,X){if(!this.widgets.escapeListener){this.widgets.escapeListener=new A(this.pickerId,{keys:A.KEY.ESCAPE},{fn:function W(Y,Z){this.onCancel();H.stopEvent(Z[1])},scope:this,correctScope:true})}this.widgets.escapeListener.enable();this.widgets.dialog.show();this._createResizer();this._populateSelectedItems();this.options.objectRenderer.onPickerShow();if(!this.options.objectRenderer.startLocationResolved&&(this.options.startLocation||this.options.rootNode)){this._resolveStartLocation()}else{this._fireRefreshEvent()}X.set("disabled",true);H.preventDefault(V)},onRemoveAllButtonClick:function b(V,W){this.widgets.currentValuesDataTable.deleteRows(0,this.widgets.currentValuesDataTable.getRecordSet().getLength());this.selectedItems={};this.singleSelectedItem=null;this._adjustCurrentValues();H.preventDefault(V)},onFolderUp:function r(W,X){var V=X.get("value");YAHOO.Bubbling.fire("parentChanged",{eventGroup:this,label:V.name,nodeRef:V.nodeRef});H.preventDefault(W)},onCreateNewOK:function s(V,W){H.preventDefault(V)},onCreateNewCancel:function J(V,W){H.preventDefault(V)},onOK:function g(V,W){this.widgets.escapeListener.disable();this.widgets.dialog.hide();this.widgets.addButton.set("disabled",false);if(V){H.preventDefault(V)}YAHOO.Bubbling.fire("renderCurrentValue",{eventGroup:this})},_adjustCurrentValues:function e(){if(!this.options.disabled){var W=this.getAddedItems(),V=this.getRemovedItems(),X=this.getSelectedItems();if(this.options.maintainAddedRemovedItems){K.get(this.id+"-added").value=W.toString();K.get(this.id+"-removed").value=V.toString()}K.get(this.currentValueHtmlId).value=X.toString();if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Hidden field '"+this.currentValueHtmlId+"' updated to '"+X.toString()+"'")}if(this.options.mandatory){YAHOO.Bubbling.fire("mandatoryControlValueUpdated",this)}YAHOO.Bubbling.fire("formValueChanged",{eventGroup:this,addedItems:W,removedItems:V,selectedItems:X,selectedItemsMetaData:Alfresco.util.deepCopy(this.selectedItems)});this._enableActions()}},onCancel:function F(V,W){this.widgets.escapeListener.disable();this.widgets.dialog.hide();this.widgets.addButton.set("disabled",false);if(V){H.preventDefault(V)}},onSearch:function v(){var V=K.get(this.pickerId+"-searchText").value;if(V.length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("form.control.object-picker.search.enter-more",this.options.minSearchTermLength)})}else{YAHOO.Bubbling.fire("refreshItemList",{eventGroup:this,searchTerm:V})}},canItemBeSelected:function w(V){if(!this.options.multipleSelectMode&&this.singleSelectedItem!==null){return false}return(this.selectedItems[V]===undefined)},getSelectedItems:function R(){var W=[];for(var V in this.selectedItems){if(this.selectedItems.hasOwnProperty(V)){W.push(this.selectedItems[V].nodeRef)}}return W},getAddedItems:function N(){var W=[],V=Alfresco.util.arrayToObject(this.options.currentValue.split(","));for(var X in this.selectedItems){if(this.selectedItems.hasOwnProperty(X)){if(!(X in V)){W.push(X)}}}return W},getRemovedItems:function Q(){var W=[],V=Alfresco.util.arrayToObject(this.options.currentValue.split(","));for(var X in V){if(V.hasOwnProperty(X)){if(!(X in this.selectedItems)){W.push(X)}}}return W},onRenderCurrentValue:function i(aa,X){if(o(this,X)){this._adjustCurrentValues();var W=this.selectedItems,Z="";if(W===null){Z='<span class="error">'+this.msg("form.control.object-picker.current.failure")+"</span>"}else{var ac,ab;if(this.options.displayMode=="list"){var V=this.widgets.currentValuesDataTable.getRecordSet().getLength();if(V>0){this.widgets.currentValuesDataTable.deleteRows(0,V)}}for(var Y in W){if(W.hasOwnProperty(Y)){ac=W[Y];if(ac.type=="cm:category"&&ac.displayPath.indexOf("/categories/Tags")!==-1){ac.type="tag"}if(this.options.showLinkToTarget&&this.options.targetLinkTemplate!==null){if(this.options.displayMode=="items"){ab=null;if(YAHOO.lang.isFunction(this.options.targetLinkTemplate)){ab=this.options.targetLinkTemplate.call(this,ac)}else{if(YAHOO.lang.isString(this.options.targetLinkTemplate)){ab=YAHOO.lang.substitute(this.options.targetLinkTemplate,ac)}}Z+=this.options.objectRenderer.renderItem(ac,16,"<div>{icon} <a href='"+ab+"'>{name}</a></div>")}else{if(this.options.displayMode=="list"){this.widgets.currentValuesDataTable.addRow(ac)}}}else{if(this.options.displayMode=="items"){if(ac.type==="tag"){Z+=this.options.objectRenderer.renderItem(ac,null,"<div class='itemtype-tag'>{name}</div>")}else{Z+=this.options.objectRenderer.renderItem(ac,16,"<div class='itemtype-"+D(ac.type)+"'>{icon} {name}</div>")}}else{if(this.options.displayMode=="list"){this.widgets.currentValuesDataTable.addRow(ac)}}}}}if(this.options.displayMode=="items"){K.get(this.id+"-currentValueDisplay").innerHTML=Z}}this._enableActions()}},onSelectedItemAdded:function k(Z,X){if(o(this,X)){var ab=X[1];if(ab&&ab.item){var W=this.widgets.dataTable.getRecordSet().getRecords(),Y=0,V=W.length;for(;Y<V;Y++){if(ab.item.nodeRef==W[Y].getData().nodeRef){break}}if(Y==V){this.widgets.dataTable.addRow(ab.item);this.selectedItems[ab.item.nodeRef]=ab.item;this.singleSelectedItem=ab.item;if(ab.highlight){var aa=this.widgets.dataTable.get("element");aa.scrollTop=aa.scrollHeight;Alfresco.util.Anim.pulse(this.widgets.dataTable.getLastTrEl())}}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.item-already-added",D(ab.item.name))})}}}},onSelectedItemRemoved:function P(W,V){if(o(this,V)){var X=V[1];if(X&&X.item){delete this.selectedItems[X.item.nodeRef];this.singleSelectedItem=null}}},onParentChanged:function c(W,V){if(o(this,V)){var X=V[1];if(X&&X.label){this.widgets.navigationMenu.set("label",'<div><span class="item-icon"><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/form/images/ajax_anim.gif" width="16" height="16" alt="'+this.msg("message.please-wait")+'"></span><span class="item-name">'+D(X.label)+"</span></div>")}}},onParentDetails:function l(Z,ac){if(o(this,ac)){var Y=ac[1];if(Y&&Y.parent){var ae=[],ag=Y.parent,ad=this.widgets.navigationMenu,ab=ad.getMenu(),aa=ab.getItemGroups()[0],W="";while(ag){ae=[ag].concat(ae);ag=ag.parent}var X,af;for(X=0,af=aa.length;X<af;X++){ab.removeItem(0,0,true)}ag=ae[ae.length-1];ad.set("label",this.options.objectRenderer.renderItem(ag,16,'<div><span class="item-icon">{icon}</span><span class="item-name">{name}</span></div>'));if(ae.length>1){this.widgets.folderUp.set("value",ae[ae.length-2]);this.widgets.folderUp.set("disabled",false)}else{this.widgets.folderUp.set("disabled",true)}var V;for(X=0,af=ae.length;X<af;X++){ag=ae[X];V=new YAHOO.widget.MenuItem(this.options.objectRenderer.renderItem(ag,16,W+'<span class="item-icon">{icon}</span><span class="item-name">{name}</span>'),{value:ag.nodeRef});V.cfg.addProperty("label",{value:ag.name});ab.addItem(V,0);W+="&nbsp;&nbsp;&nbsp;"}ab.render()}}},onFormContainerDestroyed:function u(W,V){if(this.widgets.dialog){this.widgets.dialog.destroy();delete this.widgets.dialog}if(this.widgets.resizer){this.widgets.resizer.destroy();delete this.widgets.resizer}},onRemoveListItem:function a(W,V){if(o(this,V)){var X=V[1].value,Y=V[1].rowId;this.widgets.currentValuesDataTable.deleteRow(Y);delete this.selectedItems[X.nodeRef];this.singleSelectedItem=null;this._adjustCurrentValues()}},fnRenderCellIcon:function E(){var W=this;return function V(Z,Y,aa,ab){var X=W.options.compactMode?16:32;aa.width=X-6;K.setStyle(Z.parentNode,"width",aa.width+"px");Z.innerHTML=W.options.objectRenderer.renderItem(Y.getData(),X,'<div class="icon'+X+'">{icon}</div>')}},fnRenderCellGenericIcon:function O(){var W=this;return function V(Z,Y,aa,ab){Alfresco.logger.debug("ObjectFinder_renderCellGenericIcon("+Z+", "+Y+", "+aa.width+", "+ab+")");var X=W.options.compactMode?16:32;if(aa.width){Alfresco.logger.debug("ObjectFinder_renderCellGenericIcon setting width!");K.setStyle(Z,"width",aa.width+(YAHOO.lang.isNumber(aa.width)?"px":""));K.setStyle(Z.parentNode,"width",aa.width+(YAHOO.lang.isNumber(aa.width)?"px":""))}Z.innerHTML=W.options.objectRenderer.renderItem(Y.getData(),X,'<div class="icon'+X+'">{icon}</div>')}},fnRenderCellName:function I(){var W=this;return function V(Z,Y,aa,ab){var X;if(W.options.compactMode){X='<h3 class="name">{name}</h3>'}else{X='<h3 class="name">{name}</h3><div class="description">{description}</div>'}Z.innerHTML=W.options.objectRenderer.renderItem(Y.getData(),0,X)}},fnRenderCellRemove:function y(){var W=this;return function V(Y,X,Z,aa){K.setStyle(Y.parentNode,"width",Z.width+"px");Y.innerHTML='<a href="#" class="remove-item remove-'+W.eventGroup+'" title="'+W.msg("form.control.object-picker.remove-item")+'" tabindex="0"><span class="removeIcon">&nbsp;</span></a>'}},fnRenderCellListItemName:function M(){var W=this;return function V(ac,ag,Z,Y){var af=ag.getData(),ae=af.description?D(af.description):W.msg("label.none"),X=af.modified?Alfresco.util.formatDate(Alfresco.util.fromISO8601(af.modified)):null,ab=D(af.name);if(W.options.showLinkToTarget&&W.options.targetLinkTemplate!==null){var aa;if(YAHOO.lang.isFunction(W.options.targetLinkTemplate)){aa=W.options.targetLinkTemplate.call(W,ag.getData())}else{if(YAHOO.lang.isString(W.options.targetLinkTemplate)){aa=YAHOO.lang.substitute(W.options.targetLinkTemplate,ag.getData())}}ab='<a href="'+aa+'">'+D(af.name)+"</a>"}var ad='<h3 class="name">'+ab+"</h3>";ad+='<div class="description">'+W.msg("form.control.object-picker.description")+": "+ae+"</div>";ad+='<div class="viewmode-label">'+W.msg("form.control.object-picker.modified-on")+": "+(X?X:W.msg("label.none"))+"</div>";ac.innerHTML=ad}},fnRenderCellListItemActions:function U(){var V=this;return function W(ad,af,aa,X){if(aa.width){K.setStyle(ad,"width",aa.width+(YAHOO.lang.isNumber(aa.width)?"px":""));K.setStyle(ad.parentNode,"width",aa.width+(YAHOO.lang.isNumber(aa.width)?"px":""))}if(V.options.disabled===false){var ae="",ab,Y;for(var Z=0,ac=V.options.listItemActions.length;Z<ac;Z++){Y=V.options.listItemActions[Z];if(Y.event){ae+='<div class="list-action"><a href="#" class="'+Y.name+"  list-action-event-"+V.eventGroup+" "+Y.event+'" title="'+V.msg(Y.label)+'" tabindex="0">'+V.msg(Y.label)+"</a></div>"}else{ab=null;if(YAHOO.lang.isFunction(Y.link)){ab=Y.link.call(this,af.getData())}else{if(YAHOO.lang.isString(Y.link)){ab=YAHOO.lang.substitute(Y.link,af.getData())}}ae+='<div class="list-action"><a href="'+ab+'" class="'+Y.name+'" title="'+V.msg(Y.label)+'" tabindex="0">'+V.msg(Y.label)+"</a></div>"}}ad.innerHTML=ae}}},_loadSelectedItems:function d(W){var Z="";if(this.options.selectedValue){Z=this.options.selectedValue}else{Z=this.options.currentValue}var aa=function Y(ad){var ac=ad.json.data.items,af;this.selectedItems={};for(var ae=0,ab=ac.length;ae<ab;ae++){af=ac[ae];this.selectedItems[af.nodeRef]=af}YAHOO.Bubbling.fire("renderCurrentValue",{eventGroup:this})};var X=function V(ab){this.selectedItems=null};if(Z!==""){Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"api/forms/picker/items",method:"POST",dataObj:{items:Z.split(","),itemValueType:this.options.valueType},successCallback:{fn:aa,scope:this},failureCallback:{fn:X,scope:this}})}else{if(this.options.disabled&&this.options.displayMode=="items"){K.get(this.id+"-currentValueDisplay").innerHTML=this.msg("form.control.novalue")}this._enableActions()}},_createNavigationControls:function x(){var W=this;if(this._inAuthorityMode()){K.setStyle(this.pickerId+"-folderUpContainer","display","none");K.setStyle(this.pickerId+"-navigatorContainer","display","none");K.setStyle(this.pickerId+"-searchContainer","display","block");this.widgets.searchButton=new YAHOO.widget.Button(this.pickerId+"-searchButton");this.widgets.searchButton.on("click",this.onSearch,this.widgets.searchButton,this);K.get(this.pickerId+"-searchButton").name="-";var V=K.get(this.pickerId+"-searchText");new YAHOO.util.KeyListener(V,{keys:13},{fn:W.onSearch,scope:this,correctScope:true},"keydown").enable()}else{this.widgets.folderUp=new YAHOO.widget.Button(this.pickerId+"-folderUp",{disabled:true});this.widgets.folderUp.on("click",this.onFolderUp,this.widgets.folderUp,this);this.widgets.navigationMenu=new YAHOO.widget.Button(this.pickerId+"-navigator",{type:"menu",menu:this.pickerId+"-navigatorMenu",lazyloadmenu:false});K.get(this.pickerId+"-folderUp-button").name="-";K.get(this.pickerId+"-navigator-button").name="-";this.widgets.navigationMenu.getMenu().subscribe("click",function(Y,X){var Z=X[1];if(Z){YAHOO.Bubbling.fire("parentChanged",{eventGroup:W,label:Z.cfg.getProperty("label"),nodeRef:Z.value})}});if(K.get(this.pickerId+"-createNew")){this.widgets.createNewOK=new YAHOO.widget.Button(this.pickerId+"-createNewOK",{disabled:true});this.widgets.createNewOK.on("click",this.onCreateNewOK,this.widgets.createNewOK,this);this.widgets.createNewCancel=new YAHOO.widget.Button(this.pickerId+"-createNewCancel",{disabled:true});this.widgets.createNewCancel.on("click",this.onCreateNewCancel,this.widgets.createNewCancel,this)}}},_createSelectedItemsControls:function m(){var W=function ag(an,ak){var aj=ak;if(ak&&ak.length>0){var ai=ak.data.items;var al,am;for(al in ai){if(ai.hasOwnProperty(al)){am=ai[al];if(am.type=="cm:category"&&am.displayPath.indexOf("/categories/Tags")!==-1){am.type="tag"}}}aj={items:ai}}return aj};var ad=this;if(this.options.disabled===false){this.widgets.dataSource=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY,doBeforeParseData:W});var ab=[{key:"nodeRef",label:"Icon",sortable:false,formatter:this.fnRenderCellIcon(),width:this.options.compactMode?10:26},{key:"name",label:"Item",sortable:false,formatter:this.fnRenderCellName()},{key:"remove",label:"Remove",sortable:false,formatter:this.fnRenderCellRemove(),width:16}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.pickerId+"-selectedItems",ab,this.widgets.dataSource,{MSG_EMPTY:this.msg("form.control.object-picker.selected-items.empty")});var ac=function V(al,ak){var ai=YAHOO.Bubbling.getOwnerByTagName(ak[1].anchor,"div");if(ai!==null){var an,am,aj;an=ak[1].target;am=an.offsetParent;aj=ad.widgets.dataTable.getRecord(am);if(aj){ad.widgets.dataTable.deleteRow(am);YAHOO.Bubbling.fire("selectedItemRemoved",{eventGroup:ad,item:aj.getData()})}}return true};YAHOO.Bubbling.addDefaultAction("remove-"+this.eventGroup,ac,true)}var Z=K.get(this.id+"-currentValueDisplay");K.addClass(Z,"object-finder-"+this.options.displayMode);if(this.options.displayMode=="list"){var X=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY,doBeforeParseData:W});var ae=[{key:"nodeRef",label:"Icon",sortable:false,formatter:this.fnRenderCellGenericIcon(),width:50},{key:"name",label:"Item",sortable:false,formatter:this.fnRenderCellListItemName()},{key:"action",label:"Actions",sortable:false,formatter:this.fnRenderCellListItemActions(),width:200}];var Y=this.id+"-currentValueDisplay";Z=K.get(Y);if(Z.tagName.toLowerCase()=="span"){var ah=document.createElement("div");ah.setAttribute("class",Z.getAttribute("class"));Z.parentNode.appendChild(ah);Z.parentNode.removeChild(Z);Z=ah}this.widgets.currentValuesDataTable=new YAHOO.widget.DataTable(Z,ae,X,{MSG_EMPTY:this.msg("form.control.object-picker.selected-items.empty")});this.widgets.currentValuesDataTable.subscribe("rowMouseoverEvent",this.widgets.currentValuesDataTable.onEventHighlightRow);this.widgets.currentValuesDataTable.subscribe("rowMouseoutEvent",this.widgets.currentValuesDataTable.onEventUnhighlightRow);K.addClass(Z,"form-element-border");K.addClass(Z,"form-element-background-color");var af=function aa(ao,aq){var aj=YAHOO.Bubbling.getOwnerByTagName(aq[1].anchor,"div");if(aj!==null){var ap,ak,an;ap=aq[1].target;ak=ap.offsetParent;an=ad.widgets.currentValuesDataTable.getRecord(ak);if(an){var am=an.getData(),ai=YAHOO.util.Dom.getAttribute(aq[1].target,"class").split(" ")[0];for(var al=0,ar=ad.options.listItemActions.length;al<ar;al++){if(ad.options.listItemActions[al].name==ai){YAHOO.Bubbling.fire(ad.options.listItemActions[al].event,{eventGroup:ad,value:am,rowId:ak});return true}}}}return true};YAHOO.Bubbling.addDefaultAction("list-action-event-"+this.eventGroup,af,true)}},_populateSelectedItems:function C(){this.widgets.dataTable.set("MSG_EMPTY",this.msg("form.control.object-picker.selected-items.empty"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());for(var V in this.selectedItems){if(this.selectedItems.hasOwnProperty(V)){YAHOO.Bubbling.fire("selectedItemAdded",{eventGroup:this,item:this.selectedItems[V]})}}},_resolveStartLocation:function h(){if(this.options.startLocation||this.options.rootNode){this.options.startLocation=(this.options.startLocation||this.options.rootNode);if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Resolving startLocation of '"+this.options.startLocation+"'")}var V=null;if(this.options.startLocation.charAt(0)=="{"){if(this.options.startLocation=="{companyhome}"){V="alfresco://company/home"}else{if(this.options.startLocation=="{userhome}"){V="alfresco://user/home"}else{if(this.options.startLocation=="{siteshome}"){V="alfresco://sites/home"}else{if(this.options.startLocation=="{self}"){if(this.options.currentItem&&this.options.currentItem!==null){V=this.options.currentItem}else{V="alfresco://company/home";if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.warn("To use a start location of {self} a 'currentItem' parameter is required, defaulting to company home")}}}}}}}else{if(this.options.startLocation.charAt(0)=="/"){V=""}else{V=this.options.startLocation}}if(V!=null){this.options.objectRenderer.options.parentNodeRef=V;this._fireRefreshEvent()}else{this._locateStartingNode()}}else{this._fireRefreshEvent()}},_locateStartingNode:function G(){if(this.options.startLocation&&this.options.currentItem&&this.options.currentItem!==null){var Z="companyhome";if(this.options.startLocation=="{parent}"){Z="ancestor"}else{if(this.options.startLocation.length>2&&this.options.startLocation.charAt(0)=="{"&&this.options.startLocation.charAt(this.options.startLocation.length-1)=="}"){Z=this.options.startLocation.substring(1,this.options.startLocation.length-1)}}var X=z(Alfresco.constants.PROXY_URI,"/api/",this.options.currentItem.replace("://","/"),"nodelocator",Z);if(this.options.startLocationParams&&this.options.startLocationParams!=null){X+="?"+encodeURI(this.options.startLocationParams)}var W=function aa(ac){var ad=ac.json.data.nodeRef;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("startLocation resolved to: "+ad)}this.options.objectRenderer.options.parentNodeRef=ad;this._fireRefreshEvent()};var Y=function ab(ac){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.error("Failed to locate node: "+ac.serverResponse.responseText)}this._fireRefreshEvent()};if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Generated nodelocator url: "+X)}var V={method:"GET",url:X,successCallback:{fn:W,scope:this},failureCallback:{fn:Y,scope:this}};Alfresco.util.Ajax.request(V)}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.warn("To use a start location of "+this.options.startLocation+" a 'currentItem' parameter is required")}this._fireRefreshEvent()}},_fireRefreshEvent:function n(){if(this._inAuthorityMode()===false){YAHOO.Bubbling.fire("refreshItemList",{eventGroup:this})}else{var W=K.get(this.pickerId+"-searchText");var V=W.value;if(V.length>=this.options.minSearchTermLength){YAHOO.Bubbling.fire("refreshItemList",{eventGroup:this,searchTerm:V})}else{W.focus()}}},_createResizer:function T(){if(!this.widgets.resizer){var V=parseInt(K.get(this.pickerId+"-body").offsetWidth,10)-2,W=0;this.columns[0]=K.get(this.pickerId+"-left");this.columns[1]=K.get(this.pickerId+"-right");this.widgets.resizer=new YAHOO.util.Resize(this.pickerId+"-left",{handles:["r"],minWidth:200,maxWidth:(V-200)});W=this.widgets.resizer.get("height");this.widgets.resizer.on("resize",function(Y){var X=Y.width;K.setStyle(this.columns[0],"height","");K.setStyle(this.columns[1],"width",(V-X-8)+"px")},this,true);this.widgets.resizer.on("endResize",function(X){this.set("height",W)});this.widgets.resizer.fireEvent("resize",{ev:"resize",target:this.widgets.resizer,width:V/2})}},_inAuthorityMode:function t(){return(this.options.itemFamily=="authority")},_enableActions:function f(){if(this.widgets.removeAllButton){this.widgets.removeAllButton.set("disabled",this.widgets.currentValuesDataTable.getRecordSet().getLength()===0)}if(this.widgets.addButton){this.widgets.addButton.set("disabled",false)}if(!this.options.disabled&&!this.isReady){this.isReady=true;YAHOO.Bubbling.fire("objectFinderReady",{eventGroup:this})}}})})();(function(){var c=YAHOO.util.Dom,x=YAHOO.util.Event,l=YAHOO.util.KeyListener;var n=Alfresco.util.encodeHTML,t=Alfresco.util.hasEventInterest,k=Alfresco.util.combinePaths;var h="~CREATE~NEW~";Alfresco.ObjectRenderer=function(y){this.objectFinder=y;Alfresco.ObjectRenderer.superclass.constructor.call(this,"Alfresco.ObjectRenderer",y.pickerId,["button","menu","container","datasource","datatable"]);this.eventGroup=y.eventGroup;YAHOO.Bubbling.on("refreshItemList",this.onRefreshItemList,this);YAHOO.Bubbling.on("parentChanged",this.onParentChanged,this);YAHOO.Bubbling.on("selectedItemAdded",this.onSelectedItemChanged,this);YAHOO.Bubbling.on("selectedItemRemoved",this.onSelectedItemChanged,this);this.addItemButtons={};this.startLocationResolved=false;this.createNewItemId=null;return this};YAHOO.extend(Alfresco.ObjectRenderer,Alfresco.component.Base,{options:{parentNodeRef:"",itemType:"cm:content",itemFamily:"node",params:"",compactMode:false,maxSearchResults:100,createNewItemUri:"",createNewItemIcon:""},addItemButtons:null,createNewItemId:null,startLocationResolved:false,onReady:function m(){this._createControls()},destroy:function u(){try{YAHOO.Bubbling.unsubscribe("refreshItemList",this.onRefreshItemList);YAHOO.Bubbling.unsubscribe("parentChanged",this.onParentChanged);YAHOO.Bubbling.unsubscribe("selectedItemAdded",this.onSelectedItemChanged);YAHOO.Bubbling.unsubscribe("selectedItemRemoved",this.onSelectedItemChanged)}catch(y){}Alfresco.ObjectRenderer.superclass.destroy.call(this)},onPickerShow:function q(){this.addItemButtons={};c.get(this.objectFinder.pickerId).focus()},getIconURL:function f(z,y){return Alfresco.constants.URL_RESCONTEXT+"components/images/filetypes/"+Alfresco.util.getFileIcon(z.name,z.type,y)},renderItem:function b(D,y,B){var C=this;var A=function z(E,G,F){if(E.toLowerCase()=="icon"){return'<img src="'+C.getIconURL(D,y)+'" width="'+y+'" alt="'+n(D.description)+'" title="'+n(D.name)+'" />'}return n(G)};return YAHOO.lang.substitute(B,D,A)},onRefreshItemList:function v(A,z){if(t(this,z)){var y="";var B=z[1];if(B&&B.searchTerm){y=B.searchTerm}this._updateItems(this.options.parentNodeRef,y)}},onParentChanged:function o(z,y){if(t(this,y)){var A=y[1];if(A&&A.nodeRef){this._updateItems(A.nodeRef,"")}}},onSelectedItemChanged:function r(A,y){if(t(this,y)){var B=y[1];if(B&&B.item){var z;for(var C in this.addItemButtons){if(this.addItemButtons.hasOwnProperty(C)){z=this.addItemButtons[C];c.setStyle(z,"display",this.objectFinder.canItemBeSelected(C)?"inline":"none")}}}}},fnRenderItemIcon:function e(){var y=this;return function z(C,B,E,F){var A=y.options.compactMode?16:32;E.width=A-6;c.setStyle(C.parentNode,"width",E.width+"px");if(B.getData("type")==h){c.addClass(this.getTrEl(C),"create-new-row");var D={type:y.options.createNewItemIcon,description:y.msg("form.control.object-picker.create-new")};C.innerHTML=y.renderItem(D,A,'<div class="icon'+A+'"><span class="new-item-overlay"></span>{icon}</div>');return}C.innerHTML=y.renderItem(B.getData(),A,'<div class="icon'+A+'">{icon}</div>')}},fnRenderItemName:function g(){var z=this;return function y(C,B,D,E){var A="";if(B.getData("type")==h){z.createNewItemId=Alfresco.util.generateDomId();C.innerHTML='<input id="'+z.createNewItemId+'" type="text" class="create-new-input" tabindex="0" />';return}if(B.getData("isContainer")||(!B.getData("isContainer")&&(z.options.allowNavigationToContentChildren||B.getData("type")=="cm:category"))){A+='<h3 class="item-name"><a href="#" class="theme-color-1 parent-'+z.eventGroup+'">{name}</a></h3>'}else{A+='<h3 class="item-name">{name}</h3>'}if(!z.options.compactMode){A+='<div class="description">{description}</div>'}C.innerHTML=z.renderItem(B.getData(),0,A)}},fnRenderCellAdd:function w(){var y=this;return function z(F,E,G,H){c.setStyle(F.parentNode,"width",G.width+"px");var A=Alfresco.util.generateDomId(),B;if(E.getData("type")==h){F.innerHTML='<a href="#" class="create-new-item create-new-item-'+y.eventGroup+'" title="'+y.msg("form.control.object-picker.create-new")+'" tabindex="0"><span class="createNewIcon">&nbsp;</span></a>';return}if(E.getData("selectable")){var D=E.getData("nodeRef"),C="";if(!y.objectFinder.canItemBeSelected(D)){C='style="display: none"'}F.innerHTML='<a id="'+A+'" href="#" '+C+' class="add-item add-'+y.eventGroup+'" title="'+y.msg("form.control.object-picker.add-item")+'" tabindex="0"><span class="addIcon">&nbsp;</span></a>';y.addItemButtons[D]=A}}},onCreateNewItem:function d(){var y=c.get(this.createNewItemId),z=k("/",this.options.createNewItemUri).substring(1),B;if(y){B=y.value;if(B===null||B.length<1){return}Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+z,dataObj:{name:B},successCallback:{fn:function A(E){var C=E.json;if(C&&C.nodeRef){var D={type:this.options.itemType,name:C.name,nodeRef:C.nodeRef,selectable:true};if(D.type=="cm:category"&&C.displayPath.indexOf("/categories/Tags")!==-1){D.type="tag"}if(!C.itemExists){Alfresco.util.PopupManager.displayMessage({text:this.msg("form.control.object-picker.create-new.success",C.name)});this.widgets.dataTable.addRow(D)}YAHOO.Bubbling.fire("selectedItemAdded",{eventGroup:this,item:D,highlight:true})}y.value=""},scope:this},failureMessage:this.msg("form.control.object-picker.create-new.failure")})}},_createControls:function j(){var E=this;var H=Alfresco.constants.PROXY_URI+"api/forms/picker/"+this.options.itemFamily;this.widgets.dataSource=new YAHOO.util.DataSource(H,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items",metaFields:{parent:"parent"}}});this.widgets.dataSource.doBeforeParseData=function G(O,L){var K=L;if(L){var J=L.data.items;if(E.options.maxSearchResults>-1&&J.length>E.options.maxSearchResults){J=J.slice(0,E.options.maxSearchResults-1)}if(E.options.createNewItemUri!==""&&E.createNewItemId===null){J=[{type:h}].concat(J)}var M,N;for(M in J){if(J.hasOwnProperty(M)){N=J[M];if(N.type=="cm:category"&&N.displayPath.indexOf("/categories/Tags")!==-1){N.type="tag";L.data.parent.type="tag"}}}YAHOO.Bubbling.fire("parentDetails",{eventGroup:E,parent:L.data.parent});K={parent:L.data.parent,items:J}}return K};var D=[{key:"nodeRef",label:"Icon",sortable:false,formatter:this.fnRenderItemIcon(),width:this.options.compactMode?10:26},{key:"name",label:"Item",sortable:false,formatter:this.fnRenderItemName()},{key:"add",label:"Add",sortable:false,formatter:this.fnRenderCellAdd(),width:16}];var C=this.msg("form.control.object-picker.items-list.loading");if(this._inAuthorityMode()){C=this.msg("form.control.object-picker.items-list.search")}this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",D,this.widgets.dataSource,{renderLoopSize:100,initialLoad:false,MSG_EMPTY:C});this.widgets.dataTable.subscribe("renderEvent",function(){if(this.options.createNewItemUri!==""){if(!this.widgets.enterListener){this.widgets.enterListener=new l(this.createNewItemId,{keys:l.KEY.ENTER},{fn:function J(K,L,M){if(this.autocompleteDelayId!=-1){window.clearTimeout(this.autocompleteDelayId)}this.onCreateNewItem();x.stopEvent(L[1]);return false},scope:this,correctScope:true},YAHOO.env.ua.ie>0?l.KEYDOWN:"keypress");this.widgets.enterListener.enable()}E.autocompleteDelayId=-1;x.addListener(this.createNewItemId,"keyup",function(K){var L=this.value;if(!Alfresco.util.isAutocompleteIgnoreKey(K.keyCode)){if(E.autocompleteDelayId!=-1){window.clearTimeout(E.autocompleteDelayId)}E.autocompleteDelayId=window.setTimeout(function(){YAHOO.Bubbling.fire("refreshItemList",{eventGroup:E,searchTerm:L})},500)}});c.get(this.createNewItemId).focus()}},this,true);var y=function A(M,L){var J=YAHOO.Bubbling.getOwnerByTagName(L[1].anchor,"div");if(J!==null){var O,N,K;O=L[1].target;N=O.offsetParent;K=E.widgets.dataTable.getRecord(N);if(K){YAHOO.Bubbling.fire("selectedItemAdded",{eventGroup:E,item:K.getData(),highlight:true})}}return true};YAHOO.Bubbling.addDefaultAction("add-"+this.eventGroup,y,true);var z=function F(L,K){var J=YAHOO.Bubbling.getOwnerByTagName(K[1].anchor,"div");if(J!==null){E.onCreateNewItem()}return true};YAHOO.Bubbling.addDefaultAction("create-new-item-"+this.eventGroup,z,true);var I=function B(M,L){var J=YAHOO.Bubbling.getOwnerByTagName(L[1].anchor,"div");if(J!==null){var O,N,K;O=L[1].target;N=O.offsetParent;K=E.widgets.dataTable.getRecord(N);if(K){YAHOO.Bubbling.fire("parentChanged",{eventGroup:E,label:K.getData("name"),nodeRef:K.getData("nodeRef")})}}return true};YAHOO.Bubbling.addDefaultAction("parent-"+this.eventGroup,I,true)},_updateItems:function s(E,y){if(this.createNewItemId!==null){this.widgets.dataTable.deleteRows(1,this.widgets.dataTable.getRecordSet().getLength()-1)}else{this.widgets.dataTable.set("MSG_EMPTY",this.msg("form.control.object-picker.items-list.loading"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength())}var B=function A(F,G,H){this.options.parentNodeRef=G.meta.parent?G.meta.parent.nodeRef:E;this.widgets.dataTable.set("MSG_EMPTY",this.msg("form.control.object-picker.items-list.empty"));if(this.createNewItemId!==null){this.widgets.dataTable.onDataReturnAppendRows.call(this.widgets.dataTable,F,G,H)}else{this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,F,G,H)}};var D=function C(G,H){if(H.status==401){window.location.reload()}else{try{var F=YAHOO.lang.JSON.parse(H.responseText);this.widgets.dataTable.set("MSG_ERROR",F.message);this.widgets.dataTable.showTableMessage(F.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(I){}}};var z=this._generatePickerChildrenUrlPath(E)+this._generatePickerChildrenUrlParams(y);if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Generated pickerchildren url fragment: "+z)}this.widgets.dataSource.sendRequest(z,{success:B,failure:D,scope:this});this.startLocationResolved=true},_inAuthorityMode:function i(){return(this.options.itemFamily=="authority")},_generatePickerChildrenUrlPath:function p(y){return k("/",y.replace("://","/"),"children")},_generatePickerChildrenUrlParams:function a(z){var A="?selectableType="+this.options.itemType+"&searchTerm="+encodeURIComponent(z)+"&size="+this.options.maxSearchResults;if(!this.startLocationResolved&&this.options.startLocation&&this.options.startLocation.charAt(0)=="/"){A+="&xpath="+encodeURIComponent(this.options.startLocation)}if(this.options.rootNode){var y=null;if(this.options.rootNode.charAt(0)=="{"){if(this.options.rootNode=="{companyhome}"){y="alfresco://company/home"}else{if(this.options.rootNode=="{userhome}"){y="alfresco://user/home"}else{if(this.options.rootNode=="{siteshome}"){y="alfresco://sites/home"}}}}else{y=this.options.rootNode}if(y!==null){A+="&rootNode="+encodeURIComponent(y)}}if(this.options.params){A+="&"+encodeURI(this.options.params)}return A}})})();