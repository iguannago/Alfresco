(function(){var c=YAHOO.util.Dom,t=YAHOO.util.Event;var p=Alfresco.util.encodeHTML;Alfresco.Search=function(u){Alfresco.Search.superclass.constructor.call(this,"Alfresco.Search",u,["button","container","datasource","datatable","paginator","json"]);YAHOO.Bubbling.on("onSearch",this.onSearch,this);return this};YAHOO.extend(Alfresco.Search,Alfresco.component.Base,{options:{siteId:"",siteTitle:"",maxSearchResults:250,pageSize:50,initialSearchTerm:"",initialSearchTag:"",initialSearchAllSites:true,initialSearchRepository:false,initialSort:"",searchQuery:"",minSearchTermLength:1},searchTerm:"",searchTag:"",searchAllSites:true,searchRepository:false,searchSort:"",resultsCount:0,currentPage:1,hasMoreResults:false,onReady:function q(){var C=this;var v=Alfresco.constants.PROXY_URI_RELATIVE+"slingshot/search?";this.widgets.dataSource=new YAHOO.util.DataSource(v,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items"}});var y=function B(F,E){E.currentPage=F.page;E.widgets.paginator.setState(F)};this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});this.widgets.paginator.subscribe("changeRequest",y,this);this._setupDataTable();var x=c.get(this.id+"-search-text");x.value=this.options.initialSearchTerm;this.widgets.enterListener=new YAHOO.util.KeyListener(x,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:C._searchEnterHandler,scope:this,correctScope:true},"keydown").enable();YAHOO.Bubbling.fire("onSearch",{searchTerm:this.options.initialSearchTerm,searchTag:this.options.initialSearchTag,searchSort:this.options.initialSort,searchAllSites:this.options.initialSearchAllSites,searchRepository:this.options.initialSearchRepository});var A=c.get(this.id+"-site-link");t.addListener(A,"click",this.onSiteSearch,this,true);A=c.get(this.id+"-all-sites-link");t.addListener(A,"click",this.onAllSiteSearch,this,true);A=c.get(this.id+"-repo-link");t.addListener(A,"click",this.onRepositorySearch,this,true);this.widgets.searchButton=Alfresco.util.createYUIButton(this,"search-button",this.onSearchClick);this.widgets.sortButton=new YAHOO.widget.Button(this.id+"-sort-menubutton",{type:"menu",menu:this.id+"-sort-menu",menualignment:["tr","br"],lazyloadmenu:false});var u=this.widgets.sortButton.getMenu().getItems();for(var w in u){if(u[w].value===this.options.initialSort){this.widgets.sortButton.set("label",this.msg("label.sortby",u[w].cfg.getProperty("text")));break}}this.widgets.sortButton.getMenu().subscribe("click",function(F,E){var G=E[1];if(G){C.refreshSearch({searchSort:G.value})}});var D=function z(G,F){var E=YAHOO.Bubbling.getOwnerByTagName(F[1].anchor,"span");if(E!==null){if(typeof C[E.className]=="function"){F[1].stop=true;var H=E.id.substring(C.id.length+1);C[E.className].call(C,H)}}return true};YAHOO.Bubbling.addDefaultAction("search-tag",D);c.setStyle(this.id+"-body","visibility","visible")},_setupDataTable:function f(){var x=this;renderCellThumbnail=function w(H,J,D,B){D.width=100;D.height=100;c.setStyle(H.parentNode,"width",D.width+"px");c.setStyle(H,"height",D.height+"px");c.addClass(H,"thumbnail-cell");var z=x._getBrowseUrlForRecord(J);var I=Alfresco.constants.URL_RESCONTEXT+"components/search/images/generic-result.png";var G=J.getData("type");switch(G){case"document":I=Alfresco.constants.PROXY_URI_RELATIVE+"api/node/"+J.getData("nodeRef").replace(":/","");I+="/content/thumbnails/doclib?c=queue&ph=true";break;case"folder":I=Alfresco.constants.URL_RESCONTEXT+"components/search/images/folder.png";break;case"blogpost":I=Alfresco.constants.URL_RESCONTEXT+"components/search/images/blog-post.png";break;case"forumpost":I=Alfresco.constants.URL_RESCONTEXT+"components/search/images/topic-post.png";break;case"calendarevent":I=Alfresco.constants.URL_RESCONTEXT+"components/search/images/calendar-event.png";break;case"wikipage":I=Alfresco.constants.URL_RESCONTEXT+"components/search/images/wiki-page.png";break;case"link":I=Alfresco.constants.URL_RESCONTEXT+"components/search/images/link.png";break;case"datalist":I=Alfresco.constants.URL_RESCONTEXT+"components/search/images/datalist.png";break;case"datalistitem":I=Alfresco.constants.URL_RESCONTEXT+"components/search/images/datalistitem.png";break}var A=J.getData("displayName");var F=p(A);var C='<span><a href="'+z+'"><img src="'+I+'" alt="'+F+'" title="'+F+'" /></a></span>';if(G==="document"){var E=Alfresco.constants.PROXY_URI_RELATIVE+"api/node/content/"+J.getData("nodeRef").replace(":/","")+"/"+J.getData("name");C='<div class="action-overlay"><a href="'+encodeURI(E)+'" target="_blank"><img title="'+p(x.msg("label.viewinbrowser"))+'" src="'+Alfresco.constants.URL_RESCONTEXT+'components/search/images/view-in-browser-16.png" width="16" height="16"/></a><a href="'+encodeURI(E+"?a=true")+'" style="padding-left:4px" target="_blank"><img title="'+p(x.msg("label.download"))+'" src="'+Alfresco.constants.URL_RESCONTEXT+'components/search/images/download-16.png" width="16" height="16"/></a></div>'+C}H.innerHTML=C};renderCellDescription=function u(K,N,G,B){c.setStyle(K.parentNode,"line-height","1.5em");var z=N.getData("site");var A=x._getBrowseUrlForRecord(N);var J=N.getData("displayName");var F='<h3 class="itemname"><a href="'+A+'" class="theme-color-1">'+p(J)+"</a>";var I=N.getData("title");if(I&&I!==J){F+='<span class="title">('+p(I)+")</span>"}F+="</h3>";var E=N.getData("description");if(E){F+='<div class="details meta">'+p(E)+"</div>"}F+='<div class="details">';var H=N.getData("type");switch(H){case"document":case"folder":case"blogpost":case"forumpost":case"calendarevent":case"wikipage":case"datalist":case"datalistitem":case"link":F+=x.msg("label."+H);break;default:F+=x.msg("label.unknown");break}if(z){F+=" "+x.msg("message.insite");F+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"site/"+p(z.shortName)+'/dashboard">'+p(z.title)+"</a>"}if(N.getData("size")!==-1){F+=" "+x.msg("message.ofsize");F+=' <span class="meta">'+Alfresco.util.formatFileSize(N.getData("size"))+"</span>"}if(N.getData("modifiedBy")){F+=" "+x.msg("message.modifiedby");F+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"user/"+encodeURI(N.getData("modifiedByUser"))+'/profile">'+p(N.getData("modifiedBy"))+"</a>"}F+=" "+x.msg("message.modifiedon")+' <span class="meta">'+Alfresco.util.formatDate(N.getData("modifiedOn"))+"</span>";F+="</div>";if(H==="document"||H==="folder"){var M=N.getData("path");if(z){if(M===null||M===undefined){M=""}F+='<div class="details">'+x.msg("message.infolderpath")+': <a href="'+x._getBrowseUrlForFolderPath(M,z)+'">'+p("/"+M)+"</a></div>"}else{if(M){F+='<div class="details">'+x.msg("message.infolderpath")+': <a href="'+x._getBrowseUrlForFolderPath(M)+'">'+p(M)+"</a></div>"}}}var L=N.getData("tags");if(L.length!==0){var D,C;F+='<div class="details"><span class="tags">'+x.msg("label.tags")+": ";for(D=0,C=L.length;D<C;D++){F+='<span id="'+x.id+"-"+p(L[D])+'" class="searchByTag"><a class="search-tag" href="#">'+p(L[D])+"</a> </span>"}F+="</span></div>"}K.innerHTML=F};var y=[{key:"image",label:x.msg("message.preview"),sortable:false,formatter:renderCellThumbnail,width:100},{key:"summary",label:x.msg("label.description"),sortable:false,formatter:renderCellDescription}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",y,this.widgets.dataSource,{renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,paginator:this.widgets.paginator,MSG_LOADING:""});this._setDefaultDataTableErrors(this.widgets.dataTable);if(this.options.initialSearchTerm.length===0&&this.options.initialSearchTag.length===0){this.widgets.dataTable.set("MSG_EMPTY","")}this.widgets.dataTable.doBeforeLoadData=function v(A,B,D){if(B.error){try{var z=YAHOO.lang.JSON.parse(B.responseText);x.widgets.dataTable.set("MSG_ERROR",z.message)}catch(C){x._setDefaultDataTableErrors(x.widgets.dataTable)}}else{if(B.results){x.widgets.dataTable.set("MSG_EMPTY","");x.hasMoreResults=(B.results.length>x.options.maxSearchResults);if(x.hasMoreResults){B.results=B.results.slice(0,x.options.maxSearchResults);x.resultsCount=x.options.maxSearchResults}else{x.resultsCount=B.results.length}if(x.resultsCount>x.options.pageSize){c.removeClass(x.id+"-paginator-top","hidden");c.removeClass(x.id+"-search-bar-bottom","hidden")}}}return true};x.widgets.dataTable.subscribe("renderEvent",function(){x.widgets.paginator.setState({page:x.currentPage,totalRecords:x.resultsCount});x.widgets.paginator.render()})},_getBrowseUrlForRecord:function j(u){var x=null;var w=u.getData("name"),y=u.getData("type"),v=u.getData("site"),z=u.getData("path");switch(y){case"document":x="document-details?nodeRef="+u.getData("nodeRef");break;case"folder":if(z!==null){if(v){x="documentlibrary?path="+encodeURIComponent(this._buildSpaceNamePath(z.split("/"),w))}else{x="repository?path="+encodeURIComponent(this._buildSpaceNamePath(z.split("/").slice(2),w))}}break;case"blogpost":x="blog-postview?postId="+w;break;case"forumpost":x="discussions-topicview?topicId="+w;break;case"calendarevent":x=u.getData("container")+"?date="+Alfresco.util.formatDate(u.getData("modifiedOn"),"yyyy-mm-dd");break;case"wikipage":x="wiki-page?title="+w;break;case"link":x="links-view?linkId="+w;break;case"datalist":case"datalistitem":x="data-lists?list="+w;break}if(x!==null){if(v){x=Alfresco.constants.URL_PAGECONTEXT+"site/"+v.shortName+"/"+x}else{x=Alfresco.constants.URL_PAGECONTEXT+x}}return(x!==null?x:"#")},_getBrowseUrlForFolderPath:function l(w,v){var u=null;if(v){u=Alfresco.constants.URL_PAGECONTEXT+"site/"+v.shortName+"/documentlibrary?path="+encodeURIComponent("/"+w)}else{u=Alfresco.constants.URL_PAGECONTEXT+"repository?path="+encodeURIComponent("/"+w.split("/").slice(2).join("/"))}return u},_buildSpaceNamePath:function n(v,u){return(v.length!==0?("/"+v.join("/")):"")+"/"+u},searchByTag:function r(u){this.refreshSearch({searchTag:u,searchTerm:"",searchQuery:""})},refreshSearch:function g(x){var v=this.searchTerm;if(x.searchTerm!==undefined){v=x.searchTerm}var y=this.searchTag;if(x.searchTag!==undefined){y=x.searchTag}var A=this.searchAllSites;if(x.searchAllSites!==undefined){A=x.searchAllSites}var B=this.searchRepository;if(x.searchRepository!==undefined){B=x.searchRepository}var u=this.searchSort;if(x.searchSort!==undefined){u=x.searchSort}var z=this.options.searchQuery;if(x.searchQuery!==undefined){z=x.searchQuery}var w=Alfresco.constants.URL_PAGECONTEXT;if(this.options.siteId.length!==0){w+="site/"+this.options.siteId+"/"}w+="search?t="+encodeURIComponent(v);if(u.length!==0){w+="&s="+u}if(z.length!==0){w+="&q="+z}else{if(y.length!==0){w+="&tag="+encodeURIComponent(y)}w+="&a="+A+"&r="+B}window.location=w},onSearch:function i(y,w){var B=w[1];if(B!==null){var v=this.searchTerm;if(B.searchTerm!==undefined){v=B.searchTerm}var x=this.searchTag;if(B.searchTag!==undefined){x=B.searchTag}var z=this.searchAllSites;if(B.searchAllSites!==undefined){z=B.searchAllSites}var A=this.searchRepository;if(B.searchRepository!==undefined){A=B.searchRepository}var u=this.searchSort;if(B.searchSort!==undefined){u=B.searchSort}this._performSearch({searchTerm:v,searchTag:x,searchAllSites:z,searchRepository:A,searchSort:u})}},onSearchClick:function d(v,u){this.refreshSearch({searchTag:"",searchTerm:YAHOO.lang.trim(c.get(this.id+"-search-text").value),searchQuery:""})},onSiteSearch:function k(v,u){this.refreshSearch({searchAllSites:false,searchRepository:false})},onAllSiteSearch:function s(v,u){this.refreshSearch({searchAllSites:true,searchRepository:false})},onRepositorySearch:function h(v,u){this.refreshSearch({searchRepository:true})},_searchEnterHandler:function m(v,u){this.refreshSearch({searchTag:"",searchTerm:YAHOO.lang.trim(c.get(this.id+"-search-text").value),searchQuery:""})},_performSearch:function a(x){var v=YAHOO.lang.trim(x.searchTerm),z=YAHOO.lang.trim(x.searchTag),A=x.searchAllSites,B=x.searchRepository,u=x.searchSort;if(this.options.searchQuery.length===0&&z.length===0&&v.replace(/\*/g,"").length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.minimum-length",this.options.minSearchTermLength)});return}this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());this.widgets.dataTable.set("MSG_EMPTY","");this.widgets.dataTable.render();function w(C,D,E){this.searchTerm=v;this.searchTag=z;this.searchAllSites=A;this.searchRepository=B;this.searchSort=u;this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,C,D,E);this._updateResultsInfo();c.get(this.id+"-search-text").focus()}function y(D,E){if(E.status==401){window.location.reload()}else{try{var C=YAHOO.lang.JSON.parse(E.responseText);this.widgets.dataTable.set("MSG_ERROR",C.message);this.widgets.dataTable.showTableMessage(C.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(F){this._setDefaultDataTableErrors(this.widgets.dataTable);this.widgets.dataTable.render()}}}this.widgets.dataSource.sendRequest(this._buildSearchParams(B,A,v,z,u),{success:w,failure:y,scope:this})},_updateResultsInfo:function e(){var v;var u="<b>"+this.resultsCount+"</b>";if(this.hasMoreResults){v=this.msg("search.info.resultinfomore",u)}else{v=this.msg("search.info.resultinfo",u)}if(this.searchRepository||this.options.searchQuery.length!==0){v+=" "+this.msg("search.info.foundinrepository")}else{if(this.searchAllSites){v+=" "+this.msg("search.info.foundinallsite")}else{v+=" "+this.msg("search.info.foundinsite",p(this.options.siteTitle))}}c.get(this.id+"-search-info").innerHTML=v},_buildSearchParams:function b(z,y,v,x,u){var w=y?"":this.options.siteId;var A=YAHOO.lang.substitute("site={site}&term={term}&tag={tag}&maxResults={maxResults}&sort={sort}&query={query}&repo={repo}",{site:encodeURIComponent(w),repo:(z||this.options.searchQuery.length!==0).toString(),term:encodeURIComponent(v),tag:encodeURIComponent(x),sort:encodeURIComponent(u),query:encodeURIComponent(this.options.searchQuery),maxResults:this.options.maxSearchResults+1});return A},_setDefaultDataTableErrors:function o(u){var v=Alfresco.util.message;u.set("MSG_EMPTY",v("message.empty","Alfresco.Search"));u.set("MSG_ERROR",v("message.error","Alfresco.Search"))}})})();